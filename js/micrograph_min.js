(function(){typeof console=="undefined"&&(console={log:function(){}});var n={"extends":function(a,b){b.prototype=new a},stackCounterLimit:1E3,stackCounter:0};n.recur=function(a){n.stackCounter===n.stackCounterLimit?(n.stackCounter=0,setTimeout(a,0)):(n.stackCounter++,a())};n.clone=function(a){return JSON.parse(JSON.stringify(a))};n.shuffle=function(a){for(var b,c,d=a.length;d;b=parseInt(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a};n.include=function(a,b,c){for(var d=a.length-1;d>=0;d--){var e=
!1,e=c==null?a[d]===b:c(a[d],b)===0;if(e===!0)return!0}return!1};n.remove=function(a,b){for(var c=[],d=0;d<a.length;d++)a[d]!==b&&c.push(a[d]);return c};n.repeat=function(a,b,c,d,e){arguments.length===4&&(e={});for(var h=a;h<b;h++)e._i=h,c(function(){},e);d(e)};n.repeatAsync=function(a,b,c,d,e){arguments.length===4&&(e={});a<b?(e._i=a,c(function(c,e){n.recur(function(){n.repeatAsync(a+1,b,c,d,e)})},e)):d(e)};n.meanwhile=function(a,b,c,d){arguments.length===3&&(d={});d._stack_counter==null&&(d._stack_counter=
0);a===!0?b(function(a,b,d){d._stack_counter%40==39?(d._stack_counter+=1,setTimeout(function(){n.neanwhile(a,b,c,d)},0)):(d._stack_counter+=1,n.meanwhile(a,b,c,d))},d):c(d)};n.seq=function(){var a=arguments;return function(b){n.repeat(0,a.length,function(b,d){var e=arguments.callee;a[d._i](function(){b(e,d)})},function(){b()})}};n.partition=function(a,b){for(var c=a.length%b,d=[],e=0;e<c;e++)d.push(null);c=[];for(e=0;e<a.length;e++)d.push(a[e]),d.length%b==0&&(c.push(d),d=[]);return c};n.keys=function(a){var b=
[],c;for(c in a)b.push(c);return b};n.iso8601=function(a){return a.getTime()};n.parseStrictISO8601=function(a){var b=a.match(RegExp("([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?")),a=0,c=new Date(b[1],0,1);if(b[3])c.setMonth(b[3]-1);else throw"missing ISO8061 component";if(b[5])c.setDate(b[5]);else throw"missing ISO8061 component";if(b[7])c.setHours(b[7]);else throw"missing ISO8061 component";if(b[8])c.setMinutes(b[8]);
else throw"missing ISO8061 component";if(b[10])c.setSeconds(b[10]);else throw"missing ISO8061 component";b[12]&&c.setMilliseconds(Number("0."+b[12])*1E3);b[14]&&(a=Number(b[16])*60+Number(b[17]),a*=b[15]=="-"?1:-1);a-=c.getTimezoneOffset();b=new Date;b.setTime(Number(Number(c)+a*6E4));return b};n.parseISO8601=function(a){return new Date(parseInt(a))};n.parseISO8601Components=function(a){var a=a.match(RegExp("([0-9]{4})(-([0-9]{2}))(-([0-9]{2}))(T([0-9]{2}):([0-9]{2})(:([0-9]{2}))?(.([0-9]+))?)?(Z|([-+])([0-9]{2})(:([0-9]{2}))?)?")),
b,c,d,e,h,g,f,k;b=Number(a[1]);c=a[3]-1;d=Number(a[5]);e=Number(a[7]);h=Number(a[8]);g=Number(a[10]);a[12]&&(f=Number("0."+a[12])*1E3);a[13]==="Z"?k=0:a[14]?(k=0,a[17]&&(k=Number(a[17])),k+=Number(a[15])*60,k*=a[14]=="-"?-1:1):a[14]==null&&a[11]&&(k=Number(a[12])*60);return{year:isNaN(b)?null:b,month:isNaN(c)?null:c,date:isNaN(d)?null:d,hours:isNaN(e)?null:e,minutes:isNaN(h)?null:h,seconds:isNaN(g)?null:g,millisecs:isNaN(f)?null:f,timezone:isNaN(k)?null:k}};n.compareDateComponents=function(a,b){return a==
b};n.lexicalFormLiteral=function(a,b){var c=a.value,d=a.lang,e=a.type,h=null;if(c!=null&&e!=null&&typeof e!="string"){c=e.value;if(c==null)c=e.suffix,e=b.namespaces[e.prefix],a.type=e+c,c=e+c;h=c.indexOf("hexBinary")!=-1?'"'+a.value.toLowerCase()+'"^^<'+c+">":'"'+a.value+'"^^<'+c+">"}else h=d==null&&e==null?'"'+c+'"':e==null?'"'+c+'"@'+d:e.indexOf("hexBinary")!=-1?'"'+a.value.toLowerCase()+'"^^<'+e+">":'"'+a.value+'"^^<'+e+">";return h};n.lexicalFormBaseUri=function(a,b){var c=null;if(a.value==null)var c=
a.prefix,d=a.suffix,e=b.namespaces[c],c=e!=null?e+d:c+":"+d;else c=a.value;if(c===null)return null;else c.indexOf(":")==-1&&(c=(b.base||"")+c);return c};n.lexicalFormTerm=function(a,b){if(a.token==="uri")return{uri:n.lexicalFormBaseUri(a,b)};else if(a.token==="literal")return{literal:n.lexicalFormLiteral(a,b)};else if(a.token==="blank")return{blank:"_:"+a.value};else throw"Error, cannot get lexical form of unknown token: "+a.token;};n.normalizeUnicodeLiterals=function(a){for(var b=a.match(/\\u[0-9abcdefABCDEF]{4,4}/g)||
[],c={},d=0;d<b.length;d++)c[b[d]]==null&&(c[b[d]]=!0,a=a.replace(RegExp("\\"+b[d],"g"),eval("'"+b[d]+"'")));return a};n.hashTerm=function(a){try{if(a==null)return"";if(a.token==="uri")return"u"+a.value;else if(a.token==="blank")return"b"+a.value;else if(a.token==="literal"){var b="l"+a.value;b+=a.type||"";b+=a.lang||"";return b}}catch(c){if(typeof a==="object"){b="";for(p in a)b=b+p+a[p];return b}return a}};var L={PriorityQueue:function(a){var b=[],c={},d=!1,e,h=a.maxSize||10;e=function(a,b){return c[b].priority-
c[a].priority};var g=function(){b.sort(e);d=!0};return{debugContents:b,debugStore:c,debugSort:g,push:function(a,e){if(b.length===h){d||g();if(c[a]==null){delete c[b[0]];b[0]=a;var f=c[b[b.length-1]].priority-1;c[a]={object:e,priority:f}}else f=c[b[b.length-1]].priority-1,c[a].priority=f;d=!1}else b.length===0?(b.push(a),c[a]={object:e,priority:1E3}):(f=c[b[b.length-1]].priority-1,c[a]==null?(c[a]={object:e,priority:f},b.push(a)):(c[a].priority=f,d=!1))},remove:function(a){if(c[a]!=null){delete c[a];
for(var d=null,e=0;e<b.length;e++)if(b[e]===a){d=e;break}d!=null&&b.splice(d,1)}},fetch:function(a){var e=c[a];return c[a]!=null?(d||g(),c[a].priority=c[b[b.length-1]].priority-1,d=!1,e.object):null}}}},w={},G=-1,H=1;w.Tree=function(a,b,c,d){if(arguments.length!=0){var e=null;if(c===!0)try{if(e=window.localStorage,e==null)throw"not found";}catch(h){throw"Local storage is not present, cannot create persistent storage";}e==null&&(e=function(){var a={};return{setItem:function(b,c){a[b]=c},getItem:function(b){return a[b]||
null},removeItem:function(b){delete a[b]},get:function(b){var c=0,d;for(d in a){if(b===c)return d;c++}return""},length:a.length}}());this.storage=e;this.order=a;this.name=b;this.diskManager=new w.LocalStorageManager(b,e,d);this.root=this.diskManager._readRootNode();this.root==null?(this.root=this._allocateNode(),this.root.isLeaf=!0,this.root.level=0,this._diskWrite(this.root),this._updateRootNode(this.root),this.root=this.root.pointer):this.root=this.diskManager._diskRead(this.root).pointer;this.comparator=
function(a,b){return a<b?-1:a>b?1:0};this.merger=null}};w.Tree.prototype._allocateNode=function(){return new w.Node};w.Tree.prototype._diskWrite=function(a){this.diskManager._diskWrite(a)};w.Tree.prototype._diskRead=function(a){return this.diskManager._diskRead(a)};w.Tree.prototype._diskDelete=function(a){this.diskManager._diskDelete(a)};w.Tree.prototype._updateRootNode=function(a){this.diskManager._updateRootNode(a);return a};w.Tree.prototype.search=function(a,b){for(var c=!0,d=this._diskRead(this.root);c;){for(var e=
0;e<d.numberActives&&this.comparator(a,d.keys[e].key)===1;)e++;if(e<d.numberActives&&this.comparator(d.keys[e].key,a)===0)return b!=null&&b==!0?!0:d.keys[e].data;else d.isLeaf===!0?c=!1:d=this._diskRead(d.children[e])}return null};w.Tree.prototype.walk=function(a){this._walk(a,this._diskRead(this.root))};w.Tree.prototype._walk=function(a,b){if(b.isLeaf)for(var c=0;c<b.numberActives;c++)a(b.keys[c]);else{for(c=0;c<b.numberActives;c++)this._walk(a,this._diskRead(b.children[c])),a(b.keys[c]);this._walk(a,
this._diskRead(b.children[b.numberActives]))}};w.Tree.prototype.walkNodes=function(a){this._walkNodes(a,this._diskRead(this.root))};w.Tree.prototype._walkNodes=function(a,b){if(b.isLeaf)a(b);else{a(b);for(var c=0;c<b.numberActives;c++)this._walkNodes(a,this._diskRead(b.children[c]));this._walkNodes(a,this._diskRead(b.children[b.numberActives]))}};w.Tree.prototype._splitChild=function(a,b,c){var d=this._allocateNode();d.isLeaf=c.isLeaf;d.level=c.level;d.numberActives=this.order-1;var e=c.keys[this.order-
1];c.keys[this.order-1]=null;for(var h=0;h<this.order-1;h++)d.keys[h]=c.keys[h+this.order],c.keys[h+this.order]=null,c.isLeaf||(d.children[h]=c.children[h+this.order],c.children[h+this.order]=null);c.isLeaf||(d.children[h]=c.children[h+this.order],c.children[h+this.order]=null);c.numberActives=this.order-1;for(h=a.numberActives+1;h>b+1;h--)a.children[h]=a.children[h-1];this._diskWrite(d);a.children[b+1]=d.pointer;for(h=a.numberActives;h>b;h--)a.keys[h]=a.keys[h-1];a.keys[b]=e;a.numberActives++;this._diskWrite(a);
this._diskWrite(c)};w.Tree.prototype.insert=function(a,b){var c=this._diskRead(this.root);if(c.numberActives===2*this.order-1){var d=this._allocateNode();d.isLeaf=!1;d.level=c.level+1;d.numberActives=0;d.children[0]=c.pointer;this._diskWrite(d);this._splitChild(d,0,c);this.root=d.pointer;this._updateRootNode(d);this._insertNonFull(d,a,b)}else this._insertNonFull(c,a,b)};w.Tree.prototype._insertNonFull=function(a,b,c){for(var d=a.numberActives-1;!a.isLeaf;){for(;d>=0&&this.comparator(b,a.keys[d].key)===
-1;)d--;d++;var e=this._diskRead(a.children[d]);e.numberActives===2*this.order-1&&(this._splitChild(a,d,e),this.comparator(b,a.keys[d].key)===1&&d++);a=this._diskRead(a.children[d]);d=a.numberActives-1}for(;d>=0&&this.comparator(b,a.keys[d].key)===-1;)a.keys[d+1]=a.keys[d],d--;a.keys[d+1]={key:b,data:c};a.numberActives++;this._diskWrite(a)};w.Tree.prototype["delete"]=function(a){for(var b=this._diskRead(this.root),c=null,d=!0,e=null,h=null,g=null,f=!0;f===!0;){for(f=!1;d===!0;){i=0;if(b.numberActives===
0)return!1;for(;i<b.numberActives&&this.comparator(a,b.keys[i].key)===1;)i++;e=i;i<b.numberActives&&this.comparator(a,b.keys[i].key)===0&&(d=!1);if(d===!0){if(b.isLeaf===!0)return!1;c=b;b=this._diskRead(b.children[i]);if(b===null)return!1;e===c.numberActives?(h=this._diskRead(c.children[e-1]),g=null):e===0?(h=null,g=this._diskRead(c.children[1])):(h=this._diskRead(c.children[e-1]),g=this._diskRead(c.children[e+1]));b.numberActives===this.order-1&&c!=null&&(g!=null&&g.numberActives>this.order-1?(this._moveKey(c,
i,G),b=this._diskRead(b.pointer)):h!=null&&h.numberActives>this.order-1?(this._moveKey(c,i,H),b=this._diskRead(b.pointer)):h!=null&&h.numberActives===this.order-1?b=this._mergeSiblings(c,i,G):g!=null&&g.numberActives===this.order-1&&(b=this._mergeSiblings(c,i,H)))}}if(b.isLeaf&&b.numberActives>this.order-1)return this._deleteKeyFromNode(b,e),!0;if(b.isLeaf&&b.pointer===this.root)return this._deleteKeyFromNode(b,e),!0;try{if(b.isLeaf===!1)if(h=c=null,(c=this._diskRead(b.children[e])).numberActives>
this.order-1){var k=this._getMaxKeyPos(c),a=k.node.keys[k.index];b.keys[e]=a;this._diskWrite(b);b=c;a=a.key;d=f=!0}else if((c=this._diskRead(b.children[e+1])).numberActives>this.order-1)k=this._getMinKeyPos(c),a=k.node.keys[k.index],b.keys[e]=a,this._diskWrite(b),b=c,a=a.key,d=f=!0;else if((c=this._diskRead(b.children[e])).numberActives===this.order-1&&(h=this._diskRead(b.children[e+1])).numberActives===this.order-1){var m=this._mergeNodes(c,b.keys[e],h);b.children[e]=m.pointer;e++;for(var i=e;i<
b.numberActives;i++)b.children[i]=b.children[i+1],b.keys[i-1]=b.keys[i];b.children[i]=null;b.keys[i-1]=null;b.numberActives--;if(b.numberActives===0&&this.root===b.pointer)this.root=m.pointer,this._updateRootNode(m);this._diskWrite(b);b=m;d=f=!0}}catch(C){console.log("!!!"),console.log(C)}b.isLeaf&&b.numberActives>this.order-1&&d===!1&&this._deleteKeyFromNode(b,e);if(f===!1)return!0}};w.Tree.prototype._moveKey=function(a,b,c){c===H&&b--;var d=this._diskRead(a.children[b]),e=this._diskRead(a.children[b+
1]);if(c==G){d.keys[d.numberActives]=a.keys[b];d.children[d.numberActives+1]=e.children[0];e.children[0]=null;d.numberActives++;a.keys[b]=e.keys[0];for(c=1;c<e.numberActives;c++)e.keys[c-1]=e.keys[c],e.children[c-1]=e.children[c];e.children[e.numberActives-1]=e.children[e.numberActives];e.numberActives--}else{e.children[e.numberActives+1]=e.children[e.numberActives];for(c=e.numberActives;c>0;c--)e.children[c]=e.children[c-1],e.keys[c]=e.keys[c-1];e.keys[0]=null;e.children[0]=null;e.children[0]=d.children[d.numberActives];
e.keys[0]=a.keys[b];e.numberActives++;d.children[d.numberActives]=null;a.keys[b]=d.keys[d.numberActives-1];d.keys[d.numberActives-1]=null;d.numberActives--}this._diskWrite(d);this._diskWrite(e);this._diskWrite(a)};w.Tree.prototype._mergeSiblings=function(a,b){var c,d,e;b===a.numberActives?(b--,d=this._diskRead(a.children[a.numberActives-1]),e=this._diskRead(a.children[a.numberActives])):(d=this._diskRead(a.children[b]),e=this._diskRead(a.children[b+1]));var h=this._allocateNode();h.isLeaf=d.isLeaf;
h.level=d.level;for(c=0;c<this.order-1;c++)h.keys[c]=d.keys[c],h.children[c]=d.children[c];h.keys[this.order-1]=a.keys[b];h.children[this.order-1]=d.children[this.order-1];for(c=0;c<this.order-1;c++)h.keys[c+this.order]=e.keys[c],h.children[c+this.order]=e.children[c];h.children[2*this.order-1]=e.children[this.order-1];this._diskWrite(h);a.children[b]=h.pointer;for(c=b;c<a.numberActives;c++)a.keys[c]=a.keys[c+1],a.children[c+1]=a.children[c+2];h.numberActives=d.numberActives+e.numberActives+1;a.numberActives--;
for(c=a.numberActives;c<2*this.order-1;c++)a.keys[c]=null;if(a.numberActives===0&&this.root===a.pointer)this.root=h.pointer,h.isLeaf=h.level?!1:!0;this._diskWrite(h);this.root===h.pointer&&this._updateRootNode(h);this._diskWrite(a);this._diskDelete(d);this._diskDelete(e);return h};w.Tree.prototype._deleteKeyFromNode=function(a,b){var c=2*this.order-1;if(a.numberActives<c)c=a.numberActives;var d;if(a.isLeaf===!1)return!1;for(d=b;d<c-1;d++)a.keys[d]=a.keys[d+1];a.keys.splice(c-1,a.keys.length-(c-1));
a.numberActives--;this._diskWrite(a);return!0};w.Tree.prototype._mergeNodes=function(a,b,c){var d,e;d=this._allocateNode();d.isLeaf=!0;for(e=0;e<a.numberActives;e++)d.keys[e]=a.keys[e],d.children[e]=a.children[e];d.children[a.numberActives]=a.children[a.numberActives];d.keys[a.numberActives]=b;for(e=0;e<c.numberActives;e++)d.keys[e+a.numberActives+1]=c.keys[e],d.children[e+a.numberActives+1]=c.children[e];d.children[2*this.order-1]=c.children[c.numberActives];d.numberActives=a.numberActives+c.numberActives+
1;d.isLeaf=a.isLeaf;d.level=a.level;this._diskWrite(d);this._diskDelete(a);this._diskDelete(c);return d};w.Tree.prototype.audit=function(a){var b=[],c=[],d=this,e=function(e){for(var h=0;h<c.length;h++)if(d.comparator(c[h],e)===0){var f=" !!! duplicated key "+e;a===!0&&console.log(f);b.push(f)}},h=null,d=this;this.walkNodes(function(g){a===!0&&(console.log("--- Node at "+g.level+" level"),console.log(" - pointer: "+g.pointer),console.log(" - leaf? "+g.isLeaf),console.log(" - num actives? "+g.numberActives),
console.log(" - keys: "));for(var f=g.numberActives;f<g.keys.length;f++)g.keys[f]!=null&&a===!0&&(console.log(" * warning : redundant key data"),b.push(" * warning : redundant key data"));for(f=g.numberActives+1;f<g.children.length;f++)g.children[f]!=null&&a===!0&&(console.log(" * warning : redundant children data"),b.push(" * warning : redundant key data"));if(g.isLeaf===!1)for(f=0;f<g.numberActives;f++){var k=d._diskRead(g.children[f]).keys[d._diskRead(g.children[f]).numberActives-1].key,m=d._diskRead(g.children[f+
1]).keys[0].key;a===!0&&console.log("   "+g.keys[f].key+"("+k+","+m+")");if(d.comparator(g.keys[f].key,k)===-1){var i=" !!! value max left "+k+" > key "+g.keys[f].key;a===!0&&console.log(i);b.push(i)}d.comparator(g.keys[f].key,m)===1&&(i=" !!! value min right "+m+" < key "+g.keys[f].key,a===!0&&console.log(i),b.push(i));e(g.keys[f].key);c.push(g.keys[f].key)}else{h===null?h=g.level:h!=g.level&&(i=" !!! Leaf node with wrong level value",a===!0&&console.log(i),b.push(i));for(f=0;f<g.numberActives;f++)a===
!0&&console.log(" "+g.keys[f].key),e(g.keys[f].key),c.push(g.keys[f].key)}g.pointer!=d.root&&(g.numberActives>2*d.order-1&&(a===!0&&(i=" !!!! MAX num keys restriction violated "),console.log(i),b.push(i)),g.numberActives<d.order-1&&(a===!0&&(i=" !!!! MIN num keys restriction violated "),console.log(i),b.push(i)))});return b};w.Tree.prototype.clear=function(){this.diskManager.clear();this.root=this._allocateNode();this.root.isLeaf=!0;this.root.level=0;this._diskWrite(this.root);this._updateRootNode(this.root);
this.root=this.root.pointer};w.Tree.prototype._getMaxKeyPos=function(a){for(var b={};;){if(a===null)break;if(a.isLeaf===!0){b.node=a;b.index=a.numberActives-1;break}else b.node=a,b.index=a.numberActives-1,a=this._diskRead(a.children[a.numberActives])}return b};w.Tree.prototype._getMinKeyPos=function(a){for(var b={};;){if(a===null)break;if(a.isLeaf===!0){b.node=a;b.index=0;break}else b.node=a,b.index=0,a=this._diskRead(a.children[0])}return b};w.Node=function(){this.numberActives=0;this.isLeaf=null;
this.keys=[];this.children=[];this.level=0};w.LocalStorageManager=function(a,b,c){this.name=a;this.storage=b;this.maxSize=c;this.bufferCache=new L.PriorityQueue({maxSize:c});this.counter=this.storage.getItem("__"+this.name+"__ID_COUNTER__")||0};w.LocalStorageManager.prototype.clear=function(){for(var a=this.storage.length,b=[],c=0;c<a;c++){var d=this.storage.key(c);(d.indexOf(this.name)==0||d.indexOf("__"+this.name)==0)&&b.push(d)}for(c=0;c<b.length;c++)this.storage.removeItem(b[c]);this.bufferCache=
new L.PriorityQueue({maxSize:this.maxSize})};w.LocalStorageManager.prototype._genIndex=function(){var a=this.name+this.counter;this.counter++;this.storage.setItem("__"+this.name+"__ID_COUNTER__",this.counter);return a};w.LocalStorageManager.prototype._diskRead=function(a){if(typeof a==="object")a=a.pointer;var b=this.bufferCache.fetch(a);if(b==null&&(b=this.storage.getItem(a),b!=null))b=this._decode(b),b.pointer=a,this.bufferCache.push(a,b);return b};w.LocalStorageManager.prototype._diskWrite=function(a){if(a.pointer==
null)a.pointer=this._genIndex();var b=a.children,c=[];if(a.isLeaf===!1)for(var d=0;d<b.length;d++)b[d]==null?c.push(null):typeof b[d]==="object"?c.push(b[d].pointer):c.push(b[d]);a.children=c;this.storage.setItem(a.pointer,this._encode(a));a.children=b;this.bufferCache.push(a.pointer,a)};w.LocalStorageManager.prototype._diskDelete=function(a){this.storage.removeItem(a.pointer);this.bufferCache.remove(a.pointer)};w.LocalStorageManager.prototype._updateRootNode=function(a){if(a.pointer)this.storage.setItem("__"+
this.name+"__ROOT_NODE__",a.pointer);else throw"Cannot set as root of the b-tree a node without pointer";};w.LocalStorageManager.prototype._readRootNode=function(){var a=this.storage.getItem("__"+this.name+"__ROOT_NODE__");return a==null?null:this._diskRead(a)};w.LocalStorageManager.prototype._encode=function(a){for(var b=""+a.numberActives,b=b+":"+a.pointer,b=b+":"+a.level,b=b+":"+(a.isLeaf?1:0),c=0,d="",e=0;e<a.keys.length;e++)a.keys[e]!=null&&(d=typeof a.keys[e].key==="number"?d+":"+a.keys[e].key:
d+":"+("_"+(a.keys[e].key.subject||"")+"_"+(a.keys[e].key.predicate||"")+"_"+(a.keys[e].key.object||"")+"_"+(a.keys[e].key.graph||"")),a.keys[e].data==null?d+=":n:":d=typeof a.keys[e].data=="string"?d+":s:"+a.keys[e].data:typeof a.keys[e].data=="number"?a.keys[e]%1==0?d+":i:"+a.keys[e].data:d+":f:"+a.keys[e].data:d+":o:"+JSON.stringify(a.keys[e].data).replace(":","&colon;"),c++);b=b+":"+c+d;if(a.isLeaf===!1){c="";for(e=d=0;e<a.children.length;e++)a.children[e]!=null&&(c=c+":"+a.children[e],d++);b=
b+":"+d+c}return b};w.LocalStorageManager.prototype._decode=function(a){var b=new w.Node,a=a.split(":");b.numberActives=parseInt(a[0]);b.pointer=a[1];b.level=parseInt(a[2]);b.isLeaf=a[3]==="1"?!0:!1;for(var c=parseInt(a[4]),d=5,e,h,g,f=0;f<c;f++)e=a[d],e[0]=="_"?(e=e.split("_"),e={subject:parseInt(e[1])||null,predicate:parseInt(e[2])||null,object:parseInt(e[3])||null,graph:parseInt(e[4]||null)}):e=parseInt(a[d]),h=a[d+1],g=a[d+2],h==="n"?g=void 0:h==="i"?g=parseInt(g):h==="f"?g=parseFloat(g):h===
"o"&&(g=JSON.parse(g.replace("&colon;",":"))),b.keys.push({key:e,data:g}),d+=3;if(b.isLeaf===!1){c=parseInt(a[d]);d++;for(f=0;f<c;f++)b.children[f]=a[d],d++}return b};var x={},G=-1,H=1;x.Tree=function(a){if(arguments.length!=0)this.order=a,this.root=this._allocateNode(),this.root.isLeaf=!0,this.root.level=0,this._diskWrite(this.root),this._updateRootNode(this.root),this.comparator=function(a,c){return a<c?-1:a>c?1:0},this.merger=null};x.Tree.prototype._allocateNode=function(){return new x.Node};x.Tree.prototype._diskWrite=
function(){};x.Tree.prototype._diskRead=function(a){return a};x.Tree.prototype._diskDelete=function(){};x.Tree.prototype._updateRootNode=function(a){return a};x.Tree.prototype.clear=function(){this.root=this._allocateNode();this.root.isLeaf=!0;this.root.level=0;this._updateRootNode(this.root)};x.Tree.prototype.search=function(a,b){for(var c=!0,d=this.root;c;){for(var e=0;e<d.numberActives&&this.comparator(a,d.keys[e].key)===1;)e++;if(e<d.numberActives&&this.comparator(d.keys[e].key,a)===0)return b!=
null&&b==!0?!0:d.keys[e].data;else d.isLeaf===!0?c=!1:d=this._diskRead(d.children[e])}return null};x.Tree.prototype.walk=function(a){this._walk(a,this.root)};x.Tree.prototype._walk=function(a,b){if(b.isLeaf)for(var c=0;c<b.numberActives;c++)a(b.keys[c]);else{for(c=0;c<b.numberActives;c++)this._walk(a,this._diskRead(b.children[c])),a(b.keys[c]);this._walk(a,this._diskRead(b.children[b.numberActives]))}};x.Tree.prototype.walkNodes=function(a){this._walkNodes(a,this.root)};x.Tree.prototype._walkNodes=
function(a,b){if(b.isLeaf)a(b);else{a(b);for(var c=0;c<b.numberActives;c++)this._walkNodes(a,this._diskRead(b.children[c]));this._walkNodes(a,this._diskRead(b.children[b.numberActives]))}};x.Tree.prototype._splitChild=function(a,b,c){var d=this._allocateNode();d.isLeaf=c.isLeaf;d.level=c.level;d.numberActives=this.order-1;var e=c.keys[this.order-1];c.keys[this.order-1]=null;for(var h=0;h<this.order-1;h++)d.keys[h]=c.keys[h+this.order],c.keys[h+this.order]=null,c.isLeaf||(d.children[h]=c.children[h+
this.order],c.children[h+this.order]=null);c.isLeaf||(d.children[h]=c.children[h+this.order],c.children[h+this.order]=null);c.numberActives=this.order-1;for(h=a.numberActives+1;h>b+1;h--)a.children[h]=a.children[h-1];a.children[b+1]=d;for(h=a.numberActives;h>b;h--)a.keys[h]=a.keys[h-1];a.keys[b]=e;a.numberActives++;this._diskWrite(d);this._diskWrite(a);this._diskWrite(c)};x.Tree.prototype.insert=function(a,b){if(this.root.numberActives===2*this.order-1){var c=this._allocateNode();c.isLeaf=!1;c.level=
this.root.level+1;c.numberActives=0;c.children[0]=this.root;this._splitChild(c,0,this.root);this.root=c;this._updateRootNode(this.root);this._insertNonFull(c,a,b)}else this._insertNonFull(this.root,a,b)};x.Tree.prototype._insertNonFull=function(a,b,c){for(var d=a.numberActives-1;!a.isLeaf;){for(;d>=0&&this.comparator(b,a.keys[d].key)===-1;)d--;d++;var e=this._diskRead(a.children[d]);e.numberActives===2*this.order-1&&(this._splitChild(a,d,e),this.comparator(b,a.keys[d].key)===1&&d++);a=this._diskRead(a.children[d]);
d=a.numberActives-1}for(;d>=0&&this.comparator(b,a.keys[d].key)===-1;)a.keys[d+1]=a.keys[d],d--;a.keys[d+1]={key:b,data:c};a.numberActives++;this._diskWrite(a)};x.Tree.prototype["delete"]=function(a){for(var b=this.root,c=null,d=!0,e=null,h=null,g=null,f=!0;f===!0;){for(f=!1;d===!0;){k=0;if(b.numberActives===0)return!1;for(;k<b.numberActives&&this.comparator(a,b.keys[k].key)===1;)k++;e=k;k<b.numberActives&&this.comparator(a,b.keys[k].key)===0&&(d=!1);if(d===!0){if(b.isLeaf===!0)return!1;c=b;b=this._diskRead(b.children[k]);
if(b===null)return!1;e===c.numberActives?(h=this._diskRead(c.children[e-1]),g=null):e===0?(h=null,g=this._diskRead(c.children[1])):(h=this._diskRead(c.children[e-1]),g=this._diskRead(c.children[e+1]));b.numberActives===this.order-1&&c!=null&&(g!=null&&g.numberActives>this.order-1?this._moveKey(c,k,G):h!=null&&h.numberActives>this.order-1?this._moveKey(c,k,H):h!=null&&h.numberActives===this.order-1?b=this._mergeSiblings(c,k,G):g!=null&&g.numberActives===this.order-1&&(b=this._mergeSiblings(c,k,H)))}}if(b.isLeaf&&
b.numberActives>this.order-1)return this._deleteKeyFromNode(b,e),!0;if(b.isLeaf&&b===this.root)return this._deleteKeyFromNode(b,e),!0;if(b.isLeaf===!1)if(c=k=null,(k=this._diskRead(b.children[e])).numberActives>this.order-1)a=this._getMaxKeyPos(k),a=a.node.keys[a.index],b.keys[e]=a,this._diskWrite(b),b=k,a=a.key,d=f=!0;else if((k=this._diskRead(b.children[e+1])).numberActives>this.order-1)a=this._getMinKeyPos(k),a=a.node.keys[a.index],b.keys[e]=a,this._diskWrite(b),b=k,a=a.key,d=f=!0;else if((k=this._diskRead(b.children[e])).numberActives===
this.order-1&&(c=this._diskRead(b.children[e+1])).numberActives===this.order-1){d=this._mergeNodes(k,b.keys[e],c);b.children[e]=d;e++;for(var k=e;k<b.numberActives;k++)b.children[k]=b.children[k+1],b.keys[k-1]=b.keys[k];b.children[k]=null;b.keys[k-1]=null;b.numberActives--;if(b.numberActives===0&&this.root===b)this.root=d;this._diskWrite(b);b=d;d=f=!0}b.isLeaf&&b.numberActives>this.order-1&&d===!1&&this._deleteKeyFromNode(b,e);if(f===!1)return!0}};x.Tree.prototype._moveKey=function(a,b,c){c===H&&
b--;var d=this._diskRead(a.children[b]),e=this._diskRead(a.children[b+1]);if(c==G){d.keys[d.numberActives]=a.keys[b];d.children[d.numberActives+1]=e.children[0];e.children[0]=null;d.numberActives++;a.keys[b]=e.keys[0];for(c=1;c<e.numberActives;c++)e.keys[c-1]=e.keys[c],e.children[c-1]=e.children[c];e.children[e.numberActives-1]=e.children[e.numberActives];e.numberActives--}else{e.children[e.numberActives+1]=e.children[e.numberActives];for(c=e.numberActives;c>0;c--)e.children[c]=e.children[c-1],e.keys[c]=
e.keys[c-1];e.keys[0]=null;e.children[0]=null;e.children[0]=d.children[d.numberActives];e.keys[0]=a.keys[b];e.numberActives++;d.children[d.numberActives]=null;a.keys[b]=d.keys[d.numberActives-1];d.keys[d.numberActives-1]=null;d.numberActives--}this._diskWrite(d);this._diskWrite(e);this._diskWrite(a)};x.Tree.prototype._mergeSiblings=function(a,b){var c,d,e;b===a.numberActives?(b--,d=this._diskRead(a.children[a.numberActives-1]),e=this._diskRead(a.children[a.numberActives])):(d=this._diskRead(a.children[b]),
e=this._diskRead(a.children[b+1]));var h=this._allocateNode();h.isLeaf=d.isLeaf;h.level=d.level;for(c=0;c<this.order-1;c++)h.keys[c]=d.keys[c],h.children[c]=d.children[c];h.keys[this.order-1]=a.keys[b];h.children[this.order-1]=d.children[this.order-1];for(c=0;c<this.order-1;c++)h.keys[c+this.order]=e.keys[c],h.children[c+this.order]=e.children[c];h.children[2*this.order-1]=e.children[this.order-1];a.children[b]=h;for(c=b;c<a.numberActives;c++)a.keys[c]=a.keys[c+1],a.children[c+1]=a.children[c+2];
h.numberActives=d.numberActives+e.numberActives+1;a.numberActives--;for(c=a.numberActives;c<2*this.order-1;c++)a.keys[c]=null;if(a.numberActives===0&&this.root===a)this.root=h,h.isLeaf=h.level?!1:!0;this._diskWrite(h);this.root===h&&this._updateRootNode(this.root);this._diskWrite(a);this._diskDelete(d);this._diskDelete(e);return h};x.Tree.prototype._deleteKeyFromNode=function(a,b){var c=2*this.order-1;if(a.numberActives<c)c=a.numberActives;var d;if(a.isLeaf===!1)return!1;for(d=b;d<c-1;d++)a.keys[d]=
a.keys[d+1];a.keys.pop();a.numberActives--;this._diskWrite(a);return!0};x.Tree.prototype._mergeNodes=function(a,b,c){var d,e;d=this._allocateNode();d.isLeaf=!0;for(e=0;e<a.numberActives;e++)d.keys[e]=a.keys[e],d.children[e]=a.children[e];d.children[a.numberActives]=a.children[a.numberActives];d.keys[a.numberActives]=b;for(e=0;e<c.numberActives;e++)d.keys[e+a.numberActives+1]=c.keys[e],d.children[e+a.numberActives+1]=c.children[e];d.children[2*this.order-1]=c.children[c.numberActives];d.numberActives=
a.numberActives+c.numberActives+1;d.isLeaf=a.isLeaf;d.level=a.level;this._diskWrite(d);return d};x.Tree.prototype.audit=function(a){var b=[],c=[],d=this,e=function(e){for(var h=0;h<c.length;h++)if(d.comparator(c[h],e)===0){var f=" !!! duplicated key "+e;a===!0&&console.log(f);b.push(f)}},h=null,d=this;this.walkNodes(function(g){a===!0&&(console.log("--- Node at "+g.level+" level"),console.log(" - leaf? "+g.isLeaf),console.log(" - num actives? "+g.numberActives),console.log(" - keys: "));for(var f=
g.numberActives;f<g.keys.length;f++)g.keys[f]!=null&&a===!0&&(console.log(" * warning : redundant key data"),b.push(" * warning : redundant key data"));for(f=g.numberActives+1;f<g.children.length;f++)g.children[f]!=null&&a===!0&&(console.log(" * warning : redundant children data"),b.push(" * warning : redundant key data"));if(g.isLeaf===!1)for(f=0;f<g.numberActives;f++){var k=d._diskRead(g.children[f]).keys[d._diskRead(g.children[f]).numberActives-1].key,m=d._diskRead(g.children[f+1]).keys[0].key;
a===!0&&console.log("   "+g.keys[f].key+"("+k+","+m+")");if(d.comparator(g.keys[f].key,k)===-1){var i=" !!! value max left "+k+" > key "+g.keys[f].key;a===!0&&console.log(i);b.push(i)}d.comparator(g.keys[f].key,m)===1&&(i=" !!! value min right "+m+" < key "+g.keys[f].key,a===!0&&console.log(i),b.push(i));e(g.keys[f].key);c.push(g.keys[f].key)}else{h===null?h=g.level:h!=g.level&&(i=" !!! Leaf node with wrong level value",a===!0&&console.log(i),b.push(i));for(f=0;f<g.numberActives;f++)a===!0&&console.log(" "+
g.keys[f].key),e(g.keys[f].key),c.push(g.keys[f].key)}g!=d.root&&(g.numberActives>2*d.order-1&&(a===!0&&(i=" !!!! MAX num keys restriction violated "),console.log(i),b.push(i)),g.numberActives<d.order-1&&(a===!0&&(i=" !!!! MIN num keys restriction violated "),console.log(i),b.push(i)))});return b};x.Tree.prototype._getMaxKeyPos=function(a){for(var b={};;){if(a===null)break;if(a.isLeaf===!0){b.node=a;b.index=a.numberActives-1;break}else b.node=a,b.index=a.numberActives-1,a=this._diskRead(a.children[a.numberActives])}return b};
x.Tree.prototype._getMinKeyPos=function(a){for(var b={};;){if(a===null)break;if(a.isLeaf===!0){b.node=a;b.index=0;break}else b.node=a,b.index=0,a=this._diskRead(a.children[0])}return b};x.Node=function(){this.numberActives=0;this.isLeaf=null;this.keys=[];this.children=[];this.level=0};var F={NodeKey:function(a,b){this.subject=a.subject;this.predicate=a.predicate;this.object=a.object;this.graph=a.graph;this.order=b}};F.NodeKey.prototype.comparator=function(a){for(var b=0;b<this.order.length;b++){var c=
this.order[b];if(a[c]==null)break;else if(this[c]<a[c])return-1;else if(this[c]>a[c])return 1}return 0};F.Pattern=function(a){this.subject=a.subject;this.predicate=a.predicate;this.object=a.object;this.graph=a.graph;this.indexKey=[];this.keyComponents={};for(var b=[],c=[],a=["subject","predicate","object","graph"],d=0;d<a.length;d++)typeof this[a[d]]==="string"?(c.push(a[d]),this.keyComponents[a[d]]=null):(b.push(a[d]),this.keyComponents[a[d]]=this[a[d]],this.indexKey.push(a[d]));this.order=b.concat(c);
this.key=new F.NodeKey(this.keyComponents,this.order)};var E={};E.Tree=function(a,b){if(arguments!=0)this.componentOrder=a.componentOrder,E.BaseTree.Tree.call(this,a.order,a.name,a.persistent,a.cacheMaxSize),this.comparator=function(a,b){for(var e=0;e<this.componentOrder.length;e++){var h=this.componentOrder[e],g=a[h],h=b[h];if(g<h)return-1;else if(g>h)return 1}return 0},this.rangeComparator=function(a,b){for(var e=0;e<this.componentOrder.length;e++){var h=this.componentOrder[e];if(b[h]==null||a[h]==
null)break;else if(a[h]<b[h])return-1;else if(a[h]>b[h])return 1}return 0},b!=null&&b(this)};E.compose=function(a){n["extends"](a.Tree,E.Tree);E.BaseTree=a;E.Tree.prototype.insert=function(b,c){a.Tree.prototype.insert.call(this,b,null);c&&c(!0);return!0};E.Tree.prototype.search=function(b,c){var d=a.Tree.prototype.search.call(this,b,!0);c&&c(d);return d};E.Tree.prototype.range=function(a,c){var d=null,d=typeof this.root==="string"?this._rangeTraverse(this,this._diskRead(this.root),a):this._rangeTraverse(this,
this.root,a);c&&c(d);return d};E.Tree.prototype._rangeTraverse=function(a,c,d){for(var d=d.key,e=[],h=[c],g;h.length>0;){c=h.shift();for(g=0;g<c.numberActives&&a.rangeComparator(c.keys[g].key,d)===-1;)g++;if(c.isLeaf===!0)for(;g<c.numberActives&&a.rangeComparator(c.keys[g].key,d)===0;)e.push(c.keys[g].key),g++;else{var f=a._diskRead(c.children[g]);for(h.push(f);;)if(g<c.numberActives&&a.rangeComparator(c.keys[g].key,d)===0)e.push(c.keys[g].key),g++,f=a._diskRead(c.children[g]),h.push(f);else break}}return e}};
var I={QuadBackend:function(a,b,c){if(arguments!=0){this.indexMap={};this.treeOrder=a.treeOrder;this.indices=["SPOG","GP","OGS","POG","GSP","OS"];this.componentOrders={SPOG:["subject","predicate","object","graph"],GP:["graph","predicate","subject","object"],OGS:["object","graph","subject","predicate"],POG:["predicate","object","graph","subject"],GSP:["graph","subject","predicate","object"],OS:["object","subject","predicate","graph"]};E.compose(b);for(var d=0;d<this.indices.length;d++){var e=this.indices[d];
this.indexMap[e]=new E.Tree({order:this.treeOrder,componentOrder:this.componentOrders[e],persistent:a.persistent,name:(a.name||"")+e,cacheMaxSize:a.cacheMaxSize})}c&&c(this)}}};I.QuadBackend.prototype.clear=function(){for(var a=0;a<this.indices.length;a++)this.indexMap[this.indices[a]].clear()};I.QuadBackend.prototype._indexForPattern=function(a){for(var a=a.indexKey,b=this.indices,c=0;c<b.length;c++)for(var d=b[c],e=this.componentOrders[d],h=0;h<e.length;h++){if(n.include(a,e[h])===!1)break;if(h==
a.length-1)return d}return"SPOG"};I.QuadBackend.prototype.index=function(a,b){for(var c=0;c<this.indices.length;c++)this.indexMap[this.indices[c]].insert(a);b&&b(!0);return!0};I.QuadBackend.prototype.range=function(a,b){var c=this.indexMap[this._indexForPattern(a)].range(a);b&&b(c);return c};I.QuadBackend.prototype.search=function(a,b){var c=this.indexMap[this.indices[0]].search(a);b&&b(c!=null);return c!=null};I.QuadBackend.prototype["delete"]=function(a,b){for(var c,d=0;d<this.indices.length;d++)c=
this.indices[d],c=this.indexMap[c],c["delete"](a);b&&b(!0);return!0};var A={Lexicon:function(a,b){this.name=b||"";this.storage=null;try{this.storage=window.localStorage}catch(c){}if(this.storage==null)this.storage={setItem:function(){},getItem:function(){return null},removeItem:function(){},key:function(){return""},length:0};this.uriToOID={};this.OIDToUri={};this.literalToOID={};this.OIDToLiteral={};this.blankToOID={};this.OIDToBlank={};this.defaultGraphOid=0;this.defaultGraphUri="https://github.com/antoniogarrote/rdfstore-js#default_graph";
this.defaultGraphUriTerm={token:"uri",prefix:null,suffix:null,value:this.defaultGraphUri,oid:this.defaultGraphOid};this.oidCounter=parseInt(this.storage.getItem(this.pointer("oidCounter")))||1;this.storage.getItem(this.pointer("knownGraphs"))==null?(this.knownGraphs={},this.storage.setItem(this.pointer("knownGraphs"),JSON.stringify(this.knownGraphs))):this.knownGraphs=JSON.parse(this.storage.getItem(this.pointer("knownGraphs")));a!=null&&a(this)}};A.Lexicon.prototype.updateAfterWrite=function(){this.storage.setItem(this.pointer("oidCounter"),
""+this.oidCounter)};A.Lexicon.prototype.pointer=function(a,b){a=="uriToOID"?a="uo":a=="OIDToUri"?a="ou":a=="literalToOID"?a="lo":a=="OIDToLiteral"?a="ok":a=="blankToOID"?a="bo":a=="OIDToBlank"&&(a="ob");return b==null?this.name+"_l_"+a:this.name+"_l_"+a+"_"+b};A.Lexicon.prototype.clear=function(){this.uriToOID={};this.OIDToUri={};this.literalToOID={};this.OIDToLiteral={};this.blankToOID={};this.OIDToBlank={};for(var a=this.storage.length,b=this.name+"_l_",c=[],d=0;d<a;d++){var e=this.storage.key(d);
e.indexOf(b)==0&&c.push(e)}for(d=0;d<c.length;d++)this.storage.removeItem(c[d])};A.Lexicon.prototype.registerGraph=function(a){a!=this.defaultGraphOid&&(this.knownGraphs[a]=!0,this.storage.setItem(this.pointer("knownGraphs"),JSON.stringify(this.knownGraphs)));return!0};A.Lexicon.prototype.registeredGraphs=function(a){var b=[],c;for(c in this.knownGraphs)a===!0?b.push(this.retrieve(c)):b.push(c);return b};A.Lexicon.prototype.registerUri=function(a){if(a===this.defaultGraphUri)return this.defaultGraphOid;
else{if(this.uriToOID[a]==null){var b=this.storage.getItem(this.pointer("uriToOID",a));if(b==null){var b=this.oidCounter,c="u"+b;this.oidCounter++;this.uriToOID[a]=[b,0];this.OIDToUri[c]=a;this.storage.setItem(this.pointer("uriToOID",a),b+":0");this.storage.setItem(this.pointer("OIDToUri",c),a)}else{var d=b.split(":"),b=parseInt(d[0]),c="u"+b,d=parseInt(d[1])+1;this.uriToOID[a]=[b,d];this.OIDToUri[c]=a;this.storage.setItem(this.pointer("uriToOID",a),b+":0")}}else c=this.uriToOID[a],b=c[0],d=c[1]+
1,this.uriToOID[a]=[b,d],this.storage.setItem(this.pointer("uriToOID",a),b+":"+d);return b}};A.Lexicon.prototype.resolveUri=function(a){if(a===this.defaultGraphUri)return this.defaultGraphOid;else{var b=this.uriToOID[a];if(b!=null)return b[0];else if(b=this.storage.getItem(this.pointer("uriToOID",a)),b==null)return-1;else{var c=b.split(":"),b=parseInt(c[0]),d="u"+b,c=parseInt(c[1]);this.uriToOID[a]=[b,c];this.OIDToUri[d]=a;return b}}};A.Lexicon.prototype.resolveUriCost=function(a){return a===this.defaultGraphUri?
this.defaultGraphOid:(a=this.uriToOID[a],a!=null?a[1]:-1)};A.Lexicon.prototype.registerBlank=function(){var a=this.oidCounter;this.oidCounter++;a=""+a;this.storage.setItem(this.pointer("OIDToBlank",a),!0);this.OIDToBlank[a]=!0;return a};A.Lexicon.prototype.resolveBlank=function(){var a=this.oidCounter;this.oidCounter++;return""+a};A.Lexicon.prototype.resolveBlankCost=function(){return 0};A.Lexicon.prototype.registerLiteral=function(a){if(this.literalToOID[a]==null){var b=this.storage.getItem(this.pointer("literalToOID",
a));if(b==null){var b=this.oidCounter,c="l"+b;this.oidCounter++;this.literalToOID[a]=[b,0];this.OIDToLiteral[c]=a;this.storage.setItem(this.pointer("literalToOID",a),b+":0");this.storage.setItem(this.pointer("OIDToLiteral",c),a)}else c=b.split(":"),b=parseInt(c[0]),c=parseInt(c[1])+1,this.literalToOID[a]=[b,c],this.storage.setItem(this.pointer("literalToOID",a),b+":"+c)}else c=this.literalToOID[a],b=c[0],c=c[1]+1,this.storage.setItem(this.pointer("literalToOID",a),b+":"+c),this.literalToOID[a]=[b,
c];return b};A.Lexicon.prototype.resolveLiteral=function(a){var b=this.literalToOID[a];if(b!=null)return b[0];else{var c=this.storage.getItem(this.pointer("literalToOID",a));return c!=null?(b=c.split(":"),c=parseInt(b[0]),b=parseInt(b[1]),this.literalToOID[a]=[c,b],this.OIDToLiteral["l"+c]=a,c):-1}};A.Lexicon.prototype.resolveLiteralCost=function(a){a=this.literalToOID[a];return a!=null?a[1]:0};A.Lexicon.prototype.parseLiteral=function(a){var b=a.lastIndexOf("@");if(b!=-1&&a[b-1]==='"'){var c=a.substring(1,
b-1),a=a.substring(b+1,a.length);return{token:"literal",value:c,lang:a}}b=a.lastIndexOf("^^");if(b!=-1&&a[b-1]==='"'&&a[b+2]==="<"&&a[a.length-1]===">")return c=a.substring(1,b-1),a=a.substring(b+3,a.length-1),{token:"literal",value:c,type:a};c=a.substring(1,a.length-1);return{token:"literal",value:c}};A.Lexicon.prototype.parseUri=function(a){return{token:"uri",value:a}};A.Lexicon.prototype.retrieve=function(a){var b;try{if(a===this.defaultGraphOid)return{token:"uri",value:this.defaultGraphUri,prefix:null,
suffix:null,defaultGraph:!0};else{var c=this.OIDToUri["u"+a];if(c!=null)return this.parseUri(c);else{var d=this.OIDToLiteral["l"+a];if(d!=null)return this.parseLiteral(d);else{var e=this.OIDToBlank[""+a];if(e!=null)return{token:"blank",value:"_:"+a};else if(c=this.storage.getItem(this.pointer("OIDToUri","u"+a)),c!=null){this.OIDToUri["u"+a]=c;b=this.storage.getItem(this.pointer("uriToOID",c));var h=b.split(":"),g=parseInt(h[1]);this.uriToOID[c]=[a,g];return this.parseUri(c)}else if(d=this.storage.getItem(this.pointer("OIDToLiteral",
"l"+a)),d!=null){this.OIDToLiteral["l"+a]=d;b=this.storage.getItem(this.pointer("literalToOID",d));var f=b.split(":"),a=parseInt(f[0]),g=parseInt(f[1]);this.literalToOID[d]=[a,g];return this.parseLiteral(d)}else if(e=this.storage.getItem(this.pointer("OIDToBlank",""+a)),e!=null)return this.OIDToBlank[""+a]=!0,{token:"blank",value:"_:"+a};else throw"Null value for OID";}}}}catch(k){throw console.log("error in lexicon retrieving OID:"),console.log(a),k.message&&console.log(k.message),k.stack&&console.log(k.stack),
Error("Unknown retrieving OID in lexicon:"+a);}};A.Lexicon.prototype.unregister=function(a,b){try{return this.unregisterTerm(a.subject.token,b.subject),this.unregisterTerm(a.predicate.token,b.predicate),this.unregisterTerm(a.object.token,b.object),a.graph!=null&&this.unregisterTerm(a.graph.token,b.graph),!0}catch(c){return console.log("Error unregistering quad"),console.log(c.message),!1}};A.Lexicon.prototype.unregisterTerm=function(a,b){if(a==="uri"){if(b!=this.defaultGraphOid){var c="u"+b,d=this.OIDToUri[c],
e=this.uriToOID[d],h=e[1];if(""+e[0]===""+b)h===0?(delete this.OIDToUri[c],delete this.uriToOID[d],delete this.knownGraphs[b]):this.uriToOID[d]=[b,h-1];else throw"Not matching OID : "+b+" vs "+e[0];}}else if(a==="literal")if(this.oidCounter++,c="l"+b,d=this.OIDToLiteral[c],e=this.literalToOID[d],h=e[1],""+e[0]===""+b)h===0?(delete this.OIDToLiteral[c],delete this.literalToOID[d]):this.literalToOID[d]=[b,h-1];else throw"Not matching OID : "+b+" vs "+e[0];else a==="blank"&&delete this.OIDToBlank[""+
b]};var z={Lexicon:function(a){this.uriToOID={};this.OIDToUri={};this.literalToOID={};this.OIDToLiteral={};this.blankToOID={};this.OIDToBlank={};this.defaultGraphOid=0;this.defaultGraphUri="https://github.com/antoniogarrote/rdfstore-js#default_graph";this.defaultGraphUriTerm={token:"uri",prefix:null,suffix:null,value:this.defaultGraphUri,oid:this.defaultGraphOid};this.oidCounter=1;this.knownGraphs={};a!=null&&a(this)}};z.Lexicon.prototype.registerGraph=function(a){a!=this.defaultGraphOid&&(this.knownGraphs[a]=
!0);return!0};z.Lexicon.prototype.registeredGraphs=function(a){var b=[],c;for(c in this.knownGraphs)a===!0?b.push(this.OIDToUri["u"+c]):b.push(c);return b};z.Lexicon.prototype.registerUri=function(a){if(a===this.defaultGraphUri)return this.defaultGraphOid;else{if(this.uriToOID[a]==null){var b=this.oidCounter;this.oidCounter++;this.uriToOID[a]=[b,0];this.OIDToUri["u"+b]=a}else{var c=this.uriToOID[a],b=c[0];this.uriToOID[a]=[b,c[1]+1]}return b}};z.Lexicon.prototype.resolveUri=function(a){return a===
this.defaultGraphUri?this.defaultGraphOid:(a=this.uriToOID[a],a!=null?a[0]:-1)};z.Lexicon.prototype.resolveUriCost=function(a){return a===this.defaultGraphUri?this.defaultGraphOid:(a=this.uriToOID[a],a!=null?a[1]:-1)};z.Lexicon.prototype.registerBlank=function(){var a=this.oidCounter;this.oidCounter++;a=""+a;this.OIDToBlank[a]=!0;return a};z.Lexicon.prototype.resolveBlank=function(){var a=this.oidCounter;this.oidCounter++;return""+a};z.Lexicon.prototype.resolveBlankCost=function(){return 0};z.Lexicon.prototype.registerLiteral=
function(a){if(this.literalToOID[a]==null){var b=this.oidCounter;this.oidCounter++;this.literalToOID[a]=[b,0];this.OIDToLiteral["l"+b]=a}else{var c=this.literalToOID[a],b=c[0];this.literalToOID[a]=[b,c[1]+1]}return b};z.Lexicon.prototype.resolveLiteral=function(a){a=this.literalToOID[a];return a!=null?a[0]:-1};z.Lexicon.prototype.resolveLiteralCost=function(a){a=this.literalToOID[a];return a!=null?a[1]:0};z.Lexicon.prototype.parseLiteral=function(a){var b=a.lastIndexOf("@");if(b!=-1&&a[b-1]==='"'&&
a.substring(b,a.length).match(/^@[a-zA-Z\-]+$/g)!=null){var c=a.substring(1,b-1),a=a.substring(b+1,a.length);return{token:"literal",value:c,lang:a}}b=a.lastIndexOf("^^");if(b!=-1&&a[b-1]==='"'&&a[b+2]==="<"&&a[a.length-1]===">")return c=a.substring(1,b-1),a=a.substring(b+3,a.length-1),{token:"literal",value:c,type:a};c=a;a[0]==='"'&&a[a.length-1]==='"'&&(c=a.substring(1,a.length-1));return{token:"literal",value:c}};z.Lexicon.prototype.parseUri=function(a){return{token:"uri",value:a}};z.Lexicon.prototype.retrieve=
function(a){try{if(a===this.defaultGraphOid)return{token:"uri",value:this.defaultGraphUri,prefix:null,suffix:null,defaultGraph:!0};else{var b=this.OIDToUri["u"+a];if(b!=null)return this.parseUri(b);else{var c=this.OIDToLiteral["l"+a];if(c!=null)return this.parseLiteral(c);else if(this.OIDToBlank[""+a]!=null)return{token:"blank",value:"_:"+a};else throw"Null value for OID";}}}catch(d){throw console.log("error in lexicon retrieving OID:"),console.log(a),d.message||d.stack?(d.message&&console.log(d.message),
d.stack&&console.log(d.stack)):console.log(d),Error("Unknown retrieving OID in lexicon:"+a);}};z.Lexicon.prototype.clear=function(){this.uriToOID={};this.OIDToUri={};this.literalToOID={};this.OIDToLiteral={};this.blankToOID={};this.OIDToBlank={}};z.Lexicon.prototype.unregister=function(a,b){try{return this.unregisterTerm(a.subject.token,b.subject),this.unregisterTerm(a.predicate.token,b.predicate),this.unregisterTerm(a.object.token,b.object),a.graph!=null&&this.unregisterTerm(a.graph.token,b.graph),
!0}catch(c){return console.log("Error unregistering quad"),console.log(c.message),!1}};z.Lexicon.prototype.unregisterTerm=function(a,b){if(a==="uri"){if(b!=this.defaultGraphOid){var c="u"+b,d=this.OIDToUri[c],e=this.uriToOID[d],h=e[1];if(""+e[0]===""+b)h===0?(delete this.OIDToUri[c],delete this.uriToOID[d],delete this.knownGraphs[b]):this.uriToOID[d]=[b,h-1];else throw"Not matching OID : "+b+" vs "+e[0];}}else if(a==="literal")if(this.oidCounter++,c="l"+b,d=this.OIDToLiteral[c],e=this.literalToOID[d],
h=e[1],""+e[0]===""+b)h===0?(delete this.OIDToLiteral[c],delete this.literalToOID[d]):this.literalToOID[d]=[b,h-1];else throw"Not matching OID : "+b+" vs "+e[0];else a==="blank"&&delete this.OIDToBlank[""+b]};var y={AbstractQueryTree:function(){}};y.AbstractQueryTree.prototype.parseQueryString=function(a){return SparqlParser.parser.parse(a)};y.AbstractQueryTree.prototype.parseExecutableUnit=function(a){if(a.kind==="select")return this.parseSelect(a);else if(a.kind==="ask")return this.parseSelect(a);
else if(a.kind==="modify")return this.parseSelect(a);else if(a.kind==="construct")return this.parseSelect(a);else if(a.kind==="insertdata")return this.parseInsertData(a);else if(a.kind==="deletedata")return this.parseInsertData(a);else if(a.kind==="load")return a;else if(a.kind==="clear")return a;else if(a.kind==="drop")return a;else if(a.kind==="create")return a;else throw Error("unknown executable unit: "+a.kind);};y.AbstractQueryTree.prototype.parseSelect=function(a){return a==null?(console.log("error parsing query"),
null):(a.pattern=this.build(a.pattern,{freshCounter:0}),a)};y.AbstractQueryTree.prototype.parseInsertData=function(a){return a==null?(console.log("error parsing query"),null):a};y.AbstractQueryTree.prototype.build=function(a,b){if(a.token==="groupgraphpattern")return this._buildGroupGraphPattern(a,b);else if(a.token==="basicgraphpattern"){var c={kind:"BGP",value:a.triplesContext};return c=y.translatePathExpressionsInBGP(c,b)}else if(a.token==="graphunionpattern"){var c=this.build(a.value[0],b),d=
this.build(a.value[1],b);return{kind:"UNION",value:[c,d]}}else if(a.token==="graphgraphpattern")return{kind:"GRAPH",value:this.build(a.value,b),graph:a.graph};else throw Error("not supported token in query:"+a.token);};y.translatePathExpressionsInBGP=function(a,b){var c,d=[],e,h;for(h=0;h<a.value.length;h++)if(a.value[h].predicate&&a.value[h].predicate.token==="path"){c=a.value[h];e=a.value.slice(h+1);var g=y.translatePathExpression(c,b);c=null;if(g.kind==="BGP")d=d.concat(g.value);else if(g.kind===
"ZERO_OR_MORE_PATH"||g.kind==="ONE_OR_MORE_PATH"){h=d.length>0?{kind:"JOIN",lvalue:{kind:"BGP",value:d},rvalue:g}:g;if(g.kind==="ZERO_OR_MORE_PATH")if(g.y.token==="var"&&g.y.value.indexOf("fresh:")===0&&g.x.token==="var"&&g.x.value.indexOf("fresh:")===0)for(var f=0;f<a.value.length;f++){if(a.value[f].object&&a.value[f].object.token==="var"&&a.value[f].object.value===g.x.value)c=n.clone(a.value[f]),c.object=g.y}else if(g.y.token==="var"&&g.y.value.indexOf("fresh:")===0)for(f=0;f<a.value.length;f++)if(a.value[f].subject&&
a.value[f].subject.token==="var"&&a.value[f].subject.value===g.y.value)c=n.clone(a.value[f]),c.subject=g.x;return e.length>0?(g=y.translatePathExpressionsInBGP({kind:"BGP",value:e},b),c!=null?(d=d.concat([c]).concat(e),{kind:"UNION",value:[{kind:"JOIN",lvalue:h,rvalue:g},{kind:"BGP",value:d}]}):{kind:"JOIN",lvalue:h,rvalue:g}):h}else return g}else d.push(a.value[h]);a.value=d;return a};y.translatePathExpression=function(a,b){if(a.predicate.kind==="element")if(a.predicate.modifier==="+"){a.predicate.modifier=
null;var c=y.translatePathExpression(a,b);return{kind:"ONE_OR_MORE_PATH",path:c,x:a.subject,y:a.object}}else return a.predicate.modifier==="*"?(a.predicate.modifier=null,c=y.translatePathExpression(a,b),{kind:"ZERO_OR_MORE_PATH",path:c,x:a.subject,y:a.object}):(a.predicate=a.predicate.value,{kind:"BGP",value:[a]});else if(a.predicate.kind==="sequence"){for(var c=a.subject,d=a.object,e=a.graph,h,g,f=[],k=0;k<a.predicate.value.length;k++){k!=a.predicate.value.length-1?(h={token:"var",value:"fresh:"+
b.freshCounter},b.freshCounter++):h=d;g={subject:c,predicate:a.predicate.value[k],object:h};if(e!=null)g.graph=n.clone(e);f.push(g);k!=a.predicate.value.length-1&&(c=n.clone(h))}return y.translatePathExpressionsInBGP({kind:"BGP",value:f},b)}};y.AbstractQueryTree.prototype._buildGroupGraphPattern=function(a,b){for(var c=a.filters||[],d={kind:"EMPTY_PATTERN"},e=0;e<a.patterns.length;e++){var h=a.patterns[e];h.token==="optionalgraphpattern"?(h=this.build(h.value,b),d=h.kind==="FILTER"?{kind:"LEFT_JOIN",
lvalue:d,rvalue:h.value,filter:h.filter}:{kind:"LEFT_JOIN",lvalue:d,rvalue:h,filter:!0}):(h=this.build(h,b),d=d.kind=="EMPTY_PATTERN"?h:{kind:"JOIN",lvalue:d,rvalue:h})}if(c.length!=0)if(d.kind==="EMPTY_PATTERN")return{kind:"FILTER",filter:c,value:d};else if(d.kind==="LEFT_JOIN"&&d.filter===!0)return{kind:"FILTER",filter:c,value:d};else if(d.kind==="LEFT_JOIN")return{kind:"FILTER",filter:c,value:d};else if(d.kind==="JOIN")return{kind:"FILTER",filter:c,value:d};else if(d.kind==="UNION")return{kind:"FILTER",
filter:c,value:d};else if(d.kind==="GRAPH")return{kind:"FILTER",filter:c,value:d};else if(d.kind==="BGP")return{kind:"FILTER",filter:c,value:d};else throw Error("Unknow kind of algebra expression: "+d.kind);else return d};y.AbstractQueryTree.prototype.collectBasicTriples=function(a,b){b==null&&(b=[]);if(a.kind==="select")b=this.collectBasicTriples(a.pattern,b);else if(a.kind==="BGP")b=b.concat(a.value);else if(a.kind==="ZERO_OR_MORE_PATH")b=this.collectBasicTriples(a.path);else if(a.kind==="UNION")b=
this.collectBasicTriples(a.value[0],b),b=this.collectBasicTriples(a.value[1],b);else if(a.kind==="GRAPH")b=this.collectBasicTriples(a.value,b);else if(a.kind==="LEFT_JOIN"||a.kind==="JOIN")b=this.collectBasicTriples(a.lvalue,b),b=this.collectBasicTriples(a.rvalue,b);else if(a.kind==="FILTER")b=this.collectBasicTriples(a.value,b);else if(a.kind==="construct")b=this.collectBasicTriples(a.pattern,b);else if(a.kind!=="EMPTY_PATTERN")throw"Unknown pattern: "+a.kind;return b};y.AbstractQueryTree.prototype.bind=
function(a,b){if(a.graph!=null&&a.graph.token&&a.graph.token==="var"&&b[a.graph.value]!=null)a.graph=b[a.graph.value];if(a.filter!=null){for(var c=[],d=0;d<a.filter.length;d++)a.filter[d].value=this._bindFilter(a.filter[d].value,b),c.push(a.filter[d]);a.filter=c}if(a.kind==="select")a.pattern=this.bind(a.pattern,b);else if(a.kind==="BGP")a.value=this._bindTripleContext(a.value,b);else if(a.kind==="ZERO_OR_MORE_PATH"){a.path=this._bindTripleContext(a.path,b);if(a.x&&a.x.token==="var"&&b[a.x.value]!=
null)a.x=b[a.x.value];if(a.y&&a.y.token==="var"&&b[a.y.value]!=null)a.y=b[a.y.value]}else if(a.kind==="UNION")a.value[0]=this.bind(a.value[0],b),a.value[1]=this.bind(a.value[1],b);else if(a.kind==="GRAPH")a.value=this.bind(a.value,b);else if(a.kind==="LEFT_JOIN"||a.kind==="JOIN")a.lvalue=this.bind(a.lvalue,b),a.rvalue=this.bind(a.rvalue,b);else if(a.kind==="FILTER")a.filter=this._bindFilter(a.filter[d].value,b);else if(a.kind!=="EMPTY_PATTERN")throw"Unknown pattern: "+a.kind;return a};y.AbstractQueryTree.prototype._bindTripleContext=
function(a,b){for(var c=0;c<a.length;c++){delete a[c].graph;delete a[c].variables;for(var d in a[c]){var e=a[c][d];e.token==="var"&&b[e.value]!=null&&(a[c][d]=b[e.value])}}return a};y.AbstractQueryTree.prototype._bindFilter=function(a,b){if(a.expressionType!=null){var c=a.expressionType;if(c=="relationalexpression")a.op1=this._bindFilter(a.op1,b),a.op2=this._bindFilter(a.op2,b);else if(c=="conditionalor"||c=="conditionaland")for(c=0;c<a.operands.length;c++)a.operands[c]=this._bindFilter(a.operands[c],
b);else if(c=="additiveexpression"){a.summand=this._bindFilter(a.summand,b);for(c=0;c<a.summands.length;c++)a.summands[c].expression=this._bindFilter(a.summands[c].expression,b)}else if(c=="builtincall")for(c=0;c<a.args.length;c++)a.args[c]=this._bindFilter(a.args[c],b);else if(c=="multiplicativeexpression"){a.factor=this._bindFilter(a.factor,b);for(c=0;c<a.factors.length;c++)a.factors[c].expression=this._bindFilter(a.factors[c].expression,b)}else if(c=="unaryexpression")a.expression=this._bindFilter(a.expression,
b);else if(c=="irireforfunction")for(c=0;c<a.factors.args;c++)a.args[c]=this._bindFilter(a.args[c],b);else if(c=="atomic"&&a.primaryexpression=="var"&&b[a.value.value]!=null)c=b[a.value.value],a.primaryexpression=c.token==="uri"?"iri":"literal",a.value=c}return a};y.AbstractQueryTree.prototype.replace=function(a,b,c,d){if(a.graph!=null&&a.graph.token&&a.graph.token===b.token&&a.graph.value==b.value)a.graph=n.clone(c);if(a.filter!=null){for(var e=[],h=0;h<a.filter.length;h++)a.filter[h].value=this._replaceFilter(a.filter[h].value,
b,c,d),e.push(a.filter[h]);a.filter=e}if(a.kind==="select")a.pattern=this.replace(a.pattern,b,c,d);else if(a.kind==="BGP")a.value=this._replaceTripleContext(a.value,b,c,d);else if(a.kind==="ZERO_OR_MORE_PATH"){a.path=this._replaceTripleContext(a.path,b,c,d);if(a.x&&a.x.token===b.token&&a.value===b.value)a.x=n.clone(c);if(a.y&&a.y.token===b.token&&a.value===b.value)a.y=n.clone(c)}else if(a.kind==="UNION")a.value[0]=this.replace(a.value[0],b,c,d),a.value[1]=this.replace(a.value[1],b,c,d);else if(a.kind===
"GRAPH")a.value=this.replace(a.value,b,c);else if(a.kind==="LEFT_JOIN"||a.kind==="JOIN")a.lvalue=this.replace(a.lvalue,b,c,d),a.rvalue=this.replace(a.rvalue,b,c,d);else if(a.kind==="FILTER")a.value=this._replaceFilter(a.value,b,c,d);else if(a.kind!=="EMPTY_PATTERN")throw"Unknown pattern: "+a.kind;return a};y.AbstractQueryTree.prototype._replaceTripleContext=function(a,b,c,d){for(var e=0;e<a.length;e++)for(var h in a[e]){var g=a[e][h];if(g.token==="var"&&b.token==="var"&&g.value===b.value)a[e][h]=
c;else if(g.token==="blank"&&b.token==="blank"&&g.value===b.value)a[e][h]=c;else if((g.token==="literal"||g.token==="uri")&&(b.token==="literal"||b.token==="uri")&&g.token===b.token&&n.lexicalFormTerm(g,d)[g.token]===n.lexicalFormTerm(b,d)[g.token])a[e][h]=c}return a};y.AbstractQueryTree.prototype._replaceFilter=function(a,b,c,d){if(a.expressionType!=null){var e=a.expressionType;if(e=="relationalexpression")a.op1=this._replaceFilter(a.op1,b,c,d),a.op2=this._replaceFilter(a.op2,b,c,d);else if(e=="conditionalor"||
e=="conditionaland")for(e=0;e<a.operands.length;e++)a.operands[e]=this._replaceFilter(a.operands[e],b,c,d);else if(e=="additiveexpression"){a.summand=this._replaceFilter(a.summand,b,c,d);for(e=0;e<a.summands.length;e++)a.summands[e].expression=this._replaceFilter(a.summands[e].expression,b,c,d)}else if(e=="builtincall")for(e=0;e<a.args.length;e++)a.args[e]=this._replaceFilter(a.args[e],b,c,d);else if(e=="multiplicativeexpression"){a.factor=this._replaceFilter(a.factor,b,c,d);for(e=0;e<a.factors.length;e++)a.factors[e].expression=
this._replaceFilter(a.factors[e].expression,b,c,d)}else if(e=="unaryexpression")a.expression=this._replaceFilter(a.expression,b,c,d);else if(e=="irireforfunction")for(e=0;e<a.factors.args;e++)a.args[e]=this._replaceFilter(a.args[e],b,c,d);else if(e=="atomic"){d=null;if(a.primaryexpression==b.token&&a.value==b.value)d=c.value;else if(a.primaryexpression=="iri"&&b.token=="uri"&&a.value==b.value)d=c.value;if(d!=null)a.primaryexpression=c.token==="uri"?"iri":c.token,a.value=d}}return a};y.AbstractQueryTree.prototype.treeWithUnion=
function(a){if(a==null)return!1;if(a.kind==null)return!1;if(a.kind==="select")return this.treeWithUnion(a.pattern);else if(a.kind==="BGP")return this.treeWithUnion(a.value);else if(a.kind==="ZERO_OR_MORE_PATH")return!1;else if(a.kind==="UNION")if(console.log("UNION!!"),a.value[0].value!=null&&a.value[0].value.variables!=null&&a.value[1].value!=null&&a.value[1].value.variables!=null){if(console.log("COMPARING:"+a.value[0].variables.join("/")),console.log("VS "+a.values[1].variables.join("/")),a.value[0].variables.join("/")===
a.values[1].variables.join("/"))return this.treeWithUnion(a.value[0])?!0:this.treeWithUnion(a.value[1])}else return!0;else if(a.kind==="GRAPH")return!1;else if(a.kind==="LEFT_JOIN"||a.kind==="JOIN")if(this.treeWithUnion(a.lvalue))return!0;else this.treeWithUnion(a.rvalue);else return!1};var f={checkFilters:function(a,b,c,d,e,h){var g=a.filter,j=[];if(g==null||a.length!=null)return b;for(a=0;a<g.length;a++){for(var b=f.run(g[a].value,b,c,d,e,h),k=[],m=0;m<b.length;m++)b[m].__nullify__!=null?j.push(b[m]):
k.push(b[m]);b=k}return b.concat(j)}};f.boundVars=function(a){if(a.expressionType!=null){var b=a.expressionType;if(b=="relationalexpression")return b=a.op2,f.boundVars(a.op1)+f.boundVars(b);else if(b=="conditionalor"||b=="conditionaland"){for(var c=[],b=0;b<a.operands;b++)c=c.concat(f.boundVars(a.operands[b]));return c}else if(b=="builtincall")if(a.args==null)return[];else{c=[];for(b=0;b<a.args.length;b++)c=c.concat(f.boundVars(a.args[b]));return c}else if(b=="multiplicativeexpression"){c=f.boundVars(a.factor);
for(b=0;b<a.factors.length;b++)c=c.concat(f.boundVars(a.factors[b].expression));return c}else if(b=="additiveexpression"){c=f.boundVars(a.summand);for(b=0;b<a.summands.length;b++)c=c.concat(f.boundVars(a.summands[b].expression));return c}else if(b=="regex")return c=f.boundVars(a.expression1),c.concat(f.boundVars(a.expression2));else if(b=="unaryexpression")return f.boundVars(a.expression);else if(b=="atomic")return a.primaryexpression=="var"?[a.value]:[]}else throw console.log("ERROR"),console.log(a),
"Cannot find bound expressions in a no expression token";};f.run=function(a,b,c,d,e,h){for(var g=h.copyDenormalizedBindings(b,e.outCache),j=[],k=0;k<b.length;k++){var m=f.runFilter(a,g[k],h,d,e),m=f.ebv(m);f.isEbvError(m)?c&&(m={__nullify__:!0,bindings:b[k]},j.push(m)):m===!0?j.push(b[k]):c&&(m={__nullify__:!0,bindings:b[k]},j.push(m))}return j};f.collect=function(a,b,c,d,e){for(var h=e.copyDenormalizedBindings(b,d.outCache),g=[],j=0;j<h.length;j++){var k=f.runFilter(a,h[j],e,c,d);g.push({binding:b[j],
value:k})}return g};f.runDistinct=function(){};f.runAggregator=function(a,b,c,d,e){if(b==null||b.length===0)return f.ebvError();else if(a.token==="variable"&&a.kind=="var")return b[0][a.value.value];else if(a.token==="variable"&&a.kind==="aliased")if(a.expression.expressionType==="atomic"&&a.expression.primaryexpression==="var")return b[0][a.expression.value.value];else if(a.expression.expressionType==="aggregate")if(a.expression.aggregateType==="max"){for(var h=null,g=0;g<b.length;g++){var j=b[g],
j=f.runFilter(a.expression.expression,j,c,d,e);f.isEbvError(j)||(h===null?h=j:f.runLtFunction(h,j).value===!0&&(h=j))}return h===null?f.ebvError():h}else if(a.expression.aggregateType==="min"){h=null;for(g=0;g<b.length;g++)j=b[g],j=f.runFilter(a.expression.expression,j,c,d,e),f.isEbvError(j)||(h===null?h=j:f.runGtFunction(h,j).value===!0&&(h=j));return h===null?f.ebvError():h}else if(a.expression.aggregateType==="count"){var h={},k=0;if(a.expression.expression==="*")if(a.expression.distinct!=null&&
a.expression.distinct!="")for(g=0;g<b.length;g++){var j=b[g],m=n.hashTerm(j);h[m]==null&&(h[m]=!0,k++)}else k=b.length;else for(g=0;g<b.length;g++)j=b[g],j=f.runFilter(a.expression.expression,j,c,d,e),f.isEbvError(j)||(a.expression.distinct!=null&&a.expression.distinct!=""?(m=n.hashTerm(j),h[m]==null&&(h[m]=!0,k++)):k++);return{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:""+k}}else if(a.expression.aggregateType==="avg"){for(var h={},i={token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",
value:"0"},g=k=0;g<b.length;g++)j=b[g],j=f.runFilter(a.expression.expression,j,c,d,e),f.isEbvError(j)||(a.expression.distinct!=null&&a.expression.distinct!=""?(m=n.hashTerm(j),h[m]==null&&(h[m]=!0,f.isNumeric(j)&&(i=f.runSumFunction(i,j),k++))):f.isNumeric(j)&&(i=f.runSumFunction(i,j),k++));a=f.runDivFunction(i,{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:""+k});a.value=""+a.value;return a}else if(a.expression.aggregateType==="sum"){h={};i={token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",
value:"0"};for(g=0;g<b.length;g++)j=b[g],j=f.runFilter(a.expression.expression,j,c,d,e),f.isEbvError(j)||(a.expression.distinct!=null&&a.expression.distinct!=""?(m=n.hashTerm(j),h[m]==null&&(h[m]=!0,f.isNumeric(j)&&(i=f.runSumFunction(i,j)))):f.isNumeric(j)&&(i=f.runSumFunction(i,j)));i.value=""+i.value;return i}else return j=f.runFilter(aggregate.expression,b[0],d,{blanks:{},outCache:{}})};f.runFilter=function(a,b,c,d,e){if(a.expressionType!=null){var h=a.expressionType;if(h=="relationalexpression"){var h=
f.runFilter(a.op1,b,c,d,e),g=f.runFilter(a.op2,b,c,d,e);return f.runRelationalFilter(a,h,g,b,c,d,e)}else if(h=="conditionalor")return f.runOrFunction(a,b,c,d,e);else if(h=="conditionaland")return f.runAndFunction(a,b,c,d,e);else if(h=="additiveexpression")return f.runAddition(a.summand,a.summands,b,c,d,e);else if(h=="builtincall")return f.runBuiltInCall(a.builtincall,a.args,b,c,d,e);else if(h=="multiplicativeexpression")return f.runMultiplication(a.factor,a.factors,b,c,d,e);else if(h=="unaryexpression")return f.runUnaryExpression(a.unaryexpression,
a.expression,b,c,d,e);else if(h=="irireforfunction")return f.runIriRefOrFunction(a.iriref,a.args,b,c,d,e);else if(h=="regex")return f.runRegex(a.text,a.pattern,a.flags,b,c,d,e);else if(h=="atomic")if(a.primaryexpression=="var")return b[a.value.value];else{if(typeof a.value=="object"&&!(a.value.type==null||typeof a.value.type!="object"))a.value.type=n.lexicalFormBaseUri(a.value.type,e);return a.value}else throw"Unknown filter expression type";}else throw"Cannot find bound expressions in a no expression token";
};f.isRDFTerm=function(a){return a==null?!1:a.token&&a.token=="literal"||a.token&&a.token=="uri"||a.token&&a.token=="blank"?!0:!1};f.RDFTermEquality=function(a,b,c,d){return a.token==="literal"&&b.token==="literal"?a.lang==b.lang&&a.type==b.type&&a.value==b.value?!0:a.type!=null&&b.type!=null?f.ebvError():f.isSimpleLiteral(a)&&b.type!=null?f.ebvError():f.isSimpleLiteral(b)&&a.type!=null?f.ebvError():!1:a.token==="uri"&&b.token==="uri"?n.lexicalFormBaseUri(a,d)==n.lexicalFormBaseUri(b,d):a.token===
"blank"&&b.token==="blank"?a.value==b.value:!1};f.isInteger=function(a){return a==null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#integer"||a.type=="http://www.w3.org/2001/XMLSchema#decimal"||a.type=="http://www.w3.org/2001/XMLSchema#double"||a.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||a.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#long"||a.type=="http://www.w3.org/2001/XMLSchema#int"||a.type=="http://www.w3.org/2001/XMLSchema#short"||
a.type=="http://www.w3.org/2001/XMLSchema#byte"||a.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedShort"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||a.type=="http://www.w3.org/2001/XMLSchema#positiveInteger"?!0:!1:!1};f.isFloat=function(a){return a==null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#float"?
!0:!1:!1};f.isDecimal=function(a){return a==null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#decimal"?!0:!1:!1};f.isDouble=function(a){return a==null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#double"?!0:!1:!1};f.isNumeric=function(a){return a==null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#integer"||a.type=="http://www.w3.org/2001/XMLSchema#decimal"||a.type=="http://www.w3.org/2001/XMLSchema#float"||a.type=="http://www.w3.org/2001/XMLSchema#double"||
a.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||a.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#long"||a.type=="http://www.w3.org/2001/XMLSchema#int"||a.type=="http://www.w3.org/2001/XMLSchema#short"||a.type=="http://www.w3.org/2001/XMLSchema#byte"||a.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||a.type==
"http://www.w3.org/2001/XMLSchema#unsignedShort"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||a.type=="http://www.w3.org/2001/XMLSchema#positiveInteger"?!0:!1:!1};f.isSimpleLiteral=function(a){return a&&a.token=="literal"?a.type==null&&a.lang==null?!0:!1:!1};f.isXsdType=function(a,b){return b&&b.token=="literal"?b.type=="http://www.w3.org/2001/XMLSchema#"+a:!1};f.ebv=function(a){if(a==null||f.isEbvError(a))return f.ebvError();else if(a.token&&a.token==="literal")if(a.type=="http://www.w3.org/2001/XMLSchema#integer"||
a.type=="http://www.w3.org/2001/XMLSchema#decimal"||a.type=="http://www.w3.org/2001/XMLSchema#double"||a.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||a.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#long"||a.type=="http://www.w3.org/2001/XMLSchema#int"||a.type=="http://www.w3.org/2001/XMLSchema#short"||a.type=="http://www.w3.org/2001/XMLSchema#byte"||a.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||
a.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedShort"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||a.type=="http://www.w3.org/2001/XMLSchema#positiveInteger"){var b=parseFloat(a.value);return isNaN(b)?!1:parseFloat(a.value)!=0}else return a.type==="http://www.w3.org/2001/XMLSchema#boolean"?a.value==="true"||a.value===!0||a.value==="True":a.type==="http://www.w3.org/2001/XMLSchema#string"?a.value!="":a.type==="http://www.w3.org/2001/XMLSchema#dateTime"?
new Date(a.value)!=null:f.isEbvError(a)?a:a.type==null?a.value!=""?!0:!1:f.ebvError();else return a.value===!0};f.ebvTrue=function(){return{token:"literal",type:"http://www.w3.org/2001/XMLSchema#boolean",value:!0}};f.ebvFalse=function(){return{token:"literal",type:"http://www.w3.org/2001/XMLSchema#boolean",value:!1}};f.ebvError=function(){return{token:"literal",type:"https://github.com/antoniogarrote/js-tools/types#error",value:null}};f.isEbvError=function(a){return typeof a=="object"&&a!=null?a.type===
"https://github.com/antoniogarrote/js-tools/types#error":!1};f.ebvBoolean=function(a){return f.isEbvError(a)?a:a===!0?f.ebvTrue():f.ebvFalse()};f.runRelationalFilter=function(a,b,c,d,e,h,g){a=a.operator;if(a==="=")return f.runEqualityFunction(b,c,d,e,h,g);else if(a==="!="){b=f.runEqualityFunction(b,c,d,e,h,g);if(!f.isEbvError(b))b.value=!b.value;return b}else if(a==="<")return f.runLtFunction(b,c,d);else if(a===">")return f.runGtFunction(b,c,d);else if(a==="<=")return f.runLtEqFunction(b,c,d);else if(a===
">=")return f.runGtEqFunction(b,c,d);else throw"Error applying relational filter, unknown operator";};f.effectiveTypeValue=function(a){if(a.token=="literal")if(a.type=="http://www.w3.org/2001/XMLSchema#integer")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#decimal")return a=parseFloat(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#float")return a=parseFloat(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#double")return a=parseFloat(a.value);else if(a.type==
"http://www.w3.org/2001/XMLSchema#nonPositiveInteger")return a=parseFloat(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#negativeInteger")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#long")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#int")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#short")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#byte")return a=parseInt(a.value);
else if(a.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#unsignedLong")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#unsignedInt")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#unsignedShort")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#unsignedByte")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#positiveInteger")return a=
parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#date"||a.type=="http://www.w3.org/2001/XMLSchema#dateTime")try{return n.parseISO8601(a.value)}catch(b){return null}else return a.type=="http://www.w3.org/2001/XMLSchema#boolean"?a.value===!0||a.value==="true"||a.value==="1"||a.value===1||a.value===!0?!0:a.value===!1||a.value==="false"||a.value==="0"||a.value===0||a.value===!1?!1:void 0:a.type=="http://www.w3.org/2001/XMLSchema#string"?a.value===null||a.value===void 0?void 0:""+a.value:
a.value;else throw console.log("not implemented yet"),"value not supported in operations yet";};f.runOrFunction=function(a,b,c,d,e){for(var h=null,g=0;g<a.operands.length;g++){var j=f.runFilter(a.operands[g],b,c,d,e);f.isEbvError(j)==!1&&(j=f.ebv(j));h==null?h=j:f.isEbvError(j)?h=f.isEbvError(h)?f.ebvError():h===!0?!0:f.ebvError():j===!0?h=!0:f.isEbvError(h)&&(h=f.ebvError())}return f.ebvBoolean(h)};f.runAndFunction=function(a,b,c,d,e){for(var h=null,g=0;g<a.operands.length;g++){var j=f.runFilter(a.operands[g],
b,c,d,e);f.isEbvError(j)==!1&&(j=f.ebv(j));h==null?h=j:f.isEbvError(j)?h=f.isEbvError(h)?f.ebvError():h===!0?f.ebvError():!1:j===!0?f.isEbvError(h)&&(h=f.ebvError()):h=!1}return f.ebvBoolean(h)};f.runEqualityFunction=function(a,b,c,d,e,h){if(f.isEbvError(a)||f.isEbvError(b))return f.ebvError();if(f.isNumeric(a)&&f.isNumeric(b))return c=f.effectiveTypeValue(a),e=f.effectiveTypeValue(b),isNaN(c)||isNaN(e)?f.ebvBoolean(f.RDFTermEquality(a,b,d,h)):f.ebvBoolean(c==e);else if((f.isSimpleLiteral(a)||f.isXsdType("string",
a))&&(f.isSimpleLiteral(b)||f.isXsdType("string",b)))return f.ebvBoolean(f.effectiveTypeValue(a)==f.effectiveTypeValue(b));else if(f.isXsdType("boolean",a)&&f.isXsdType("boolean",b))return f.ebvBoolean(f.effectiveTypeValue(a)==f.effectiveTypeValue(b));else if((f.isXsdType("dateTime",a)||f.isXsdType("date",a))&&(f.isXsdType("dateTime",b)||f.isXsdType("date",b))){if(f.isXsdType("dateTime",a)&&f.isXsdType("date",b))return f.ebvFalse();if(f.isXsdType("date",a)&&f.isXsdType("dateTime",b))return f.ebvFalse();
a=a.value==b.value;return a!=null?a==0?f.ebvTrue():f.ebvFalse():f.ebvError()}else return f.isRDFTerm(a)&&f.isRDFTerm(b)?f.ebvBoolean(f.RDFTermEquality(a,b,d,h)):f.ebvFalse()};f.runGtFunction=function(a,b){if(f.isEbvError(a)||f.isEbvError(b))return f.ebvError();if(f.isNumeric(a)&&f.isNumeric(b))return f.ebvBoolean(f.effectiveTypeValue(a)>f.effectiveTypeValue(b));else if(f.isSimpleLiteral(a)&&f.isSimpleLiteral(b))return f.ebvBoolean(f.effectiveTypeValue(a)>f.effectiveTypeValue(b));else if(f.isXsdType("string",
a)&&f.isXsdType("string",b))return f.ebvBoolean(f.effectiveTypeValue(a)>f.effectiveTypeValue(b));else if(f.isXsdType("boolean",a)&&f.isXsdType("boolean",b))return f.ebvBoolean(f.effectiveTypeValue(a)>f.effectiveTypeValue(b));else if((f.isXsdType("dateTime",a)||f.isXsdType("date",a))&&(f.isXsdType("dateTime",b)||f.isXsdType("date",b))){if(f.isXsdType("dateTime",a)&&f.isXsdType("date",b))return f.ebvFalse();if(f.isXsdType("date",a)&&f.isXsdType("dateTime",b))return f.ebvFalse();var c=n.compareDateComponents(a.value,
b.value);return c!=null?c==1?f.ebvTrue():f.ebvFalse():f.ebvError()}else return f.ebvFalse()};f.runTotalGtFunction=function(a,b){return f.isEbvError(a)||f.isEbvError(b)?f.ebvError():f.isNumeric(a)&&f.isNumeric(b)||f.isSimpleLiteral(a)&&f.isSimpleLiteral(b)||f.isXsdType("string",a)&&f.isSimpleLiteral("string",b)||f.isXsdType("boolean",a)&&f.isSimpleLiteral("boolean",b)||f.isXsdType("dateTime",a)&&f.isSimpleLiteral("dateTime",b)?f.runGtFunction(a,b,[]):a.token&&a.token==="uri"&&b.token&&b.token==="uri"?
f.ebvBoolean(a.value>b.value):a.token&&a.token==="literal"&&b.token&&b.token==="literal"?f.ebvBoolean(""+a.value+a.type+a.lang>""+b.value+b.type+b.lang):a.token&&a.token==="blank"&&b.token&&b.token==="blank"?f.ebvBoolean(a.value>b.value):a.value&&b.value?f.ebvBoolean(a.value>b.value):f.ebvTrue()};f.runLtFunction=function(a,b){if(f.isEbvError(a)||f.isEbvError(b))return f.ebvError();if(f.isNumeric(a)&&f.isNumeric(b))return f.ebvBoolean(f.effectiveTypeValue(a)<f.effectiveTypeValue(b));else if(f.isSimpleLiteral(a)&&
f.isSimpleLiteral(b))return f.ebvBoolean(f.effectiveTypeValue(a)<f.effectiveTypeValue(b));else if(f.isXsdType("string",a)&&f.isXsdType("string",b))return f.ebvBoolean(f.effectiveTypeValue(a)<f.effectiveTypeValue(b));else if(f.isXsdType("boolean",a)&&f.isXsdType("boolean",b))return f.ebvBoolean(f.effectiveTypeValue(a)<f.effectiveTypeValue(b));else if((f.isXsdType("dateTime",a)||f.isXsdType("date",a))&&(f.isXsdType("dateTime",b)||f.isXsdType("date",b))){if(f.isXsdType("dateTime",a)&&f.isXsdType("date",
b))return f.ebvFalse();if(f.isXsdType("date",a)&&f.isXsdType("dateTime",b))return f.ebvFalse();var c=n.compareDateComponents(a.value,b.value);return c!=null?c==-1?f.ebvTrue():f.ebvFalse():f.ebvError()}else return f.ebvFalse()};f.runGtEqFunction=function(a,b){if(f.isEbvError(a)||f.isEbvError(b))return f.ebvError();if(f.isNumeric(a)&&f.isNumeric(b))return f.ebvBoolean(f.effectiveTypeValue(a)>=f.effectiveTypeValue(b));else if(f.isSimpleLiteral(a)&&f.isSimpleLiteral(b))return f.ebvBoolean(f.effectiveTypeValue(a)>=
f.effectiveTypeValue(b));else if(f.isXsdType("string",a)&&f.isXsdType("string",b))return f.ebvBoolean(f.effectiveTypeValue(a)>=f.effectiveTypeValue(b));else if(f.isXsdType("boolean",a)&&f.isXsdType("boolean",b))return f.ebvBoolean(f.effectiveTypeValue(a)>=f.effectiveTypeValue(b));else if((f.isXsdType("dateTime",a)||f.isXsdType("date",a))&&(f.isXsdType("dateTime",b)||f.isXsdType("date",b))){if(f.isXsdType("dateTime",a)&&f.isXsdType("date",b))return f.ebvFalse();if(f.isXsdType("date",a)&&f.isXsdType("dateTime",
b))return f.ebvFalse();var c=n.compareDateComponents(a.value,b.value);return c!=null?c!=-1?f.ebvTrue():f.ebvFalse():f.ebvError()}else return f.ebvFalse()};f.runLtEqFunction=function(a,b){if(f.isEbvError(a)||f.isEbvError(b))return f.ebvError();if(f.isNumeric(a)&&f.isNumeric(b))return f.ebvBoolean(f.effectiveTypeValue(a)<=f.effectiveTypeValue(b));else if(f.isSimpleLiteral(a)&&f.isSimpleLiteral(b))return f.ebvBoolean(f.effectiveTypeValue(a)<=f.effectiveTypeValue(b));else if(f.isXsdType("string",a)&&
f.isXsdType("string",b))return f.ebvBoolean(f.effectiveTypeValue(a)<=f.effectiveTypeValue(b));else if(f.isXsdType("boolean",a)&&f.isXsdType("boolean",b))return f.ebvBoolean(f.effectiveTypeValue(a)<=f.effectiveTypeValue(b));else if((f.isXsdType("dateTime",a)||f.isXsdType("date",a))&&(f.isXsdType("dateTime",b)||f.isXsdType("date",b))){if(f.isXsdType("dateTime",a)&&f.isXsdType("date",b))return f.ebvFalse();if(f.isXsdType("date",a)&&f.isXsdType("dateTime",b))return f.ebvFalse();var c=n.compareDateComponents(a.value,
b.value);return c!=null?c!=1?f.ebvTrue():f.ebvFalse():f.ebvError()}else return f.ebvFalse()};f.runAddition=function(a,b,c,d,e,h){var g=f.runFilter(a,c,d,e,h);if(f.isEbvError(g))return f.ebvError();a=g;if(f.isNumeric(g)){for(g=0;g<b.length;g++){var j=f.runFilter(b[g].expression,c,d,e,h);if(f.isNumeric(j))b[g].operator==="+"?a=f.runSumFunction(a,j):b[g].operator==="-"&&(a=f.runSubFunction(a,j));else return f.ebvFalse()}return a}else return f.ebvFalse()};f.runSumFunction=function(a,b){if(f.isEbvError(a)||
f.isEbvError(b))return f.ebvError();var c=f.effectiveTypeValue(a)+f.effectiveTypeValue(b);return f.isDouble(a)||f.isDouble(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#double",value:c}:f.isFloat(a)||f.isFloat(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#float",value:c}:f.isDecimal(a)||f.isDecimal(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#decimal",value:c}:{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:c}};f.runSubFunction=function(a,
b){if(f.isEbvError(a)||f.isEbvError(b))return f.ebvError();var c=f.effectiveTypeValue(a)-f.effectiveTypeValue(b);return f.isDouble(a)||f.isDouble(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#double",value:c}:f.isFloat(a)||f.isFloat(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#float",value:c}:f.isDecimal(a)||f.isDecimal(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#decimal",value:c}:{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:c}};
f.runMultiplication=function(a,b,c,d,e,h){a=f.runFilter(a,c,d,e,h);if(f.isEbvError(a))return a;var g=a;if(f.isNumeric(a)){for(var j=0;j<b.length;j++){var k=f.runFilter(b[j].expression,c,d,e,h);if(f.isEbvError(k))return a;if(f.isNumeric(k))b[j].operator==="*"?g=f.runMulFunction(g,k):b[j].operator==="/"&&(g=f.runDivFunction(g,k));else return f.ebvFalse()}return g}else return f.ebvFalse()};f.runMulFunction=function(a,b){if(f.isEbvError(a)||f.isEbvError(b))return f.ebvError();var c=f.effectiveTypeValue(a)*
f.effectiveTypeValue(b);return f.isDouble(a)||f.isDouble(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#double",value:c}:f.isFloat(a)||f.isFloat(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#float",value:c}:f.isDecimal(a)||f.isDecimal(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#decimal",value:c}:{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:c}};f.runDivFunction=function(a,b){if(f.isEbvError(a)||f.isEbvError(b))return f.ebvError();var c=
f.effectiveTypeValue(a)/f.effectiveTypeValue(b);return f.isDouble(a)||f.isDouble(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#double",value:c}:f.isFloat(a)||f.isFloat(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#float",value:c}:f.isDecimal(a)||f.isDecimal(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#decimal",value:c}:{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:c}};f.runBuiltInCall=function(a,b,c,d,e,h){if(a==="notexists"||a==="exists"){var g=
JSON.parse(JSON.stringify(b[0])),g=d.abstractQueryTree.parseSelect({pattern:g},c),g=d.abstractQueryTree.bind(g.pattern,c),c=d.executeSelectUnit([{kind:"*"}],e,g,h);return a==="exists"?f.ebvBoolean(c.length!==0):f.ebvBoolean(c.length===0)}else{for(var g=[],j=0;j<b.length;j++)if(b[j].token==="var")g.push(b[j]);else{var k=f.runFilter(b[j],c,d,e,h);if(f.isEbvError(k))return k;g.push(k)}if(a==="str")return g[0].token==="literal"?{token:"literal",type:null,value:""+g[0].value}:g[0].token==="uri"?{token:"literal",
type:null,value:g[0].value}:f.ebvFalse();else if(a==="lang")return g[0].token==="literal"?g[0].lang!=null?{token:"literal",value:""+g[0].lang}:{token:"literal",value:""}:f.ebvError();else if(a==="datatype")return g[0].token==="literal"?(a=g[0],a.type!=null?typeof a.type==="string"?{token:"uri",value:a.type,prefix:null,suffix:null}:a.type:a.lang==null?{token:"uri",value:"http://www.w3.org/2001/XMLSchema#string",prefix:null,suffix:null}:f.ebvError()):f.ebvError();else if(a==="isliteral")return g[0].token===
"literal"?f.ebvTrue():f.ebvFalse();else if(a==="isblank")return g[0].token==="blank"?f.ebvTrue():f.ebvFalse();else if(a==="isuri"||a==="isiri")return g[0].token==="uri"?f.ebvTrue():f.ebvFalse();else if(a==="sameterm")return a=f.RDFTermEquality(g[0],g[1],d,h),f.isEbvError(a)&&(a=!1),f.ebvBoolean(a);else if(a==="langmatches")return a=g[0],c=g[1],a.token==="literal"&&c.token==="literal"?c.value==="*"&&a.value!=""?f.ebvTrue():f.ebvBoolean(a.value.toLowerCase().indexOf(c.value.toLowerCase())===0):f.ebvError();
else if(a==="bound")return a=g[0].value,a==null?f.ebvError():c[a]!=null?f.ebvTrue():f.ebvFalse();else throw"Builtin call "+a+" not implemented yet";}};f.runUnaryExpression=function(a,b,c,d,e,h){b=f.runFilter(b,c,d,e,h);if(f.isEbvError(b))return b;if(a==="!"){var g=f.ebv(b);return f.isEbvError(g)?f.ebvFalse():f.ebvBoolean(!g)}else if(a==="+")return f.isNumeric(b)?b:f.ebvError();else if(a==="-")if(f.isNumeric(b)){a={};for(g in b)a[g]=b[g];a.value=-a.value;return a}else return f.ebvError()};f.runRegex=
function(a,b,c,d,e,h,g){if(a!=null)a=f.runFilter(a,d,e,h,g);else return f.ebvError();if(b!=null)b=f.runFilter(b,d,e,h,g);else return f.ebvError();c!=null&&(c=f.runFilter(c,d,e,h,g));if(b!=null&&b.token==="literal"&&(c==null||c.token==="literal"))b=b.value,c=c==null?null:c.value;else return f.ebvError();if(a!=null&&a.token=="var")if(d[a.value]!=null)a=d[a.value];else return f.ebvError();else if(a!=null&&a.token==="literal")if(a.type==null||f.isXsdType("string",a))a=a.value;else return f.ebvError();
else return f.ebvError();return(c==null?RegExp(b):RegExp(b,c.toLowerCase())).exec(a)?f.ebvTrue():f.ebvFalse()};f.normalizeLiteralDatatype=function(a,b,c){if(!(a.value.type==null||typeof a.value.type!="object"))a.value.type=n.lexicalFormBaseUri(a.value.type,c);return a};f.runIriRefOrFunction=function(a,b,c,d,e,h){if(b==null)return a;else{for(var g=[],j=0;j<b.length;j++)g.push(f.runFilter(b[j],c,d,e,h));a=n.lexicalFormBaseUri(a,h);if(a=="http://www.w3.org/2001/XMLSchema#integer"||a=="http://www.w3.org/2001/XMLSchema#decimal"||
a=="http://www.w3.org/2001/XMLSchema#double"||a=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||a=="http://www.w3.org/2001/XMLSchema#negativeInteger"||a=="http://www.w3.org/2001/XMLSchema#long"||a=="http://www.w3.org/2001/XMLSchema#int"||a=="http://www.w3.org/2001/XMLSchema#short"||a=="http://www.w3.org/2001/XMLSchema#byte"||a=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||a=="http://www.w3.org/2001/XMLSchema#unsignedLong"||a=="http://www.w3.org/2001/XMLSchema#unsignedInt"||a=="http://www.w3.org/2001/XMLSchema#unsignedShort"||
a=="http://www.w3.org/2001/XMLSchema#unsignedByte"||a=="http://www.w3.org/2001/XMLSchema#positiveInteger")if(g=g[0],g.token==="literal")if(g=f.normalizeLiteralDatatype(g,d,h),g.type=="http://www.w3.org/2001/XMLSchema#integer"||g.type=="http://www.w3.org/2001/XMLSchema#decimal"||g.type=="http://www.w3.org/2001/XMLSchema#double"||g.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||g.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||g.type=="http://www.w3.org/2001/XMLSchema#long"||
g.type=="http://www.w3.org/2001/XMLSchema#int"||g.type=="http://www.w3.org/2001/XMLSchema#short"||g.type=="http://www.w3.org/2001/XMLSchema#byte"||g.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||g.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||g.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||g.type=="http://www.w3.org/2001/XMLSchema#unsignedShort"||g.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||g.type=="http://www.w3.org/2001/XMLSchema#positiveInteger")return g.type=
a,g;else if(g.type=="http://www.w3.org/2001/XMLSchema#boolean")return f.ebv(g)==!0?(g.type=a,g.value=1):(g.type=a,g.value=0),g;else if(g.type=="http://www.w3.org/2001/XMLSchema#float"||g.type=="http://www.w3.org/2001/XMLSchema#double")return g.type=a,g.value=parseInt(g.value),g;else if(g.type=="http://www.w3.org/2001/XMLSchema#string"||g.type==null){if(g.value.split(".").length>2)return f.ebvError();else if(g.value.split("-").length>2)return f.ebvError();else if(g.value.split("/").length>2)return f.ebvError();
else if(g.value.split("+").length>2)return f.ebvError();if(a=="http://www.w3.org/2001/XMLSchema#decimal"&&(g.value.indexOf("e")!=-1||g.value.indexOf("E")!=-1))return f.ebvError();if(a=="http://www.w3.org/2001/XMLSchema#int"||a=="http://www.w3.org/2001/XMLSchema#integer")if(g.value.indexOf("e")!=-1||g.value.indexOf("E")!=-1||g.value.indexOf(".")!=-1)return f.ebvError();try{return g.value=parseInt(parseFloat(g.value)),isNaN(g.value)?f.ebvError():(g.type=a,g)}catch(k){return f.ebvError()}}else return f.ebvError();
else return f.ebvError();else if(a=="http://www.w3.org/2001/XMLSchema#boolean")return g=g[0],g.token==="literal"&&g.type==null?g.value==="true"||g.value==="1"?f.ebvTrue():g.value==="false"||g.value==="0"?f.ebvFalse():f.ebvError():g.token==="literal"?f.isEbvError(g)?g:f.ebvBoolean(g):f.ebvError();else if(a=="http://www.w3.org/2001/XMLSchema#string")if(g=g[0],g.token==="literal")if(g=f.normalizeLiteralDatatype(g,d,h),g.type=="http://www.w3.org/2001/XMLSchema#integer"||g.type=="http://www.w3.org/2001/XMLSchema#decimal"||
g.type=="http://www.w3.org/2001/XMLSchema#double"||g.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||g.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||g.type=="http://www.w3.org/2001/XMLSchema#long"||g.type=="http://www.w3.org/2001/XMLSchema#int"||g.type=="http://www.w3.org/2001/XMLSchema#short"||g.type=="http://www.w3.org/2001/XMLSchema#byte"||g.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||g.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||g.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||
g.type=="http://www.w3.org/2001/XMLSchema#unsignedShort"||g.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||g.type=="http://www.w3.org/2001/XMLSchema#positiveInteger"||g.type=="http://www.w3.org/2001/XMLSchema#float")return g.type=a,g.value=""+g.value,g;else if(g.type=="http://www.w3.org/2001/XMLSchema#string")return g;else if(g.type=="http://www.w3.org/2001/XMLSchema#boolean")return f.ebv(g)?(g.type=a,g.value="true"):(g.type=a,g.value="false"),g;else if(g.type=="http://www.w3.org/2001/XMLSchema#dateTime"||
g.type=="http://www.w3.org/2001/XMLSchema#date"){g.type=a;if(typeof g.value!="string")g.value=n.iso8601(g.value);return g}else return g.type==null?(g.value=""+g.value,g.type=a,g):f.ebvError();else return g.token==="uri"?{token:"literal",value:n.lexicalFormBaseUri(g,h),type:a,lang:null}:f.ebvError();else if(a=="http://www.w3.org/2001/XMLSchema#dateTime"||a=="http://www.w3.org/2001/XMLSchema#date")if(g=g[0],g.type=="http://www.w3.org/2001/XMLSchema#dateTime"||g.type=="http://www.w3.org/2001/XMLSchema#date")return g;
else if(g.type=="http://www.w3.org/2001/XMLSchema#string"||g.type==null)try{return g.value=n.iso8601(g.value),g.type=a,g}catch(m){return f.ebvError()}else return f.ebvError();else if(a=="http://www.w3.org/2001/XMLSchema#float")if(g=g[0],g.token==="literal")if(g=f.normalizeLiteralDatatype(g,d,h),g.type=="http://www.w3.org/2001/XMLSchema#decimal"||g.type=="http://www.w3.org/2001/XMLSchema#int")return g.type=a,g.value=parseFloat(g.value),g;else if(g.type=="http://www.w3.org/2001/XMLSchema#boolean")return f.ebv(g)==
!0?(g.type=a,g.value=1):(g.type=a,g.value=0),g;else if(g.type=="http://www.w3.org/2001/XMLSchema#float"||g.type=="http://www.w3.org/2001/XMLSchema#double")return g.type=a,g.value=parseFloat(g.value),g;else if(g.type=="http://www.w3.org/2001/XMLSchema#string")try{return g.value=parseFloat(g.value),isNaN(g.value)?f.ebvError():(g.type=a,g)}catch(i){return f.ebvError()}else if(g.type==null){if(g.value.split(".").length>2)return f.ebvError();else if(g.value.split("-").length>2)return f.ebvError();else if(g.value.split("/").length>
2)return f.ebvError();else if(g.value.split("+").length>2)return f.ebvError();try{return g.value=parseFloat(g.value),isNaN(g.value)?f.ebvError():(g.type=a,g)}catch(C){return f.ebvError()}}else return f.ebvError();else return f.ebvError();else return f.ebvError()}};var t={variablesInBGP:function(a){var b=a.variables;if(b)return b;var c=a.value||a,b=[],d;for(d in c)c[d]&&c[d].token==="var"?b.push(c[d].value):c[d]&&c[d].token==="blank"&&b.push("blank:"+c[d].value);return a.variables=b},connected:function(a,
b){for(var c="/"+a.vars.join("/")+"/",d=0;d<b.vars.length;d++)if(c.indexOf("/"+b.vars[d]+"/")!=-1)return!0;return!1},variablesIntersectionBGP:function(a,b){for(var c=t.variablesInBGP(a).sort(),d=t.variablesInBGP(b).sort(),e=0,h=0,g=[];e<c.length&&h<d.length;)c[e]===d[h]?(g.push(c[e]),e++,h++):c[e]<d[h]?e++:h++;return g},executeAndBGPsGroups:function(a){for(var b={},c={},d=0,e=0;e<a.length;e++){var h=a[e],g={},f={},k=[],m;for(m in h)m!="_cost"&&(h[m].token==="var"?k.push(h[m].value):h[m].token==="blank"&&
k.push(h[m].value));var i=!1,C={},l;for(l in c){for(var q=c[l],i=!1,n=0;n<k.length;n++)if(q.indexOf("/"+k[n]+"/")!=-1){i=!0;break}i?C[l]=!0:(g[l]=b[l],f[l]=c[l])}if(i){var i=[],n=q="",o;for(o in C)q+=o,i=i.concat(b[o]),n=c[o];n=n+k.join("/")+"/";i.push(h);g[q]=i;f[q]=n}else g[d]=[h],f[d]="/"+k.join("/")+"/",d++;b=g;c=f}a=[];for(d in b)a.push(b[d]);return a},intersectionSize:function(a,b){for(var c=b.i.split("_"),d=0;d<c.length;d++)if(c[d]!=""&&a.i.indexOf("_"+c[d]+"_")!=-1)return 1;return 0},createJoinTree:function(a,
b){for(var c="/"+a.vars.join("/")+"/",d=a.vars.concat([]),e=[],h=0;h<b.vars.length;h++)c.indexOf("/"+b.vars[h]+"/")!=-1?b.vars[h].indexOf("_:")==0?e.push("blank:"+b.vars[h]):e.push(b.vars[h]):d.push(b.vars[h]);for(var g=b.i.split("_"),f=a.i.split("_"),c={},h=0;h<g.length;h++)g[h]!=""&&(c[g[h]]=!0);for(h=0;h<f.length;h++)f[h]!=""&&(c[f[h]]=!0);var h=[],k;for(k in c)h.push(k);return{left:a,right:b,cost:a.cost+b.cost,i:"_"+h.sort().join("_")+"_",vars:d,join:e}}};t.executeBushyTree=function(a,b,c,d){if(a.left==
null)return t.executeEmptyJoinBGP(a.right,b,c,d);else if(a.right==null)return t.executeEmptyJoinBGP(a.left,b,c,d);else{var e=t.executeBushyTree(a.left,b,c,d);if(e!=null)return b=t.executeBushyTree(a.right,b,c,d),b!=null?t.joinBindings2(a.join,e,b):null}};t.executeAndBGPsDPSize=function(a,b,c,d){for(var e=t.executeAndBGPsGroups(a),a=[],h=0;h<e.length;h++){var g=e[h];c.computeCosts(g,d);var f={},k={},m={},i=1,C=null,l={};m["1"]=[];for(var q=0;q<g.length;q++){var i=[],n;for(n in g[q])n!="_cost"&&(g[q][n].token===
"var"?i.push(g[q][n].value):g[q][n].token==="blank"&&i.push(g[q][n].value));k["_"+q+"_"]={left:g[q],right:null,cost:g[q]._cost,i:"_"+q+"_",vars:i};i={left:g[q],right:null,cost:g[q]._cost,i:"_"+q+"_",vars:i};f["_"+q+"_"]=i;delete g[q]._cost;l["_"+q+"_"]=!0;m["1"].push("_"+q+"_");if(C==null||C.cost>i.cost)C=i}for(var o=2;o<=g.length;o++)for(var r=1;r<o;r++)for(var v=m[""+r]||[],u=m[""+(o-r)]||[],q=0;q<v.length;q++)for(var K=0;K<u.length;K++)if(v[q]!==u[K]){var w=k[v[q]],s=k[u[K]];if(t.intersectionSize(w,
s)==0&&t.connected(w,s)&&(i=o,s=t.createJoinTree(f[w.i],f[s.i]),!l[s.i])){l[s.i]=!0;var x=s.cost+1;if(f[s.i]!=null)x=f[s.i].cost;w=m[o]||[];w.push(s.i);k[s.i]=s;m[o]=w;x>s.cost&&(i===o&&(C=s),f[s.i]=s)}}a.push(C)}w=null;for(h=0;h<a.length;h++)n=t.executeBushyTree(a[h],b,c,d),w=w==null?n:t.crossProductBindings(w,n);return w};t.executeEmptyJoinBGP=function(a,b,c,d){return t.executeBGPDatasets(a,b,c,d)};t.executeBGPDatasets=function(a,b,c,d){var e={};if(a.graph==null){for(var h=[],g=0;g<b.implicit.length;g++)if(e[b.implicit[g].oid]==
null){e[b.implicit[g].oid]=!0;a.graph=b.implicit[g];var f=c.rangeQuery(a,d),f=t.buildBindingsFromRange(f,a);h.push(f)}return a=t.unionManyBindings(h)}else if(a.graph.token==="var"){for(var k=a.graph.value,h=[],g=0;g<b.named.length;g++)if(e[b.named[g].oid]==null)if(e[b.named[g].oid]=!0,a.graph=b.named[g],f=c.rangeQuery(a,d),f!=null){for(var f=t.buildBindingsFromRange(f,a),m=0;m<f.length;m++)f[m][k]=b.named[g].oid;h.push(f)}else return null;return a=t.unionManyBindings(h||[])}else return f=c.rangeQuery(a,
d),f!=null?f=t.buildBindingsFromRange(f,a):null};t.buildBindingsFromRange=function(a,b){t.variablesInBGP(b);var c={},d=b.value||b,c={};for(f in d)d[f]&&d[f].token==="var"?c[f]=d[f].value:d[f]&&d[f].token==="blank"&&(c[f]="blank:"+d[f].value);d=[];if(a!=null)for(var e=0;e<a.length;e++){var h={},g=a[e],f;for(f in c)h[c[f]]=g[f];d.push(h)}return d};t.areCompatibleBindings=function(a,b){for(var c in a)if(b[c]!=null&&b[c]!=a[c])return!1;return!0};t.mergeBindings=function(a,b){var c={},d;for(d in a)c[d]=
a[d];for(d in b)c[d]=b[d];return c};t.joinBindings2=function(a,b,c){for(var d={},e,f,g,j,k=[],m=0;m<b.length;m++){e=b[m];j=d;for(var i=0;i<a.length;i++)f=a[i],f=e[f],i==a.length-1?(g=j[f]||[],g.push(e),j[f]=g):(g=j[f]||{},j=j[f]=g)}for(m=0;m<c.length;m++){e=c[m];j=d;for(i=0;i<a.length;i++)if(f=a[i],f=e[f],j[f]!=null)if(i==a.length-1)for(b=0;b<j[f].length;b++)k.push(t.mergeBindings(j[f][b],e));else j=j[f]}return k};t.joinBindings=function(a,b){for(var c=[],d=0;d<a.length;d++)for(var e=a[d],f=0;f<b.length;f++){var g=
b[f];t.areCompatibleBindings(e,g)&&c.push(t.mergeBindings(e,g))}return c};t.augmentMissingBindings=function(a,b){for(var c in b)a[c]==null&&(a[c]=null);return a};t.leftOuterJoinBindings=function(a,b){for(var c=[],d=0;d<a.length;d++){for(var e=a[d],f=!1,g=0;g<b.length;g++){var j=b[g];t.areCompatibleBindings(e,j)&&(f=!0,c.push(t.mergeBindings(e,j)))}f===!1&&(t.augmentMissingBindings(e,j),c.push(e))}return c};t.crossProductBindings=function(a,b){for(var c=[],d=0;d<a.length;d++)for(var e=a[d],f=0;f<b.length;f++)c.push(t.mergeBindings(e,
b[f]));return c};t.unionBindings=function(a,b){return a.concat(b)};t.unionManyBindings=function(a){for(var b=[],c=0;c<a.length;c++)b=t.unionBindings(b,a[c]);return b};var u={},J=t;u.QueryEngine=function(a){if(arguments.length!=0)this.backend=a.backend,this.lexicon=a.lexicon,this.eventsOnBatchLoad=a.eventsOnBatchLoad||!1,this.defaultPrefixes={},this.abstractQueryTree=new y.AbstractQueryTree,this.callbacksBackend=new s.CallbacksBackend(this)};u.QueryEngine.prototype.registerNsInEnvironment=function(a,
b){var c=[];if(a!=null&&a.prefixes!=null)c=a.prefixes;var d={},e;for(e in this.defaultPrefixes)d[e]=this.defaultPrefixes[e];for(e=0;e<c.length;e++){var f=c[e];if(f.token==="prefix")d[f.prefix]=f.local}b.namespaces=d;b.base=a!=null&&a.base&&typeof a.base==="object"?a.base.value:null};u.QueryEngine.prototype.applyModifier=function(a,b){if(a=="DISTINCT"){for(var c={},d=[],e=0;e<b.length;e++){var f=b[e],g="",j;for(j in f){var k=f[j];k==null?g=g+j+"null":k.token=="literal"?(k.value!=null&&(g+=k.value),
k.lang!=null&&(g+=k.lang),k.type!=null&&(g+=k.type)):g=k.value?g+j+k.value:g+j+k}c[g]==null&&(d.push(f),c[g]=!0)}return d}else return b};u.QueryEngine.prototype.applyLimitOffset=function(a,b,c){if(b==null&&a==null)return c;a==null&&(a=0);b=b==null?c.length:a+b;return c.slice(a,b)};u.QueryEngine.prototype.applySingleOrderBy=function(a,b,c,d){for(var e=[],h=0;h<a.length;h++){var g=f.collect(a[h].expression,[b],c,d,this);e.push(g[0].value)}return{binding:b,value:e}};u.QueryEngine.prototype.applyOrderBy=
function(a,b,c,d){var e=this,f=[];if(a!=null&&a.length>0){for(var g=0;g<b.length;g++){var j=e.applySingleOrderBy(a,b[g],c,d);f.push(j)}f.sort(function(b,c){return e.compareFilteredBindings(b,c,a,d)});b=[];for(g=0;g<f.length;g++)b.push(f[g].binding)}return b};u.QueryEngine.prototype.compareFilteredBindings=function(a,b,c,d){for(var e=0;;){if(e==a.value.length)return 0;var h=c[e].direction;if(a.value[e]==null&&b.value[e]==null)e++;else{if(a.value[e]==null)a={value:!1};else if(b.value[e]==null)a={value:!0};
else if(a.value[e].token==="blank"&&b.value[e].token==="blank"){e++;continue}else if(a.value[e].token==="blank")a={value:!1};else if(b.value[e].token==="blank")a={value:!0};else if(a.value[e].token==="uri"&&b.value[e].token==="uri")if(f.runEqualityFunction(a.value[e],b.value[e],[],this,d).value==!0){e++;continue}else a=f.runTotalGtFunction(a.value[e],b.value[e],[]);else if(a.value[e].token==="uri")a={value:!1};else if(b.value[e].token==="uri")a={value:!0};else if(a.value[e].token==="literal"&&b.value[e].token===
"literal"&&a.value[e].type==null&&b.value[e].type==null)if(f.runEqualityFunction(a.value[e],b.value[e],[],this,d).value==!0){e++;continue}else a=f.runTotalGtFunction(a.value[e],b.value[e],[]);else if(a.value[e].token==="literal"&&a.value[e].type==null)a={value:!1};else if(b.value[e].token==="literal"&&b.value[e].type==null)a={value:!0};else if(f.runEqualityFunction(a.value[e],b.value[e],[],this,d).value==!0){e++;continue}else a=f.runTotalGtFunction(a.value[e],b.value[e],[]);return a.value==!0?h===
"ASC"?1:-1:h==="ASC"?-1:1}}};u.QueryEngine.prototype.removeDefaultGraphBindings=function(a,b){for(var c=[],d={},e=0;e<b.named.length;e++)d[b.named[e].oid]=!0;for(e=0;e<b.implicit.length;e++)d[b.implicit[e].oid]==null&&c.push(b.implicit[e].oid);c=[];for(e=0;e<a.length;e++){var f=a[e],g=!1,j;for(j in f){for(var k=0;k<d.length;k++)if(f[j]===d[k]){g=!0;break}if(g)break}g||c.push(f)}return c};u.QueryEngine.prototype.aggregateBindings=function(a,b,c,d){for(var b=this.copyDenormalizedBindings(b,d.outCache),
e={},h=0;h<a.length;h++){var g=f.runAggregator(a[h],b,this,c,d);a[h].alias?e[a[h].alias.value]=g:e[a[h].value.value]=g}return e};u.QueryEngine.prototype.projectBindings=function(a,b,c){if(a[0].kind==="*")return b;else{for(var d=[],e=0;e<b.length;e++){for(var h=b[e],g={},j=!0,k=0;k<a.length;k++)if(a[k].token=="variable"&&a[k].kind!="aliased")g[a[k].value.value]=h[a[k].value.value];else if(a[k].token=="variable"&&a[k].kind=="aliased"){var m=f.runFilter(a[k].expression,h,this,c,{blanks:{},outCache:{}});
if(f.isEbvError(m)){j=!1;break}else g[a[k].alias.value]=m}j===!0&&d.push(g)}return d}};u.QueryEngine.prototype.resolveNsInEnvironment=function(a,b){return b.namespaces[a]};u.QueryEngine.prototype.termCost=function(a,b){if(a.token==="uri"){var c=n.lexicalFormBaseUri(a,b);return c==null?0:this.lexicon.resolveUriCost(c)}else return a.token==="literal"?this.lexicon.resolveLiteralCost(n.lexicalFormLiteral(a,b)):a.token==="blank"?this.lexicon.resolveBlankCost(a.value):a.token==="var"?this.lexicon.oidCounter/
3:null};u.QueryEngine.prototype.normalizeTerm=function(a,b,c){if(a.token==="uri")return b=n.lexicalFormBaseUri(a,b),b==null?null:c?this.lexicon.registerUri(b):this.lexicon.resolveUri(b);else if(a.token==="literal")return b=n.lexicalFormLiteral(a,b),a=c?this.lexicon.registerLiteral(b):this.lexicon.resolveLiteral(b);else if(a.token==="blank"){var d=a.value,a=b.blanks[d];a==null&&(a=c?this.lexicon.registerBlank(d):this.lexicon.resolveBlank(d),b.blanks[d]=a);return a}else return a.token==="var"?a.value:
null};u.QueryEngine.prototype.normalizeDatasets=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.value===this.lexicon.defaultGraphUri)d.oid=this.lexicon.defaultGraphOid;else{var e=this.normalizeTerm(d,b,!1);if(e!=null)d.oid=e;else return null}}return!0};u.QueryEngine.prototype.normalizeQuad=function(a,b,c){var d=null,e=null,f=d=null,g;if(a.graph==null)f=0;else if(g=this.normalizeTerm(a.graph,b,c),g!=null)f=g,c===!0&&a.graph.token!="var"&&this.lexicon.registerGraph(g);else return null;g=this.normalizeTerm(a.subject,
b,c);if(g!=null)d=g;else return null;g=this.normalizeTerm(a.predicate,b,c);if(g!=null)e=g;else return null;g=this.normalizeTerm(a.object,b,c);return g==null?null:{subject:d,predicate:e,object:g,graph:f}};u.QueryEngine.prototype.quadCost=function(a,b){var c=null,d=null,e=null,f=null,f=a.graph==null?this.lexicon.oidCounter/4:this.termCost(a.graph,b),c=this.termCost(a.subject,b),d=this.termCost(a.predicate,b),e=this.termCost(a.object,b);return f+c+d+e};u.QueryEngine.prototype.denormalizeBindingsList=
function(a,b){for(var c=[],d=0;d<a.length;d++){var e=this.denormalizeBindings(a[d],b);c.push(e)}return c};u.QueryEngine.prototype.copyDenormalizedBindings=function(a,b){for(var c=[],d=0;d<a.length;d++){for(var e={},f=a[d],g=n.keys(f),j=0;j<g.length;j++){var k=f[g[j]];if(k==null)e[g[j]]=null;else if(typeof k==="object")e[g[j]]=k;else{var m=b[k];m==null&&(m=this.lexicon.retrieve(k),b[k]=m);e[g[j]]=m}}c.push(e)}return c};u.QueryEngine.prototype.denormalizeBindings=function(a,b){for(var c=n.keys(a),d=
b.outCache,e=0;e<c.length;e++){var f=a[c[e]];if(f==null)a[c[e]]=null;else if(d[f]!=null)a[c[e]]=d[f];else{var g=this.lexicon.retrieve(f);a[c[e]]=g;g.token==="blank"&&(b.blanks[g.value]=f)}}return a};u.QueryEngine.prototype.startGraphModification=function(){this.callbacksBackend.startGraphModification()};u.QueryEngine.prototype.endGraphModification=function(){this.callbacksBackend.endGraphModification(function(){})};u.QueryEngine.prototype.execute=function(a,b,c,d){var e=a;typeof a==="string"&&(a=
n.normalizeUnicodeLiterals(a),e=this.abstractQueryTree.parseQueryString(a));if(e==null)b(!1,"Error parsing query string");else if(e.token==="query"&&e.kind=="update"){var f=this;this.executeUpdate(e,function(a,c){f.lexicon.updateAfterWrite&&f.lexicon.updateAfterWrite();a||f.callbacksBackend.cancelGraphModification();b(a,c)})}else e.token==="query"&&e.kind=="query"&&this.executeQuery(e,b,c,d)};u.QueryEngine.prototype.executeQuery=function(a,b,c,d){var e=a.units,f=this,g={blanks:{},outCache:{}};this.registerNsInEnvironment(a.prologue,
g);a=e[0];e[0].pattern.kind!=="BGP"&&(a=f.abstractQueryTree.parseExecutableUnit(e[0]));a.kind==="select"&&this.executeSelect(a,g,c,d,function(a,c){a?typeof c==="object"&&c.denorm===!0?b(!0,c.bindings):(c=f.denormalizeBindingsList(c,g),c!=null?b(!0,c):b(!1,c)):b(!1,c)})};u.QueryEngine.prototype.executeSelect=function(a,b,c,d,e){if(a.kind==="select"||a.kind==="modify"){var f=a.projection,g=a.dataset,j=a.modifier,k=a.limit,m=a.offset,i=a.order;if(c!=null||d!=null)g.implicit=c||[],g.named=d||[];g.implicit!=
null&&g.implicit.length===0&&g.named!=null&&g.named.length===0&&g.implicit.push(this.lexicon.defaultGraphUriTerm);if(this.normalizeDatasets(g.implicit.concat(g.named),b)!=null)if(d=this.executeSelectUnit(f,g,a.pattern,b),d!=null){if(a.group!=null&&a.group===""){for(var C=!1,c=0;c<a.projection.length;c++)if(a.projection[c].expression!=null&&a.projection[c].expression.expressionType==="aggregate"){C=!0;break}if(C===!0)a.group="singleGroup"}if(a.group&&a.group!="")if(this.checkGroupSemantics(a.group,
f)){k=this.groupSolution(d,a.group,g,b);m=[];for(c=0;c<k.length;c++)j=this.aggregateBindings(f,k[c],g,b),m.push(j);e(!0,{bindings:m,denorm:!0})}else e(!1,"Incompatible Group and Projection variables");else b=this.applyOrderBy(i,d,g,b),f=this.projectBindings(f,b,g),f=this.applyModifier(j,f),g=this.removeDefaultGraphBindings(this.applyLimitOffset(m,k,f),g),e(!0,g)}else e(!1,d);else e(!1,"Error normalizing datasets")}else e(!1,"Cannot execute "+a.kind+" query as a select query")};u.QueryEngine.prototype.groupSolution=
function(a,b,c,d){var e=[],h=[],g=!1;if(b==="singleGroup")return[a];else{for(var j=0;j<a.length;j++){for(var k=a[j],m=!0,i=0;i<b.length;i++){var C=b[i],l=null;if(C.token==="var")l=C.value,g==!1&&e.push(l);else if(C.token==="aliased_expression")if(l=C.alias.value,g==!1&&e.push(l),C.expression.primaryexpression==="var")k[C.alias.value]=k[C.expression.value.value];else if(l=this.copyDenormalizedBindings([k],d.outCache),l=f.runFilter(C.expression,l[0],this,c,d),f.isEbvError(l))m=!1;else{if(l.value!=null)l.value=
""+l.value;k[C.alias.value]=l}else l=this.copyDenormalizedBindings([k],d.outCache),l=f.runFilter(C,l[0],this,d),f.isEbvError(l)?m=!1:(k["groupCondition"+env._i]=l,l="groupCondition"+env._i,g==!1&&e.push(l))}g==!1&&(g=!0);m===!0&&h.push(k)}a={};for(j=0;j<h.length;j++){b=h[j];c="";for(i=0;i<e.length;i++)d=b[e[i]],c+=typeof d==="object"?d.value:d;a[c]==null?a[c]=[b]:a[c].push(b)}var e=[],n;for(n in a)e.push(a[n]);return e}};u.QueryEngine.prototype.executeSelectUnit=function(a,b,c,d){return c.kind===
"BGP"?this.executeAndBGP(a,b,c,d):c.kind==="UNION"?this.executeUNION(a,b,c.value,d):c.kind==="JOIN"?this.executeJOIN(a,b,c,d):c.kind==="LEFT_JOIN"?this.executeLEFT_JOIN(a,b,c,d):c.kind==="FILTER"?(a=this.executeSelectUnit(a,b,c.value,d),a!=null?a=f.checkFilters(c,a,!1,b,d,this):[]):c.kind==="EMPTY_PATTERN"?[]:c.kind==="ZERO_OR_MORE_PATH"||c.kind==="ONE_OR_MORE_PATH"?this.executeZeroOrMorePath(c,b,d):(console.log("Cannot execute query pattern "+c.kind+". Not implemented yet."),null)};u.QueryEngine.prototype.executeZeroOrMorePath=
function(a,b,c){var d=[];a.x.token==="var"&&d.push({token:"variable",kind:"var",value:a.x.value});a.y.token==="var"&&d.push({token:"variable",kind:"var",value:a.y.value});d.length===0&&d.push({token:"variable",kind:"*"});if(a.x.token==="var"&&a.y.token==="var"){var e=this.executeAndBGP(d,b,a.path,c),f={},d=[],g,j,k,m,i=a.x.value;j=a.x;for(var l=a.path,o=0;o<e.length;o++)if(g=e[o][i],f[g]==null){m=this.lexicon.retrieve(g);a.x=m;a.path=this.abstractQueryTree.replace(l,j,m,c);l=n.clone(a.path);j=this.executeZeroOrMorePath(a,
b,c);for(var q=0;q<j.length;q++)k=j[q],k[i]=g,d.push(k);j=m}return d}else if(a.x.token!=="var"&&a.y.token==="var"){f={};g=!0;m=[];for(i=[];g==!0||m.length!==0;){g===!0?(e=this.executeAndBGP(d,b,a.path,c),j=a.x,g=!1):(l=this.lexicon.retrieve(m.pop()),e=a.path,e=this.abstractQueryTree.replace(e,j,l,c),e=this.executeAndBGP(d,b,e,c),j=l);for(o=0;o<e.length;o++)l=e[o][a.y.value],f[l]!==!0&&(k={},k[a.y.value]=l,i.push(k),f[l]=!0,m.push(l))}return i}else throw"Kind of path not supported!";};u.QueryEngine.prototype.executeUNION=
function(a,b,c,d){var e=c[0],h=c[1],g=null,j=null;if(c.length!=2)throw"SPARQL algebra UNION with more than two components";g=this.executeSelectUnit(a,b,e,d);if(g==null)return null;j=this.executeSelectUnit(a,b,h,d);if(j==null)return null;a=J.unionBindings(g,j);return a=f.checkFilters(c,a,!1,b,d,this)};u.QueryEngine.prototype.executeAndBGP=function(a,b,c,d){a=J.executeAndBGPsDPSize(c.value,b,this,d);return a!=null?f.checkFilters(c,a,!1,b,d,this):null};u.QueryEngine.prototype.executeLEFT_JOIN=function(a,
b,c,d){var e=c.rvalue,h=null,g=null,h=this.executeSelectUnit(a,b,c.lvalue,d);if(h==null)return null;g=this.executeSelectUnit(a,b,e,d);if(g==null)return null;a=J.leftOuterJoinBindings(h,g);b=f.checkFilters(c,a,!0,b,d,this);if(h.length>1&&g.length>1){var c=[],d={},j;for(j in h[0])d[j]=!0;for(j in g[0])d[j]!=!0&&c.push(j);h=[];g={};for(d=0;d<b.length;d++)if(b[d].__nullify__===!0){for(e=0;e<c.length;e++)b[d].bindings[c[e]]=null;e=[];a=[];for(j in b[d].bindings)b[d].bindings[j]!=null&&(e.push(j+b[d].bindings[j]),
e.sort(),a.push(e.join("")));if(g[e.join("")]==null){for(e=0;e<a.length;e++)g[a[e]]=!0;h.push(b[d].bindings)}}else for(j in h.push(b[d]),e=[],b[d])e.push(j+b[d][j]),e.sort(),g[e.join("")]=!0;return h}else return b};u.QueryEngine.prototype.executeJOIN=function(a,b,c,d){var e=c.lvalue,h=c.rvalue,g=null,j=null,g=this.executeSelectUnit(a,b,e,d);if(g==null)return null;j=this.executeSelectUnit(a,b,h,d);if(j==null)return null;a=null;if(g.length===0||j.length===0)a=[];else{var a={},k=[],m;for(m in g[0])a[m]=
!1;for(m in j[0])a[m]===!1&&k.push(m);a=k.length==0?J.joinBindings(g,j):this.abstractQueryTree.treeWithUnion(e)||this.abstractQueryTree.treeWithUnion(h)?J.joinBindings(g,j):J.joinBindings2(k,g,j)}return a=f.checkFilters(c,a,!1,b,d,this)};u.QueryEngine.prototype.rangeQuery=function(a,b){var c=this.normalizeQuad(a,b,!1);return c!=null?(c=this.backend.range(new F.Pattern(c)),c==null||c.length==0?[]:c):(console.log("ERROR normalizing quad"),null)};u.QueryEngine.prototype.executeUpdate=function(a,b){var c=
a.units,d={blanks:{},outCache:{}};this.registerNsInEnvironment(a.prologue,d);for(var e=0;e<c.length;e++){var f=this.abstractQueryTree.parseExecutableUnit(c[e]);if(f.kind==="insertdata"){for(var g=0;g<f.quads.length;g++){var j=f.quads[g];if(this._executeQuadInsert(j,d)!==!0)return b(!1,error)}b(!0)}else if(f.kind==="deletedata"){for(g=0;g<f.quads.length;g++)j=f.quads[g],this._executeQuadDelete(j,d);b(!0)}else if(f.kind==="modify")this._executeModifyQuery(f,d,b);else if(f.kind==="create")b(!0);else throw Error("not supported execution unit");
}};u.QueryEngine.prototype.batchLoad=function(a,b){for(var c=null,d=null,e=null,f=null,g=0,j=!0,k={},m,i,l=0;l<a.length;l++){i=a[l];if(i.subject.uri||i.subject.token==="uri"){if(m=this.lexicon.registerUri(i.subject.uri||i.subject.value),i.subject.uri!=null)i.subject={token:"uri",value:i.subject.uri},delete i.subject.uri}else if(i.subject.literal||i.subject.token==="literal"){if(m=this.lexicon.registerLiteral(i.subject.literal||i.subject.value),i.subject.literal!=null)i.subject=this.lexicon.parseLiteral(i.subject.literal),
delete i.subject.literal}else if(m=k[i.subject.blank||i.subject.value],m==null&&(m=this.lexicon.registerBlank(i.subject.blank||i.subject.value),k[i.subject.blank||i.subject.value]=m),i.subject.token==null)i.subject.token="blank",i.subject.value=i.subject.blank,delete i.subject.blank;c=m;if(i.predicate.uri||i.predicate.token==="uri"){if(m=this.lexicon.registerUri(i.predicate.uri||i.predicate.value),i.predicate.uri!=null)i.predicate={token:"uri",value:i.predicate.uri},delete i.subject.uri}else if(i.predicate.literal||
i.predicate.token==="literal"){if(m=this.lexicon.registerLiteral(i.predicate.literal||i.predicate.value),i.predicate.literal!=null)i.predicate=this.lexicon.parseLiteral(i.predicate.literal),delete i.predicate.literal}else if(m=k[i.predicate.blank||i.predicate.value],m==null&&(m=this.lexicon.registerBlank(i.predicate.blank||i.predicate.value),k[i.predicate.blank||i.predicate.value]=m),i.predicate.token==null)i.predicate.token="blank",i.predicate.value=i.predicate.blank,delete i.predicate.blank;d=m;
if(i.object.uri||i.object.token==="uri"){if(m=this.lexicon.registerUri(i.object.uri||i.object.value),i.object.uri!=null)i.object={token:"uri",value:i.object.uri},delete i.subject.uri}else if(i.object.literal||i.object.token==="literal"){if(i.object.token==="literal")i.object.value=i.object.type!=null?'"'+i.object.value+'"^^<'+i.object.type+">":i.object.lang!=null?'"'+i.object.value+'"@'+i.object.lang:'"'+i.object.value+'"';m=this.lexicon.registerLiteral(i.object.literal||i.object.value);if(i.object.literal!=
null)i.object=this.lexicon.parseLiteral(i.object.literal),delete i.object.literal}else if(m=k[i.object.blank||i.object.value],m==null&&(m=this.lexicon.registerBlank(i.object.blank||i.object.value),k[i.object.blank||i.object.value]=m),i.object.token==null)i.object.token="blank",i.object.value=i.object.blank,delete i.object.blank;e=m;if(i.graph.uri||i.graph.token==="uri"){m=this.lexicon.registerUri(i.graph.uri||i.graph.value);if(i.graph.uri!=null)i.graph={token:"uri",value:i.graph.uri},delete i.subject.uri;
this.lexicon.registerGraph(m)}else if(i.graph.literal||i.graph.token==="literal"){if(m=this.lexicon.registerLiteral(i.graph.literal||i.graph.value),i.predicate.literal!=null)i.predicate=this.lexicon.parseLiteral(i.predicate.literal),delete i.predicate.literal}else if(m=k[i.graph.blank||i.graph.value],m==null&&(m=this.lexicon.registerBlank(i.graph.blank||i.graph.value),k[i.graph.blank||i.graph.value]=m),i.graph.token==null)i.graph.token="blank",i.graph.value=i.graph.blank,delete i.graph.blank;f=m;
m=i;i={subject:c,predicate:d,object:e,graph:f};c=new F.NodeKey(i);d=this.backend.search(c);if(!d)if(d=this.backend.index(c),d==!0)this.eventsOnBatchLoad&&this.callbacksBackend.nextGraphModification(s.added,[m,i]),g+=1;else{j=!1;break}}this.lexicon.updateAfterWrite!=null&&this.lexicon.updateAfterWrite();j?b&&b(!0,g):b&&b(!1,null);return j?g:null};u.QueryEngine.prototype.computeCosts=function(a,b){for(var c=0;c<a.length;c++)a[c]._cost=this.quadCost(a[c],b);return a};u.QueryEngine.prototype._executeModifyQuery=
function(a,b,c){var d=this,e=!0,f=null,g=["subject","predicate","object","graph"];a.insert=a.insert==null?[]:a.insert;a["delete"]=a["delete"]==null?[]:a["delete"];n.seq(function(c){var g=[],m=[];a["with"]!=null&&g.push(a["with"]);if(a.using!=null)for(var m=[],i=0;i<a.using.length;i++){var l=a.using[i];l.kind==="named"?m.push(l.uri):g.push(l.uri)}a.dataset={};a.projection=[{token:"variable",kind:"*"}];d.executeSelect(a,b,g,m,function(a,g){a?(g=d.denormalizeBindingsList(g,b),g!=null?f=g:e=!1):e=!1;
return c()})},function(c){var k=a["with"];if(e){for(var m=[],i=0;i<a["delete"].length;i++)for(var l=a["delete"][i],n=0;n<f.length;n++){for(var q={},o=f[n],s=0;s<g.length;s++){var r=g[s];r=="graph"&&l[r]==null?q.graph=k:q[r]=l[r].token==="var"?o[l[r].value]:l[r]}m.push(q)}for(n=0;n<m.length;n++)q=m[n],d._executeQuadDelete(q,b)}c()},function(c){var k=a["with"];if(e){for(var m=[],i=0;i<a.insert.length;i++)for(var l=a.insert[i],n=0;n<f.length;n++){for(var q={},o=f[n],s=0;s<g.length;s++){var r=g[s];r==
"graph"&&l[r]==null?q.graph=k:q[r]=l[r].token==="var"?o[l[r].value]:l[r]}m.push(q)}for(i=0;i<m.length;i++)q=m[i],d._executeQuadInsert(q,b)}c()})(function(){c(e)})};u.QueryEngine.prototype._executeQuadInsert=function(a,b){var c=this.normalizeQuad(a,b,!0);if(c!=null){var d=new F.NodeKey(c),e=this.backend.search(d);return e?e:(e=this.backend.index(d),e==!0?(this.callbacksBackend.nextGraphModification(s.added,[a,c]),!0):(console.log("ERROR inserting quad"),!1))}else return console.log("ERROR normalizing quad"),
!1};u.QueryEngine.prototype._executeQuadDelete=function(a,b){var c=this.normalizeQuad(a,b,!1);if(c!=null){var d=new F.NodeKey(c);this.backend["delete"](d);return this.lexicon.unregister(a,d)==!0?(this.callbacksBackend.nextGraphModification(s.deleted,[a,c]),!0):(console.log("ERROR unregistering quad"),!1)}else return console.log("ERROR normalizing quad"),!1};u.QueryEngine.prototype.checkGroupSemantics=function(a,b){if(a==="singleGroup")return!0;for(var c={},d=0;d<a.length;d++){var e=a[d];e.token===
"var"?c[e.value]=!0:e.token==="aliased_expression"&&(c[e.alias.value]=!0)}for(d=0;d<b.length;d++)if(e=b[d],e.kind==="var"){if(c[e.value.value]==null)return!1}else if(e.kind==="aliased"&&e.expression&&e.expression.primaryexpression==="var"&&c[e.expression.value.value]==null)return!1;return!0};u.QueryEngine.prototype.registerDefaultNamespace=function(a,b){this.defaultPrefixes[a]=b};var s={ANYTHING:{token:"var",value:"_"},added:"added",deleted:"deleted",eventsFlushed:"eventsFlushed",CallbacksBackend:function(a){this.aqt=
new y.AbstractQueryTree;this.engine=a;this.indexMap={};this.observersMap={};this.queriesIndexMap={};this.emptyNotificationsMap={};this.queriesList=[];this.pendingQueries=[];this.matchedQueries=[];this.updateInProgress=null;this.indices=["SPOG","GP","OGS","POG","GSP","OS"];this.componentOrders={SPOG:["subject","predicate","object","graph"],GP:["graph","predicate","subject","object"],OGS:["object","graph","subject","predicate"],POG:["predicate","object","graph","subject"],GSP:["graph","subject","predicate",
"object"],OS:["object","subject","predicate","graph"]};this.callbackCounter=0;this.callbacksMap={};this.callbacksInverseMap={};this.queryCounter=0;this.queriesMap={};this.queriesCallbacksMap={};this.queriesInverseMap={};for(a=0;a<this.indices.length;a++){var b=this.indices[a];this.indexMap[b]={};this.queriesIndexMap[b]={}}}};s.CallbacksBackend.prototype.startGraphModification=function(){this.pendingQueries=[].concat(this.queriesList);this.matchedQueries=[];if(this.updateInProgress==null)this.updateInProgress=
{added:[],deleted:[]}};s.CallbacksBackend.prototype.nextGraphModification=function(a,b){this.updateInProgress&&this.updateInProgress[a].push(b)};s.CallbacksBackend.prototype.endGraphModification=function(a){var b=this;if(this.updateInProgress!=null){var c=b.updateInProgress;b.updateInProgress=null;this.sendNotification(s.deleted,c[s.deleted],function(){b.sendNotification(s.added,c[s.added],function(){b.sendEmptyNotification(s.eventsFlushed,null,function(){b.dispatchQueries(function(){a(!0)})})})})}else a(!0)};
s.CallbacksBackend.prototype.cancelGraphModification=function(){this.updateInProgress=null};s.CallbacksBackend.prototype.sendNotification=function(a,b,c){for(var d={},e=0;e<b.length;e++){var f=b[e],g;for(g in this.indexMap){var j=this.indexMap[g],k=this.componentOrders[g];this._searchCallbacksInIndex(j,k,a,f,d);this.pendingQueries.length!=0&&(j=this.queriesIndexMap[g],this._searchQueriesInIndex(j,k,f))}}this.dispatchNotifications(d);c!=null&&c(!0)};s.CallbacksBackend.prototype.sendEmptyNotification=
function(a,b,c){for(var d=this.emptyNotificationsMap[a]||[],e=0;e<d.length;e++)d[e](a,b);c()};s.CallbacksBackend.prototype.dispatchNotifications=function(a){for(var b in a){var c=this.callbacksMap[b],d=a[b][s.deleted];if(d!=null)try{c(s.deleted,d)}catch(e){}for(var f in a[b])if(f!=s.deleted)try{c(f,a[b][f])}catch(g){}}};s.CallbacksBackend.prototype._searchCallbacksInIndex=function(a,b,c,d,e){for(var f=d[1],d=d[0],g=0;g<b.length+1;g++){for(var j=a._||[],k=[],m=0;m<j.length;m++){var i=j[m];this.callbacksMap[i]!=
null&&(e[i]=e[i]||{},e[i][c]=e[i][c]||[],e[i][c].push(d),k.push(i))}a._=k;j=b[g];if(a[""+f[j]]!=null)a=a[""+f[j]];else break}};s.CallbacksBackend.prototype.subscribeEmpty=function(a,b){var c=this.emptyNotificationsMap[a]||[];c.push(b);this.emptyNotificationsMap[a]=c};s.CallbacksBackend.prototype.unsubscribeEmpty=function(a,b){var c=this.emptyNotificationsMap[a];c!=null&&(c=n.remove(c,b));this.emptyNotificationsMap[a]=c};s.CallbacksBackend.prototype.subscribe=function(a,b,c,d,e,f){a=this._tokenizeComponents(a,
b,c,d);b={blanks:{},outCache:{}};this.engine.registerNsInEnvironment(null,b);a=this.engine.normalizeQuad(a,b,!0);c=this._indexForPattern(new F.Pattern(a));b=this.componentOrders[c];c=this.indexMap[c];for(d=0;d<b.length;d++){var g=a[b[d]];if(g==="_"){c._==null&&(c._=[]);this.callbackCounter++;c._.push(this.callbackCounter);this.callbacksMap[this.callbackCounter]=e;this.callbacksInverseMap[e]=this.callbackCounter;break}else d===b.length-1?(c[g]=c[g]||{_:[]},this.callbackCounter++,c[g]._.push(this.callbackCounter),
this.callbacksMap[this.callbackCounter]=e,this.callbacksInverseMap[e]=this.callbackCounter):(c[g]=c[g]||{},c=c[g])}f!=null&&f(!0)};s.CallbacksBackend.prototype.unsubscribe=function(a){var b=this.callbacksInverseMap[a];b!=null&&(delete this.callbacksInverseMap[a],delete this.callbacksMap[b])};s.CallbacksBackend.prototype._tokenizeComponents=function(a,b,c,d){var e={};e.subject=a==null?s.ANYTHING:a.indexOf("_:")==0?{token:"blank",value:a}:{token:"uri",value:a};e.predicate=b==null?s.ANYTHING:{token:"uri",
value:b};e.object=c==null?s.ANYTHING:{token:"uri",value:c};e.graph=d==null?s.ANYTHING:{token:"uri",value:d};return e};s.CallbacksBackend.prototype._indexForPattern=function(a){for(var a=a.indexKey,b=this.indices,c=0;c<b.length;c++)for(var d=b[c],e=this.componentOrders[d],f=0;f<e.length;f++){if(n.include(a,e[f])===!1)break;if(f==a.length-1)return d}return"SPOG"};s.CallbacksBackend.prototype.observeQuery=function(a,b,c,d){var e=this.aqt.collectBasicTriples(this.aqt.parseSelect(JSON.parse(JSON.stringify(b.units[0])))),
f={blanks:{},outCache:{}};this.engine.registerNsInEnvironment(null,f);var g,j,k,m=this.queryCounter;this.queryCounter++;this.queriesMap[m]=b;this.queriesInverseMap[a]=m;this.queriesList.push(m);this.queriesCallbacksMap[m]=c;for(a=0;a<e.length;a++){j=e[a];if(j.graph==null)j.graph=this.engine.lexicon.defaultGraphUriTerm;j=this.engine.normalizeQuad(j,f,!0);g=new F.Pattern(j);k=this._indexForPattern(g);g=this.componentOrders[k];k=this.queriesIndexMap[k];for(var i=0;i<g.length;i++){var l=j[g[i]];if(typeof l===
"string"){k._==null&&(k._=[]);k._.push(m);break}else i===g.length-1?(k[l]=k[l]||{_:[]},k[l]._.push(m)):(k[l]=k[l]||{},k=k[l])}}this.engine.execute(b,function(a,b){a?c(b):console.log("ERROR in query callback "+b)});d!=null&&d()};s.CallbacksBackend.prototype.addQueryToObserver=function(a,b){var c=this.aqt.collectBasicTriples(this.aqt.parseSelect(JSON.parse(JSON.stringify(b.units[0])))),d={blanks:{},outCache:{}};this.engine.registerNsInEnvironment(null,d);for(var e,f,g,j=this.queriesInverseMap[a],k=
0;k<c.length;k++){f=c[k];if(f.graph==null)f.graph=this.engine.lexicon.defaultGraphUriTerm;f=this.engine.normalizeQuad(f,d,!0);e=new F.Pattern(f);g=this._indexForPattern(e);e=this.componentOrders[g];g=this.queriesIndexMap[g];for(var m=0;m<e.length;m++){var i=f[e[m]];if(typeof i==="string"){g._==null&&(g._=[]);g._.push(j);break}else m===e.length-1?(g[i]=g[i]||{_:[]},g[i]._.push(j)):(g[i]=g[i]||{},g=g[i])}}};s.CallbacksBackend.prototype.stopObservingQuery=function(a){var b=this.queriesInverseMap[a];
if(b!=null)delete this.queriesInverseMap[a],delete this.queriesMap[b],this.queriesList=n.remove(this.queriesList,b)};s.CallbacksBackend.prototype._searchQueriesInIndex=function(a,b,c){for(var c=c[1],d=0;d<b.length+1;d++){for(var e=a._||[],f=[],g=0;g<e.length;g++){var j=e[g];n.include(this.pendingQueries,j)&&(n.remove(this.pendingQueries,j),this.matchedQueries.push(j));this.queriesMap[j]!=null&&f.push(j)}a._=f;e=b[d];if(a[""+c[e]]!=null)a=a[""+c[e]];else break}};s.CallbacksBackend.prototype.dispatchQueries=
function(a){var b=this,c,d,e,f,g={};n.repeat(0,this.matchedQueries.length,function(a,k){c=arguments.callee;e=b.matchedQueries[k._i];g[e]==null?(g[e]=!0,d=b.queriesMap[e],f=b.queriesCallbacksMap[e],n.recur(function(){b.engine.execute(d,function(b,d){if(b)try{f(d)}catch(e){}a(c,k)})})):a(c,k)},function(){a()})};var l={};n.oldNormalizeUnicodeLiterals=n.normalizeUnicodeLiterals;n.normalizeUnicodeLiterals=function(a){return typeof a==="string"?n.oldNormalizeUnicodeLiterals(a):a};l.base_uri="http://rdfstore-js.org/micrographql/graph#";
l.prefix="mql";l.NIL="http://www.w3.org/1999/02/22-rdf-syntax-ns#nil";l.counter=0;l.filterNames={$eq:!0,$lt:!0,$gt:!0,$neq:!0,$lteq:!0,$gteq:!0,$not:!0,$like:!0,$and:!0,$or:!0};l.newContext=function(a){return{variables:[],isQuery:a,quads:[],varsMap:{},filtersMap:{},inverseMap:{},nodes:!0,optionals:[]}};l.isFilter=function(a){if(a===null||typeof a!=="object"||a.constructor===Array)return!1;else for(var b in a)return l.filterNames[b]||!1};l.parseFilter=function(a,b,c){var d,e,f={token:"expression",
expressionType:"atomic",primaryexpression:"var",value:b};if(typeof c==="object"&&c.constructor!==Date)for(var g in c){d=g;e=c[g];break}if(d==="$eq")return{token:"expression",expressionType:"relationalexpression",operator:"=",op1:f,op2:l.parseFilter(a,b,e)};else if(d==="$lt")return{token:"expression",expressionType:"relationalexpression",operator:"<",op1:f,op2:l.parseFilter(a,b,e)};else if(d==="$gt")return{token:"expression",expressionType:"relationalexpression",operator:">",op1:f,op2:l.parseFilter(a,
b,e)};else if(d==="$neq")return{token:"expression",expressionType:"relationalexpression",operator:"!=",op1:f,op2:l.parseFilter(a,b,e)};else if(d==="$lteq")return{token:"expression",expressionType:"relationalexpression",operator:"<=",op1:f,op2:l.parseFilter(a,b,e)};else if(d==="$gteq")return{token:"expression",expressionType:"relationalexpression",operator:">=",op1:f,op2:l.parseFilter(a,b,e)};else if(d==="$not")return{token:"expression",expressionType:"unaryexpression",unaryexpression:"!",expression:l.parseFilter(a,
b,e)};else if(d==="$like")return{token:"expression",expressionType:"regex",text:f,pattern:typeof e==="object"&&e.constructor===RegExp?l.parseFilter(a,b,e.source):l.parseFilter(a,b,e)};else if(d==="$and"){if(typeof e!=="object"||e.constructor!==Array)e=[e];c=[];for(d=0;d<e.length;d++)c.push(l.parseFilter(a,b,e[d]));return{token:"expression",expressionType:"conditionaland",operands:c}}else if(d==="$or"){if(typeof e!=="object"||e.constructor!==Array)e=[e];c=[];for(d=0;d<e.length;d++)c.push(l.parseFilter(a,
b,e[d]));return{token:"expression",expressionType:"conditionalor",operands:c}}else return typeof c==="object"&&c.$id!=null?{token:"expression",expressionType:"irireforfunction",iriref:l.parseURI(l.isUri(c.$id)?c.$id:l.base_uri+c.$id)}:(a=l.parseLiteral(c),a.type&&a.type==="http://www.w3.org/2001/XMLSchema#float"?{token:"expression",expressionType:"atomic",primaryexpression:"numericliteral",value:a}:a.type&&a.type==="http://www.w3.org/2001/XMLSchema#boolean"?{token:"expression",expressionType:"atomic",
primaryexpression:"booleanliteral",value:a}:{token:"expression",expressionType:"atomic",primaryexpression:"rdfliteral",value:a})};l.nextVariable=function(){var a="id__mg__"+l.counter;l.counter++;return a};l.isUri=function(a){return a&&a.match(/[a-z]+:\//)};l.parseURI=function(a){!l.isUri(a)&&a==null&&(a=l.base_uri+"object"+l.counter,l.counter++);return{token:"uri",value:a,suffix:null,prefix:null}};l.parsePath=function(a){for(var b=a.split("/"),c=[],d,e=0;e<b.length;e++)a=b[e],d=null,a.indexOf("*")===
a.length-1?(d="*",a=a.substring(0,a.length-1)):a.indexOf("?")===a.length-1?(d="?",a=a.substring(0,a.length-1)):a.indexOf("+")===a.length-1&&(d="+",a=a.substring(0,a.length-1)),a=l.parseURI(a),d!=null&&(a={token:"path",kind:"element",value:a,modifier:d}),c.push(a);return{token:"path",kind:"sequence",value:c}};l.parseLiteral=function(a){if(a===null)return{token:"uri",value:l.NIL};else if(typeof a==="string")return{token:"literal",value:a,lang:null,type:null};else if(typeof a==="boolean")return{token:"literal",
value:""+a,type:"http://www.w3.org/2001/XMLSchema#boolean",lang:null};else if(typeof a==="number")return{token:"literal",value:""+a,type:"http://www.w3.org/2001/XMLSchema#float",lang:null};else if(typeof a==="object"&&a.constructor===Date)return{token:"literal",value:n.iso8601(a),type:"http://www.w3.org/2001/XMLSchema#dateTime",lang:null};else throw"Error parsing object value: "+a;};l.parseJSON=function(a,b,c,d){var e=l.newContext(!1),a=l.parseBGP(a,e,!0,b,c,d);return e.quads.concat(a[1])};l.parseBGP=
function(a,b,c,d,e,f){var g=null,j=[],k=l.nextVariable(),m=0;if(a.$id!=null||!b.isQuery){if(a.$id==null)g=l.parseURI(null),a.$id==null&&(a.$id="object"+(l.counter-1));else if(a.$id.token==="var"?(g=a.$id,!b.nodes&&g.value.indexOf("id__mg__")==-1&&b.variables.push(g)):g=l.isUri(a.$id)?l.parseURI(a.$id):l.parseURI(l.base_uri+a.$id),b.isQuery&&g.token!=="var"){var i=k,n={token:"var",value:i},o=l.parseFilter(q,n,{$eq:{$id:a.$id}});b.variables.push(n);b.varsMap[i]=k;b.filtersMap[i]=o;g=n}a.$from==null&&
e!=null&&(a.$from=e);a.$state==null&&(f==="created"||f==="loaded")?a.$state=f:a.$state==null&&f==="dirty"?a.$state="created":a.$state==="loaded"&&f==="dirty"&&(a.$state="dirty");b.varsMap[k]=g.value}else g={token:"var",value:k},b.nodes&&b.variables.push(g),b.varsMap[k]=k;if(c)b.topLevel=k;var q,s,w=!0,r;for(r in a)if(a[r]!==void 0&&r!=="$id")if(w=!1,r.indexOf("$in")==r.length-3&&r.indexOf("$in")!==-1){q=a[r];s=r.split("$in")[0];typeof a[r]==="string"&&(q={$id:a[r]});a[r]=q;var v,u;g.token==="uri"?
v=u=a.$id:(u=g,v=u.value);var t;t=q.constructor!==Array?[q]:q;for(i=0;i<t.length;i++)q=t[i],q[s]={$id:u},n=l.parseBGP(q,b,!1,d,e,f),o=b.inverseMap[v]||{},b.inverseMap[v]=o,q=o[s]||[],o[s]=q,n[0].token==="uri"?q.push(n[0].value.split(l.base_uri)[1]):q.push(n[0].value),b.quads=b.quads.concat(n[1])}else if(i=r,r.indexOf("$opt")===r.length-4&&(r=r.split("$opt")[0]),r==="$type"&&(i="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),r==="$from"&&(i=l.base_uri+"from"),r==="$state"&&(i=l.base_uri+"state"),
q=r.indexOf(":")===-1&&r.indexOf("/")!==-1||r.indexOf("*")===r.length-1||r.indexOf("?")===r.length-1||r.indexOf("+")===r.length-1?l.parsePath(i):r.indexOf("$path")!=-1?l.parsePath(i.split("$path")[0]):l.parseURI(i),l.isFilter(a[r]))i=k+"f"+m,m++,n={token:"var",value:i},o=l.parseFilter(q,n,a[r]),b.varsMap[i]=k,b.filtersMap[i]=o,n={subject:g,predicate:q,object:n},d!=null&&(n.graph=d),j.push(n);else if(a[r]!==null&&typeof a[r]==="object"&&a[r].token==="var")o=a[r],b.varsMap[a]==null&&b.nodes?(b.varsMap[a]=
!0,b.variables.push(o)):b.varsMap[o.value]==null&&!b.nodes&&(b.varsMap[a]=!0,b.varsMap[o.value]=!0,b.variables.push(o)),n={subject:g,predicate:q,object:o},d!=null&&(n.graph=d),j.push(n);else if(typeof a[r]==="string"||a[r]===null||typeof a[r]==="object"&&a[r].constructor===Date||typeof a[r]==="number"||typeof a[r]==="boolean")o=l.parseLiteral(a[r]),n={subject:g,predicate:q,object:o},d!=null&&(n.graph=d),j.push(n);else if(a[r].constructor==Array)for(i=0;i<a[r].length;i++)typeof a[r][i]==="object"&&
a[r][i].constructor!==Date?(n=l.parseBGP(a[r][i],b,!1,d,e,f),o=n[0],b.quads=b.quads.concat(n[1])):o=l.parseLiteral(a[r][i]),n={subject:g,predicate:q,object:o},d!=null&&(n.graph=d),j.push(n);else a[r].token==="var"?n={subject:g,predicate:q,object:a[r]}:(n=l.parseBGP(a[r],b,!1,d,e,f),o=n[0],b.quads=b.quads.concat(n[1]),n={subject:g,predicate:q,object:o}),d!=null&&(n.graph=d),j.push(n);w&&c&&(n={subject:g,predicate:{token:"var",value:k+"p"},object:{token:"var",value:k+"o"}},j.push(n));return[g,j]};l.singleNodeQuery=
function(a,b,c){return{units:[{modifier:"",group:"",pattern:{filters:[],token:"groupgraphpattern",patterns:[{triplesContext:[{subject:{token:"uri",value:a},predicate:{token:"var",value:b},object:{token:"var",value:c}}],token:"basicgraphpattern"}]},kind:"select",projection:[{value:{value:b,token:"var"},kind:"var",token:"variable"},{value:{value:c,token:"var"},kind:"var",token:"variable"}],dataset:{implicit:[{value:"https://github.com/antoniogarrote/rdfstore-js#default_graph",prefix:null,token:"uri",
suffix:null}],named:[]},token:"executableunit"}],prologue:{token:"prologue",prefixes:[],base:""},kind:"query",token:"query"}};l.literalToJS=function(a){return a=a.type==="http://www.w3.org/2001/XMLSchema#float"?parseFloat(a.value):a.type==="http://www.w3.org/2001/XMLSchema#boolean"?a.value==="true"?!0:!1:a.type==="http://www.w3.org/2001/XMLSchema#dateTime"?n.parseISO8601(a.value):a.value};l.uriToJS=function(a){return a.value.indexOf(l.base_uri)!=-1?{$id:a.value.split(l.base_uri)[1]}:{$id:a.value}};
var v=function(a){this.template=a;this.lastResult=null;this.filter=[];this.endNodePath=this.startNodePath=this.groupPredicate=null};v.prototype.setKind=function(a){this.kind=a;return this};v.prototype.setStore=function(a){this.store=a;return this};v.prototype.setCallback=function(a){this.callback=a;return this};v.prototype.each=function(a){this.filter.push(["each",a]);return this};v.prototype.map=function(a){this.filter.push(["map",a]);return this};v.prototype.reduce=function(a,b){this.filter.push(["reduce",
a,b]);return this};v.prototype.select=function(a){this.filter.push(["select",a]);return this};v.prototype.onError=function(a){this.onErrorCallback=a;return this};v.prototype.limit=function(a){this.limitValue=a;return this};v.prototype.offset=function(a){this.offsetValue=a;return this};v.prototype.groupBy=function(a){this.groupPredicate=typeof a==="string"?function(b){return b[a]}:a;return this};v.prototype.order=function(a){this.sortValue=a;return this};v.prototype.startNode=function(a){this.template.$id=
a.$id;this.startNodePath=l.parseURI(l.isUri(a.$id)?a.$id:l.base_uri+a.$id);return this};v.prototype.endNode=function(a){this.endNodePath=l.parseURI(l.isUri(a.$id)?a.$id:l.base_uri+a.$id);for(var b in this.template)if(b!="$id"){this.template[b]={$id:a.$id};break}return this};v.prototype.all=function(a){a==null&&(a=function(){});this.kind=this.kind==="traverse"?"traverseAll":"all";var b=this;this._executeQuery(function(c){b.lastResult=c;a&&a(b.lastResult)});return this.store};v.prototype.instances=
function(a){a==null&&(a=function(){});var b=this.filter;this.filter=[];var c=this.groupPredicate;this.groupPredicate=null;var d=this;this.all(function(e){if(e&&e.constructor===Array){for(var f=0;f<e.length;f++)d.store.instantiate(e[f]);d.filter=b;d.groupPredicate=c;d.filter.length>0?d._applyResultFilter(e,a):d.groupPredicate!=null?d._groupResults(e,a):a(e)}else e?(this.instantiate(e),a(e)):a(null)});return this.store};v.prototype.first=function(a){var b=this;this.all(function(c){c.length>0?(b.lastResult=
c[0],a&&a(b.lastResult)):(b.lastResult=null,a&&a(null))});return this.store};v.prototype.tuples=function(a){a==null&&(a=function(){});this.kind="tuples";var b=this;this._executeQuery(function(c){if(c){for(var d=0;d<c.length;d++){var e=c[d],f;for(f in e)e[f]=e[f].token==="literal"?l.literalToJS(e[f]):l.uriToJS(e[f])}b.filter.length>0?b._applyResultFilter(c,a):b.groupPredicate!=null?b._groupResults(c,a):a(c)}else a(c)});return this.store};v.prototype.remove=function(a){this.kind="remove";this.store.startGraphModification();
this._executeUpdate(a);this.store.endGraphModification();return this.store};v.prototype.removeNodes=function(a){this.kind="removeNodes";this.store.startGraphModification();this._parseModifyNodes(this.template,a);this.store.endGraphModification();return this.store};v.prototype.bind=function(a){this.store.bind(this._parseQuery(this.template),this,a);return this.store};v.prototype._executeUpdate=function(a){var b;b=this._parseModify(this.template);this.query=b.query;this.varsMap=b.varsMap;this.topLevel=
b.topLevel;this.subject=b.subject;this.inverseMap=b.inverseMap;this.store.execute(this.query,function(b){a&&a(b)})};v.prototype._executeQuery=function(a){var b=this._parseQuery(this.template),c=this;this.query=b.query;this.varsMap=b.varsMap;this.topLevel=b.topLevel;this.subject=b.subject;this.inverseMap=b.inverseMap;var b=this.query.units[0].pattern.patterns[0].triplesContext,d=this.query.units[0],e=[];if(this.sortValue)for(var f=0,g=l.nextVariable(),j=0;j<this.sortValue.length;j++){var k;if(typeof this.sortValue[j]===
"object")for(var m in sortValue[j]){k=m;break}else k=this.sortValue[j];var i;k==="$type"&&(i="http://www.w3.org/1999/02/22-rdf-syntax-ns#type");k==="$from"&&(i=l.base_uri+"from");k==="$state"&&(i=l.base_uri+"state");i=l.parseURI(k);var n=g+"s"+f;f++;n={token:"var",value:n};b.push({subject:this.subject,predicate:i,object:n});e.push({direction:"ASC",expression:{token:"expression",expressionType:"atomic",primaryexpression:"var",value:n}})}if(e.length>0)d.order=e;if(a!=null)this.callback=a;var o=[];this.kind===
"all"?this.store.execute(this.query,function(b,d){l.isUri(c.varsMap[c.topLevel])&&d.length>0&&(d[0][c.topLevel]=c.varsMap[c.topLevel]);if(b)o=v._processQueryResults(d,c.topLevel,c.varsMap,c.inverseMap,c.store,c.offsetValue,c.limitValue),c.offsetValue=null,c.limitValue=null,c.filter.length>0?c._applyResultFilter(o,a):c.groupPredicate!=null?c._groupResults(o,a):a(o);else{if(c.onErrorCallback)c.onError(d);c.callback(null)}}):this.kind==="tuples"?this.store.execute(this.query,function(b,d){if(b)a(d);
else{if(c.onErrorCallback)c.onError(d);c.callback(null)}}):this.kind==="traverseAll"&&this.store.execute(this.query,function(b,d){if(b){for(var e={},g={},f=0;f<d.length;f++){var h=d[f];if(c.startNodePath!=null)h.start=c.startNodePath;if(c.endNodePath!=null)h.end=c.endNodePath;if(h.start.token==="uri"){var i=h.start.value;e[i]==null?c.store.execute(l.singleNodeQuery(i,"p","o"),function(a,b){var c=e[i]||{$id:i.indexOf(l.base_uri)!=-1?i.split(l.base_uri)[1]:i};e[i]=c;v._processSingleNodeResults(i,b,
c,g,e,{});h.start=c}):h.start=e[i]}else h.start=l.literalToJS(h.start);h.end.token==="uri"?(i=h.end.value,e[i]==null?c.store.execute(l.singleNodeQuery(i,"p","o"),function(a,b){var c=e[i]||{};e[i]=c;v._processSingleNodeResults(i,b,c,g,e,{});h.end=c}):h.end=e[i]):h.end=l.literalToJS(h.end)}c.filter.length>0?c._applyResultFilter(d,a):c.groupPredicate!=null?c._groupResults(d,a):c.callback(d)}else{if(c.onErrorCallback)c.onError(d);c.callback(null)}})};v.prototype._parseQuery=function(a){var b=l.newContext(!0);
if(this.kind==="tuples"||this.kind==="traverseAll")b.nodes=!1;var c=l.parseBGP(a,b,!0),a=c[0],d=[{token:"filter",value:{token:"expression",expressionType:"conditionaland",operands:[]}}],e;for(e in b.filtersMap)d[0].value.operands.push(b.filtersMap[e]);e={kind:"select",modifier:"",group:"",token:"executableunit",pattern:{filters:[],token:"groupgraphpattern",patterns:[{token:"basicgraphpattern",triplesContext:b.quads.concat(c[1])}]}};if(d[0].value.operands.length>0)e.pattern.filters=d;d=[];for(c=0;c<
b.variables.length;c++)d.push({kind:"var",token:"variable",value:b.variables[c]});e.projection=d;e.dataset={named:[],implicit:[{suffix:null,prefix:null,token:"uri",value:"https://github.com/antoniogarrote/rdfstore-js#default_graph"}]};return{query:{prologue:{base:"",prefixes:[],token:"prologue"},kind:"query",token:"query",units:[e]},varsMap:b.varsMap,topLevel:b.topLevel,subject:a,inverseMap:b.inverseMap}};v.prototype._parseModify=function(a){var b=l.newContext(!0),c=l.parseBGP(a,b,!0),a=c[0],d=[{token:"filter",
value:{token:"expression",expressionType:"conditionaland",operands:[]}}],e;for(e in b.filtersMap)d[0].value.operands.push(b.filtersMap[e]);e=b.quads.concat(c[1]);e={kind:"modify","with":null,using:null,pattern:{filters:[],token:"groupgraphpattern",patterns:[{token:"basicgraphpattern",triplesContext:e}]},"delete":e};if(d[0].value.operands.length>0)e.pattern.filters=d;d=[];for(c=0;c<b.variables.length;c++)d.push({kind:"var",token:"variable",value:b.variables[c]});return{query:{prologue:{base:"",prefixes:[],
token:"prologue"},kind:"update",token:"query",units:[e]},varsMap:b.varsMap,topLevel:b.topLevel,subject:a,inverseMap:b.inverseMap}};v.prototype._parseModifyNodes=function(a,b){this.kind="all";var c=this,d=0;this._executeQuery(function(a){l.nextVariable();for(var b=0;b<a.length;b++)c.template={$id:a[b].$id},c.kind="removeNode",c._executeUpdate(function(g){g===!0&&d++;c._unlinkNode(c.template.$id);c.store.nodeDeletedCallback&&c.store.nodeDeletedCallback(a[b])})});b&&b(d)};v.prototype._unlinkNode=function(a,
b,c){b==null&&(b=function(){});var d={token:"uri",value:l.base_uri+a},e=l.nextVariable(),f=this,g=f._modifyQuery([{subject:d,predicate:{token:"var",value:e+"pout"},object:{token:"var",value:e+"oout"}}]);f.store.execute(g.query,function(){c!==!0?(g=f._modifyQuery([{subject:{token:"var",value:e+"sin"},predicate:{token:"var",value:e+"pin"},object:d}]),f.store.execute(g.query,b)):b(!0)})};v.prototype._modifyQuery=function(a){return{query:{prologue:{base:"",prefixes:[],token:"prologue"},kind:"update",
token:"query",units:[{kind:"modify","with":null,using:null,pattern:{filters:[],token:"groupgraphpattern",patterns:[{token:"basicgraphpattern",triplesContext:a}]},"delete":a}]}}};v._processQueryResults=function(a,b,c,d,e,f,g){var j={},k={},m={},i={},n={},o,q,s=0,w=[],r=this;if(f!=null||g!=null){for(var f=f||0,g=g||a.length-f,g=f+g,v=[],u={},t={},x=0,y=0;y<a.length;y++)q=a[y][b].value,u[q]==null?(u[q]=!0,x>=f&&x<g&&(t[q]=!0,v.push(a[y])),x++):t[q]&&v.push(a[y]);a=v}for(y=0;y<a.length;y++){var f=a[y],
B;for(B in f){o=!1;g=c[B];if(g==B)g=a[y][B].value;B===b&&(o=!0);var A=g.indexOf(l.base_uri)!=-1?g.split(l.base_uri)[1]:g,D=i[A],D=D||{$id:A};i[A]=D;if(v=d[A]||d[B])for(var z in v){q=n[D.$id]||{};n[D.id]=q;u=q[z+"$in"]||{};q[z+"$in"]=u;for(q=0;q<v[z].length;q++){t=a[y][c[v[z][q]]];t!=null?(t=t.value,t.indexOf(l.base_uri)!=-1&&(t=t.split(l.base_uri)[1])):t=v[z][q];var x=i[t]||{$id:t},E=m[t]||{};m[t]=E;E[z]=!0;delete x[z];i[t]=x;D[z+"$in"]==null?(D[z+"$in"]=x,u[x.$id]=!0):D[z+"$in"].constructor===Array?
u[x.$id]!==!0&&(D[z+"$in"].push(x),u[x.$id]=!0):u[x.$id]!==!0&&(D[z+"$in"]=[D[z+"$in"],x],u[x.$id]=!0)}}if(k[A]==null)E=m[A]||{},m[A]=E,l.isUri(g)&&e.execute(l.singleNodeQuery(g,"p","o"),function(a,b){k[A]=!0;s++;r._processSingleNodeResults(A,b,D,n,i,E);o&&j[D.$id]==null&&(w.push(D),j[D.$id]=!0)});else if(o&&(D=i[A])&&j[D.$id]==null)j[D.$id]=D,w.push(D)}}return w};v._processSingleNodeResults=function(a,b,c,d,e,f){nodeDisambiguations=d[a]||{};d[a]=nodeDisambiguations;d=null;for(a=0;a<b.length;a++){d=
b[a].o;if(d.token==="uri")if(d.value===l.NIL)d=null;else{var d=d.value.indexOf(l.base_uri)!=-1?d.value.split(l.base_uri)[1]:d.value,g=e[d]||{};g.$id=d;d=e[d]=g}else d=l.literalToJS(d);g=b[a].p.value;g==="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"&&(g="$type");g===l.base_uri+"from"&&(g="$from");g===l.base_uri+"state"&&(g="$state");f[g]||(c[g]&&c[g].constructor===Array&&d!==null?typeof d==="object"&&d.$id&&nodeDisambiguations[g][d.$id]==null?(nodeDisambiguations[g][d.$id]=!0,c[g].push(d)):typeof d!==
"object"&&d.constructor===Date&&nodeDisambiguations[g]["date:"+d.getTime()]==null?(nodeDisambiguations[g]["date:"+d.getTime()]=!0,c[g].push(d)):nodeDisambiguations[g][d]==null&&(nodeDisambiguations[g][d]=!0,c[g].push(d)):c[g]&&d!==null?typeof c[g]==="object"&&c[g].$id!=null?typeof d==="object"&&d.$id!=null?c[g].$id!=d.$id&&(c[g]=[c[g],d],nodeDisambiguations[g]={},nodeDisambiguations[g][c[g][0].$id]=!0,nodeDisambiguations[g][c[g][1].$id]=!0):(nodeDisambiguations[g]={},nodeDisambiguations[g][c[g].$id]=
!0,typeof d==="object"?nodeDisambiguations[g]["date:"+d.getTime()]=!0:nodeDisambiguations[g][d]=!0,c[g]=[c[g],d]):typeof c[g]==="object"?typeof d==="object"&&d.$id==null?c[g].getTime()!==d.getTime()&&(c[g]=[c[g],d],nodeDisambiguations[g]={},nodeDisambiguations[g]["date:"+c[g][0].getTime()]=!0,nodeDisambiguations[g]["date:"+c[g][1].getTime()]=!0):(nodeDisambiguations[g]={},nodeDisambiguations[g]["date:"+c[g].getTime()]=!0,typeof d==="object"?nodeDisambiguations[g][d.$id]=!0:nodeDisambiguations[g][d]=
!0,c[g]=[c[g],d]):typeof d!=="object"?d!=c[g]&&(nodeDisambiguations[g]={},nodeDisambiguations[g][d]=!0,nodeDisambiguations[g][c[g]]=!0,c[g]=[c[g],d]):(nodeDisambiguations[g]={},nodeDisambiguations[g][c[g]]=!0,d.$id!=null?nodeDisambiguations[g][d.$id]=!0:nodeDisambiguations[g]["date:"+d.getTime()]=!0,c[g]=[c[g],d]):c[g]=d)}};v.prototype._applyResultFilter=function(a,b){var c=this.filter.shift(),d=c[0],e=null,f=[],g,j=this;n.repeat(0,a.length,function(b,j){var i=arguments.callee,l=a[j._i];d==="reduce"?
(e=c[1],g=c[2](e,l)):g=c[1](l);d==="select"?g!==!1&&f.push(l):d==="map"?f.push(g):d==="each"?f.push(l):d==="reduce"&&(e=g);b(i,j)},function(){d==="reduce"&&(f=e);j.filter.length===0?j.groupPredicate!=null?j._groupResults(f,b):b(f):j._applyResultFilter(f,b)})};v.prototype._groupResults=function(a,b){if(a){for(var c={},d=0;d<a.length;d++){var e=this.groupPredicate(a[d]),f=c[e]||[];f.push(a[d]);c[e]=f}b(c)}else b(null)};var B={registry:{},definitionOrder:[],Clone:function(){}};B.reset=function(){B.registry=
{};B.definitionOrder=[]};B.define=function(a,b){a=a.replace(/\s*/g,"");B.registry[a]=b;B.definitionOrder.push(a)};B.instance=function(a,b){var c=b||{};B.Clone.prototype=B.registry[a];var d=new B.Clone;c.init=null;for(var e in d)c[e]==null&&(c[e]=d[e]);c.init&&typeof c.init==="function"&&(c.init(),delete c.init);return c};B.check=function(a,b){var c=b||!0;a.__micrograph__classes=a.__micrograph__classes||{};for(var d,e=0;e<B.definitionOrder.length;e++)if(d=B.definitionOrder[e],B.isInstance(a,d))(c||
a.__micrograph__classes[d]==null)&&B.instance(d,a),a.__micrograph__classes[d]=!0;else if(a.__micrograph__classes[d]!=null){delete a.classes[d];for(var f in B.registry[d])delete a[f]}};B.isInstance=function(a,b){if(b.indexOf("and(")===0){for(var c=b.slice(0,b.length-1).split("and(")[1].split(","),d=0;d<c.length;d++)if(!B.isInstance(a,c[d]))return!1;return!0}else if(b.indexOf("or(")===0){c=b.slice(0,b.length-1).split("or(")[1].split(",");for(d=0;d<c.length;d++)if(B.isInstance(a,c[d]))return!0;return!1}else if(b.indexOf("prop(")===
0)return c=b.slice(0,b.length-1).split("prop(")[1],a[c]!=null;else if(b.indexOf("not(")===0)return c=b.slice(0,b.length-1).split("not(")[1],!B.isInstance(a,c);else if(a.$type)if(typeof a.$type==="object"){for(d=0;d<a.$type.length;d++)if(a.$type[d]===b)return!0;return!1}else return a.$type===b;else return!1};Microdata=function(a,b){this.baseURI=a;this.doc=b==null?document:b};Microdata.prototype._toArray=function(a){var b=[];if(a==null)return b;for(var c=0;c<a.length;c++)b[c]=a[c];return b};Microdata.prototype._getElementsByAttribute=
function(a,b,c){arrElements=[a];for(var c=c||!0,d=[],e,f;arrElements.length>0;)if(e=arrElements.shift(),e.nodeType===Node.ELEMENT_NODE&&e.tagName.toLowerCase()!=="link"&&e.tagName.toLowerCase()!=="iframe"&&e.tagName.toLowerCase()!=="meta"){var g=e.childNodes,j=e.getAttribute&&e.getAttribute("itemscope")!=null;e.getAttribute&&e.getAttribute("itemproperty");f=e.getAttribute&&e.getAttribute(b);if(b==="itemscope")f!=null?(e!=a||c)&&d.push(e):g&&(arrElements=arrElements.concat(this._toArray(g)));else if(b===
"itemprop")if(f!=null&&e!=a)d.push(e);else{if(g&&!j||e==a)arrElements=arrElements.concat(this._toArray(g))}else if(f!=null)d.push(e);else if(g&&!j||e==a)arrElements=arrElements.concat(this._toArray(g))}return d};Microdata.prototype.parse=function(){var a;a=this.doc;if(arguments.length==1||this.tag)a=this.doc.getElementById(this.tag||arguments[0]);a=this._getElementsByAttribute(a,"itemscope",!0);for(var b=[],c=0;c<a.length;c++)b.push(this._processNode(a[c]));return b};Microdata.prototype._parseType=
function(a,b){for(var c=[],d=this._getElementsByAttribute(a,"itemtype",!0),e=0;e<d.length;e++)c.push(d[e].getAttribute("itemtype"));c.length==1?b.$type=c[0]:d.length>1&&(b.$type=c)};Microdata.prototype._parseProperties=function(a,b){for(var c=this._getElementsByAttribute(a,"itemprop",!1),d=0;d<c.length;d++)this._processProperty(b,c[d])};Microdata.prototype._parseId=function(a,b){var c=this._getElementsByAttribute(a,"itemid",!0);c.length===1&&(b.$id=c[0].getAttribute("itemid"))};Microdata.prototype._processProperty=
function(a,b){var c=b.getAttribute("itemprop"),d=a[c],e=null,e=b.tagName.toLowerCase();b.getAttribute("itemscope")!=null?e=this._processNode(b):e==="meta"?e=b.content:e==="audio"||e==="embed"||e==="iframe"||e==="source"||e==="track"||e==="video"||e==="img"?(e=b.getAttribute("src"),e=e.indexOf(":")!=-1?e:this.baseURI+e):e==="a"||e==="area"||e==="link"?(e=b.getAttribute("href"),e=e.indexOf(":")!=-1?e:this.baseURI+e):e==="object"?(e=b.getAttribute("data"),e=e.indexOf(":")!=-1?e:this.baseURI+e):e=b.getAttribute("datetime")!=
null?new Date(b.getAttribute("datetime")):b.textContent;d==null?a[c]=e:typeof d==="object"&&d.constructor===Array?a[c].push(e):a[c]=[d,e]};Microdata.prototype._processNode=function(a){var b={};this._parseId(a,b);if(a.getAttribute&&a.getAttribute("itemref")!=null)for(var c=a.getAttribute("itemref").split(/\s+/),d=0;d<c.length;d++)a=this.doc.getElementById(c[d]),this._parseType(a,b),this._parseProperties(a,b);else this._parseType(a,b),this._parseProperties(a,b);return b};var o=function(a,b){a.treeOrder||
(a.treeOrder=15);var c=this;this.callbackToInner={};this.callbackMap={};this.callbackCounter=0;this.callbackToNodes={};this.nodesToCallbacks={};this.resources=[];this.defaultFrom=this.transformFunction=this.errorCallback=this.lastDataToLoad=this.lastQuery=null;this.defaultState="created";this.nodeUpdatedCallback=this.nodeDeletedCallback=null;for(var d=this.blank=0;d<o.vars.length;d++)this["_"+o.vars[d]]=this._(o.vars[d]);this.callbacksMap={};var e=a.persistent,d=z;e&&(d=A);new d.Lexicon(function(d){a.overwrite===
!0&&d.clear();var f=x;e&&(f=w);new I.QuadBackend(a,f,function(f){a.overwrite===!0&&f.clear();a.backend=f;a.lexicon=d;c.engine=new u.QueryEngine(a);c.engine.eventsOnBatchLoad=!0;c.engine.abstractQueryTree.oldParseQueryString=c.engine.abstractQueryTree.parseQueryString;c.engine.abstractQueryTree.parseQueryString=function(a){return typeof a==="string"?this.oldParseQueryString(a):a};e?c.where({}).all(function(){b&&b(c)}):b&&b(c)})},a.name)};o.VERSION="0.4.3";o.vars=["a","b","c","d","e","f","g","h","i",
"j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];o.prototype.onError=function(a){this.errorCallback=a;return this};o.prototype.onUpdate=function(a){this.nodeUpdatedCallback=a;return this};o.prototype.onDelete=function(a){this.nodeDeletedCallback=a;return this};o.create=function(){var a,b;if(arguments.length===0)throw"A callback function and an optional options map must be provided";else arguments.length==1?(b={treeOrder:15,name:"micrograph_instance",overwrite:!1},a=arguments[0]):
(b=arguments[0],a=arguments[1]);new o(b,a)};o.open=function(a,b,c,d){if(!d)if(typeof c==="function")d=c,c={};else throw"Persistent storage requires a callback functon";c.persistent=!0;c.name=a;c.overwrite=b;new o(c,d)};o.prototype.define=function(a,b){B.define(a,b);return this};o.prototype.toJSON=function(a){for(var a=JSON.parse(JSON.stringify(a)),b=[a],c;b.length>0;)if(c=b.pop(),c.constructor===Array)for(var d=0;d<c.length;d++)b.push(c[d]);else for(var e in c)e=="$id"||e=="$type"||e=="$from"||e.indexOf("$in")!=
-1||e=="$state"||e.indexOf("__")===0||typeof c[e]==="function"?delete c[e]:c[e]&&typeof c[e]==="object"&&c[e].constructor!=Date&&b.push([e,c[e]]);return a};o.prototype.instantiate=function(a){if(a.__micrograph__classes!=null)return this;B.check(a);for(var b in a)if(typeof a[b]==="object"&&a[b]!==null&&a[b]!==void 0)if(a[b].constructor==Array)for(var c=0;c<a[b].length;c++)typeof a[b][c]==="object"&&a[b][c].$id&&this.instantiate(a[b][c]);else a[b].$id&&this.instantiate(a[b]);return this};o.prototype.modificationName=
null;o.prototype.startGraphModification=function(a){if(a!=null&&this.modificationName!=null)throw"Modification already being executed";else if(this.modificationName==null)this.modificationName=a,this.engine.startGraphModification()};o.prototype.endGraphModification=function(a){if(a===this.modificationName||this.modificationName==null)this.modificationName=null,this.engine.endGraphModification()};o.prototype.execute=function(a,b){this.startGraphModification();this.engine.execute(a,b);this.endGraphModification();
return this};o.prototype.where=function(a){this.lastQuery=a=new v(a);a.setStore(this);return a};o.prototype.traverse=function(a){var b={$id:this._("start")};b[a]=this._("end");this.lastQuery=a=new v(b);a.setStore(this);a.setKind("traverse");return a};o.prototype.instances=function(a){if(this.lastQuery.lastResult&&this.lastQuery.lastResult.constructor===Array){for(var b=0;b<this.lastQuery.lastResult.length;b++)this.instantiate(this.lastQuery.lastResult[b]);a(this.lastQuery.lastResult)}else this.lastQuery.lastResult?
(this.instantiate(this.lastQuery.lastResult),a(this.lastQuery.lastResult)):a(null);return this};o.prototype._=function(a){return{token:"var",value:a}};o.normalize=function(a,b){var b=b||!1,c=[a],d=[];typeof a=="object"&&a.constructor===Array&&(c=a);for(var e,f;c.length>0;)if(e=c.pop(),e.constructor===Array&&e==null)for(var g=0;g<e.length;g++)c.push(e[g]);else{for(var j in e)if(e[j]&&typeof e[j]==="object"&&e[j].constructor!=Array&&e[j].constructor!=Date)f=e[j],f.$id!=null&&(e[j]={$id:f.$id}),(!b||
f.$id==null)&&c.push(f);else if(e[j]&&typeof e[j]==="object"&&e[j].constructor==Array){f=[];for(g=0;g<e[j].length;g++)(!b||e[j][g].$id==null)&&c.push(e[j][g]),e[j][g].$id!=null?f.push({$id:e[j][g].$id}):f.push(e[j][g]);e[j]=f}e.$id!=null&&d.push(e)}return d};o.prototype.load=function(){var a,b,c,d=this;if(arguments.length==1)typeof arguments[0]==="function"?c=arguments[0]:(a=arguments[0],c=function(){});else if(arguments.length==2)a=arguments[0],c=arguments[1];else throw"Data to be loaded and an optional callback function must be specified";
b={token:"uri",value:this.engine.lexicon.defaultGraphUri};if(this.lastDataToLoad!=null)if(this.lastDataToLoad.constructor===Array){a=[];var e=this.lastDataToLoad;n.repeatAsync(0,e.length,function(b,c){var f=arguments.callee;d.lastDataToLoad=e[c._i];d.defaultFrom=e[c._i].uri;d.load(function(d){d.constructor&&d.constructor===Array?a=a.concat(d):a.push([e[c._i].uri,d]);b(f,c)})},function(){c(a)})}else b=this.lastDataToLoad,this.lastDataToLoad=null,b.jsonp!=null?o.jsonp(b.uri,function(a){d.load(a,c)},
this.errorCallback,b.jsonp,b):o.ajax("GET",b.uri,b,null,function(a){d.load(a,c)},this.errorCallback);else if(typeof a==="object"){a.constructor!==Array&&(a=[a]);if(this.transformFunction!=null)for(var e=[[null,a]],f;e.length>0;)if(f=e.pop(),f[1].constructor===Array)for(var g=0;g<f[1].length;g++)e.push([f[0],f[1][g]]);else{g=null;this.defaultFrom!=null&&(g=this.defaultFrom.indexOf("?")!=-1?this.defaultFrom.split("?")[0]:this.defaultFrom);this.transformFunction(f[0],f[1],g);for(var j in f[1])f[1][j]&&
typeof f[1][j]==="object"&&f[1][j].constructor!=Date&&e.push([j,f[1][j]])}for(g=0;g<a.length;g++)f=l.parseJSON(a[g],b,this.defaultFrom,this.defaultState),d.startGraphModification(),d.engine.batchLoad(f,function(){d.endGraphModification()});this.defaultFrom=null;this.defaultState="created";c&&c(a)}return this};o.prototype.save=function(a,b){this.transformFunction=null;this.load(a,function(a){b&&b(a[0])});return this};o.prototype.removeNode=function(a,b){typeof a==="string"&&(a={$id:a});var c=new v({$id:a.$id});
c.setStore(this);c._unlinkNode(a.$id,b,!0);this.nodeDeletedCallback&&this.nodeDeletedCallback(a);return this};o.prototype.updateNode=function(){var a,b,c;if(arguments.length===1)a=arguments[0],b=!1,c=null;else if(arguments.length===2)a=arguments[0],typeof arguments[1]==="function"?(c=arguments[1],b=!1):(c=null,b=arguments[1]);else if(arguments.length===3)a=arguments[0],b=arguments[1],c=arguments[2];else if(c)c(!1,"Wrong number of arguments for update, only 1, 2 or 3 args allowd, received "+arguments.length);
else throw"Wrong number of arguments for update, only 1, 2 or 3 args allowd, received "+arguments.length;var d=a.$id;if(d){for(p in a)p.indexOf("$in")!=-1&&!b&&delete a[p];normalized=o.normalize(a,!0);var e=this,f;e.startGraphModification("update");for(a=0;a<normalized.length;a++)f=normalized[a],f.$id&&f.$id===d&&this.where({$id:f.$id})._unlinkNode(f.$id,function(a){a?(e.defaultState="dirty",e.save(f),e.nodeUpdatedCallback&&e.nodeUpdatedCallback(f)):c&&c(!1)},b?!1:!0);e.endGraphModification("update");
c&&c(!0)}else if(c)c(!1,"ID must be provided");else throw"ID must be provided to update";};o.prototype.setState=function(a,b){var c=a;typeof a==="object"&&(c=a.$id);if(c!=null){var d=v.prototype._parseModify({$id:c}),e={subject:{token:"uri",value:l.base_uri+c},predicate:{token:"uri",value:l.base_uri+"state"},object:{token:"var",value:"person"}},c={subject:{token:"uri",value:l.base_uri+c},predicate:{token:"uri",value:l.base_uri+"state"},object:l.parseLiteral(b)};d.query.units[0].pattern.patterns[0].triplesContext=
[e];d.query.units[0].pattern.filters=null;d.query.units[0]["delete"]=[e];d.query.units[0].insert=[c];this.engine.execute(d.query,function(){})}else throw"A node or node ID must be provided to setState";};o.prototype.setId=function(a,b){var c=a;typeof a==="object"&&(c=a.$id);b=l.isUri(b)?{token:"uri",value:b}:{token:"uri",value:l.base_uri+b};if(c!=null){var d=v.prototype._parseModify({$id:c}),e={subject:{token:"uri",value:l.base_uri+c},predicate:{token:"var",value:"p"},object:{token:"var",value:"o"}},
f={subject:b,predicate:{token:"var",value:"p"},object:{token:"var",value:"o"}};d.query.units[0].pattern.patterns[0].triplesContext=[e];d.query.units[0].pattern.filters=null;d.query.units[0]["delete"]=[e];d.query.units[0].insert=[f];this.engine.execute(d.query,function(){});e={object:{token:"uri",value:l.base_uri+c},predicate:{token:"var",value:"p"},subject:{token:"var",value:"s"}};f={object:b,predicate:{token:"var",value:"p"},subject:{token:"var",value:"s"}};d=v.prototype._parseModify({$id:c});d.query.units[0].pattern.patterns[0].triplesContext=
[e];d.query.units[0].pattern.filters=null;d.query.units[0]["delete"]=[e];d.query.units[0].insert=[f];this.engine.execute(d.query,function(){})}else throw"A node or node ID must be provided to setId";};o.prototype.bind=function(a,b,c){var d="cb"+this.callbackCounter;this.callbackCounter++;var e=b.filter,f=this,g={},j=function(k){b.filter=e;e=b.filter.concat([]);for(var k=v._processQueryResults(k,a.topLevel,a.varsMap,a.inverseMap,f),j=0;j<k.length;j++){var i=k[j].$id;g[i]==null&&(f.engine.callbacksBackend.addQueryToObserver(d,
l.singleNodeQuery(l.base_uri+i,"p","o")),g[i]=!0)}b.filter.length>0?b._applyResultFilter(k,function(a){c(a,d)}):b.groupPredicate!=null?b._groupResults(k,function(a){c(a,d)}):c(k,d)};this.callbackToInner[c]=d;this.callbackMap[d]=j;this.engine.callbacksBackend.observeQuery(d,a.query,j,function(){});return this};o.prototype.unbind=function(a){typeof a==="function"&&(a=this.callbackToInner[a]);a&&this.engine.callbacksBackend.stopObservingQuery(a);return this};o.prototype.from=function(a,b,c){this.transformFunction=
null;b?typeof b==="function"&&(c=b,b={}):b={};var d=a,e;if(typeof a==="object"&&a.constructor===Array){d=[];e=[];for(var f=0;f<a.length;f++){var g={},j;for(j in b)g[j]=b[j];a[f].indexOf("?")!=-1&&d.push(a[f].split("?")[0]);a[f].indexOf("?")!=-1&&a[f].split("?")[1].indexOf("callback")!=-1&&b.jsonp==null&&(g.jsonp="callback");g.uri=a[f];e.push(g)}this.defaultFrom=d;this.defaultState="loaded";if(c)this.lastDataToLoad=e;else{var k=this,l=[];n.repeatAsync(0,e.length,function(a,b){var c=arguments.callee;
k.from(k.acum[b._i].uri,e[b._i],function(d){l.push(d);a(c,b)})},function(){c(l)})}}else d.indexOf("?")!=-1&&(d=d.split("?")[0]),a.indexOf("?")!=-1&&a.split("?")[1].indexOf("callback")!=-1&&b.jsonp==null&&(b.jsonp="callback"),b.uri=a,this.defaultFrom=d,this.defaultState="loaded",c!=null?(this.lastDataToLoad=null,b.jsonp!=null?o.jsonp(b.uri,c,this.errorCallback,b.jsonp,b):o.ajax("GET",b.uri,b,null,c,this.errorCallback)):this.lastDataToLoad=b;return this};o._parseTransformFunction=function(a){return function(b,
c){b==null&&a["null"]!=null&&(b="null");if(a[b])for(var d in a[b]){if(d==="@delete")if(a[b][d].constructor===Array)for(var e=0;e<a[b][d].length;e++)delete c[a[b][d][e]];else delete c[a[b][d]];d==="@id"?c.$id=typeof a[b][d]==="function"?a[b][d](c):c[a[b][d]]:d==="@type"?c.$type=typeof a[b][d]==="function"?a[b][d](c):c[a[b][d]]:d==="@from"?c.$from=typeof a[b][d]==="function"?a[b][d](c):c[a[b][d]]:c[d]=typeof a[b][d]==="function"?a[b][d](c):c[a[b][d]]}}};o.prototype.transform=function(a){typeof a===
"object"&&(a=o._parseTransformFunction(a));this.transformFunction=a;return this};o.ajax=function(a,b,c,d,e,f){var g=c.media;g==null||g==="json"?g="application/json":g==="n3"||g==="turtle"||g==="ttl"?g="text/n3":g==="microdata"&&(g="text/html");var j=function(a){var d;if(g==="application/json")d=JSON.parse(a);else if(g==="text/n3")d=o.n3(b,a,c);else if(g==="text/html"&&c.media==="microdata")d=document.createElement("div"),d.innerHTML=a.replace(/<script(.|\s)*?\/script>/g,""),d=(new Microdata(b,d)).parse();
e(d,k)},k=new XMLHttpRequest;typeof XDomainRequest!="undefined"&&!k.withCredentials&&c.crossDomain?(k=new XDomainRequest,k.open(a,b),k.onload=function(){j(k.responseText)}):(k.open(a,b,!0),k.overrideMimeType&&k.overrideMimeType(g),k.setRequestHeader&&k.setRequestHeader("Accept",g),d!=null&&k.setRequestHeader&&k.setRequestHeader("Content-Type",g),k.onreadystatechange=function(){k.readyState===4&&(k.status<300&&k.status!==0?j(k.responseText):f&&f(k.statusText,k))});k.onerror=function(a){f&&f("XHR Error",
a)};k.send(d)};o.jsonpCallbackCounter=0;o.jsonpRequestsConfirmations={};o.jsonpRetries={};o.prototype.microdata=function(a,b,c,d){var e=document.createElement("div");typeof c==="function"&&(d=c);e.innerHTML=b.replace(/<script(.|\s)*?\/script>/g,"");this.load((new Microdata(a,e)).parse(),d);return this};o.prototype.n3=function(a,b,c,d){if(o.n3)this.load(o.n3(a,b,c),d);else throw"N3 Parser not available";return this};o.jsonp=function(a,b,c,d,e,f){var f=f||!1,e=e||{},g=e.base||a,j=e.retries;j==null&&
j!==0&&(j=1);var k=e.timeout||15E3,l="jsonp"+o.jsonpCallbackCounter;o.jsonpCallbackCounter++;if(d==null||typeof d!=="string")d="callback";var i=a;i.indexOf("?")===-1?i=i+"?"+d+"="+l:i.split("?")[1].indexOf(d+"=")==-1?i=i+"&"+d+"="+l:l=i.split("?")[1].split(d+"=")[1].split("&")[0];o.jsonpRetries[a]==null?o.jsonpRetries[a]=0:o.jsonpRetries[a]+=1;window[l]=function(a){try{o.jsonpRequestsConfirmations[i]=!0;e.result&&(a=a[e.result]);if(e.media&&e.media==="n3")resultData=o.n3(g,a,e);else if(e.media&&e.media===
"microdata"){var d=document.createElement("div");d.innerHTML=a.replace(/<script(.|\s)*?\/script>/g,"");a=(new Microdata(g,d)).parse()}b(a)}catch(f){c&&c("Error processing JSONP results for media type  "+e.media+": "+f)}};setTimeout(function(){o.jsonpRequestsConfirmations[i]===!0?(delete o.jsonpRetries[i],delete o.jsonpRequestsConfirmations[i],delete window[l]):o.jsonpRetries[a]<j?(console.log("(!!) JSONP error, retyring..."),console.log(a),console.log(d),delete window[l],f?b(null):o.jsonp(a,b,c,d,
e,f)):(delete o.jsonpRetries[a],delete o.jsonpRequestsConfirmations[i],delete window[l],c&&c("Error loading JSONP request "+a))},k);k=document.createElement("script");k.setAttribute("type","text/javascript");k.setAttribute("src",i);document.getElementsByTagName("head")[0].appendChild(k)};o._deleteDataQuery=function(a){return{token:"query",kind:"update",prologue:{token:"prologue",base:"",prefixes:[]},units:[{kind:"deletedata",token:"executableunit",quads:a}]}};o._insertDataQuery=function(a){return{token:"query",
kind:"update",prologue:{token:"prologue",base:"",prefixes:[]},units:[{kind:"insertdata",token:"executableunit",quads:a}]}};try{typeof window==="undefined"?exports.create=o.create:window.mg=o}catch(M){}})();
