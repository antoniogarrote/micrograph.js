(function(){typeof console=="undefined"&&(console={log:function(){}});var m={"extends":function(a,b){b.prototype=new a},stackCounterLimit:1E3,stackCounter:0};m.recur=function(a){m.stackCounter===m.stackCounterLimit?(m.stackCounter=0,setTimeout(a,0)):(m.stackCounter++,a())};m.clone=function(a){return JSON.parse(JSON.stringify(a))};m.shuffle=function(a){for(var b,c,e=a.length;e;b=parseInt(Math.random()*e),c=a[--e],a[e]=a[b],a[b]=c);return a};m.include=function(a,b,c){for(var e=a.length-1;e>=0;e--){var g=
!1,g=c==null?a[e]===b:c(a[e],b)===0;if(g===!0)return!0}return!1};m.remove=function(a,b){for(var c=[],e=0;e<a.length;e++)a[e]!==b&&c.push(a[e]);return c};m.repeat=function(a,b,c,e,g){arguments.length===4&&(g={});a<b?(g._i=a,c(function(c,g){m.recur(function(){m.repeat(a+1,b,c,e,g)})},g)):e(g)};m.meanwhile=function(a,b,c,e){arguments.length===3&&(e={});e._stack_counter==null&&(e._stack_counter=0);a===!0?b(function(a,b,e){e._stack_counter%40==39?(e._stack_counter+=1,setTimeout(function(){m.neanwhile(a,
b,c,e)},0)):(e._stack_counter+=1,m.meanwhile(a,b,c,e))},e):c(e)};m.seq=function(){var a=arguments;return function(b){m.repeat(0,a.length,function(b,e){var g=arguments.callee;a[e._i](function(){b(g,e)})},function(){b()})}};m.partition=function(a,b){for(var c=a.length%b,e=[],g=0;g<c;g++)e.push(null);c=[];for(g=0;g<a.length;g++)e.push(a[g]),e.length%b==0&&(c.push(e),e=[]);return c};m.keys=function(a){var b=[],c;for(c in a)b.push(c);return b};m.iso8601=function(a){function b(a){return a<10?"0"+a:a}return a.getUTCFullYear()+
"-"+b(a.getUTCMonth()+1)+"-"+b(a.getUTCDate())+"T"+b(a.getUTCHours())+":"+b(a.getUTCMinutes())+":"+b(a.getUTCSeconds())+"Z"};m.parseStrictISO8601=function(a){var b=a.match(RegExp("([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?")),a=0,c=new Date(b[1],0,1);if(b[3])c.setMonth(b[3]-1);else throw"missing ISO8061 component";if(b[5])c.setDate(b[5]);else throw"missing ISO8061 component";if(b[7])c.setHours(b[7]);else throw"missing ISO8061 component";
if(b[8])c.setMinutes(b[8]);else throw"missing ISO8061 component";if(b[10])c.setSeconds(b[10]);else throw"missing ISO8061 component";b[12]&&c.setMilliseconds(Number("0."+b[12])*1E3);b[14]&&(a=Number(b[16])*60+Number(b[17]),a*=b[15]=="-"?1:-1);a-=c.getTimezoneOffset();b=new Date;b.setTime(Number(Number(c)+a*6E4));return b};m.parseISO8601=function(a){var b=a.match(RegExp("([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?")),a=
0,c=new Date(b[1],0,1);b[3]&&c.setMonth(b[3]-1);b[5]&&c.setDate(b[5]);b[7]&&c.setHours(b[7]);b[8]&&c.setMinutes(b[8]);b[10]&&c.setSeconds(b[10]);b[12]&&c.setMilliseconds(Number("0."+b[12])*1E3);b[14]&&(a=Number(b[16])*60+Number(b[17]),a*=b[15]=="-"?1:-1);a-=c.getTimezoneOffset();b=new Date;b.setTime(Number(Number(c)+a*6E4));return b};m.parseISO8601Components=function(a){var a=a.match(RegExp("([0-9]{4})(-([0-9]{2}))(-([0-9]{2}))(T([0-9]{2}):([0-9]{2})(:([0-9]{2}))?(.([0-9]+))?)?(Z|([-+])([0-9]{2})(:([0-9]{2}))?)?")),
b,c,e,g,h,f,d,k;b=Number(a[1]);c=a[3]-1;e=Number(a[5]);g=Number(a[7]);h=Number(a[8]);f=Number(a[10]);a[12]&&(d=Number("0."+a[12])*1E3);a[13]==="Z"?k=0:a[14]?(k=0,a[17]&&(k=Number(a[17])),k+=Number(a[15])*60,k*=a[14]=="-"?-1:1):a[14]==null&&a[11]&&(k=Number(a[12])*60);return{year:isNaN(b)?null:b,month:isNaN(c)?null:c,date:isNaN(e)?null:e,hours:isNaN(g)?null:g,minutes:isNaN(h)?null:h,seconds:isNaN(f)?null:f,millisecs:isNaN(d)?null:d,timezone:isNaN(k)?null:k}};m.compareDateComponents=function(a,b){var c=
m.parseISO8601Components(a),e=m.parseISO8601Components(b);if(c.timezone==null&&e.timezone==null||c.timezone!=null&&e.timezone!=null)return c=m.parseISO8601(a),e=m.parseISO8601(b),c.getTime()==e.getTime()?0:c.getTime()<e.getTime()?-1:1;else if(c.timezone!=null&&e.timezone==null){var c=m.parseISO8601(a),e=m.parseISO8601(b),c=c.getTime(),e=e.getTime(),g=50400;return c<e&&c<e+g?-1:c>e&&c>e-g?1:null}else return c=m.parseISO8601(a),e=m.parseISO8601(b),c=c.getTime(),e=e.getTime(),g=50400,c<e&&c+g<e?-1:c>
e&&c+g>e?1:null};m.lexicalFormLiteral=function(a,b){var c=a.value,e=a.lang,g=a.type,h=null;if(c!=null&&g!=null&&typeof g!="string"){c=g.value;if(c==null)c=g.suffix,g=b.namespaces[g.prefix],a.type=g+c,c=g+c;h=c.indexOf("hexBinary")!=-1?'"'+a.value.toLowerCase()+'"^^<'+c+">":'"'+a.value+'"^^<'+c+">"}else h=e==null&&g==null?'"'+c+'"':g==null?'"'+c+'"@'+e:g.indexOf("hexBinary")!=-1?'"'+a.value.toLowerCase()+'"^^<'+g+">":'"'+a.value+'"^^<'+g+">";return h};m.lexicalFormBaseUri=function(a,b){var c=null;
if(a.value==null)var c=a.prefix,e=a.suffix,g=b.namespaces[c],c=g!=null?g+e:c+":"+e;else c=a.value;if(c===null)return null;else c.indexOf(":")==-1&&(c=(b.base||"")+c);return c};m.lexicalFormTerm=function(a,b){if(a.token==="uri")return{uri:m.lexicalFormBaseUri(a,b)};else if(a.token==="literal")return{literal:m.lexicalFormLiteral(a,b)};else if(a.token==="blank")return{blank:"_:"+a.value};else throw"Error, cannot get lexical form of unknown token: "+a.token;};m.normalizeUnicodeLiterals=function(a){for(var b=
a.match(/\\u[0-9abcdefABCDEF]{4,4}/g)||[],c={},e=0;e<b.length;e++)c[b[e]]==null&&(c[b[e]]=!0,a=a.replace(RegExp("\\"+b[e],"g"),eval("'"+b[e]+"'")));return a};m.hashTerm=function(a){try{if(a==null)return"";if(a.token==="uri")return"u"+a.value;else if(a.token==="blank")return"b"+a.value;else if(a.token==="literal"){var b="l"+a.value;b+=a.type||"";b+=a.lang||"";return b}}catch(c){if(typeof a==="object"){b="";for(p in a)b=b+p+a[p];return b}return a}};var w={Tree:function(a){if(arguments.length!=0)this.order=
a,this.root=this._allocateNode(),this.root.isLeaf=!0,this.root.level=0,this._diskWrite(this.root),this._updateRootNode(this.root),this.comparator=function(a,c){return a<c?-1:a>c?1:0},this.merger=null}};w.Tree.prototype._allocateNode=function(){return new w.Node};w.Tree.prototype._diskWrite=function(){};w.Tree.prototype._diskRead=function(a){return a};w.Tree.prototype._diskDelete=function(){};w.Tree.prototype._updateRootNode=function(a){return a};w.Tree.prototype.clear=function(){this.root=this._allocateNode();
this.root.isLeaf=!0;this.root.level=0;this._updateRootNode(this.root)};w.Tree.prototype.search=function(a,b){for(var c=!0,e=this.root;c;){for(var g=0;g<e.numberActives&&this.comparator(a,e.keys[g].key)===1;)g++;if(g<e.numberActives&&this.comparator(e.keys[g].key,a)===0)return b!=null&&b==!0?!0:e.keys[g].data;else e.isLeaf===!0?c=!1:e=this._diskRead(e.children[g])}return null};w.Tree.prototype.walk=function(a){this._walk(a,this.root)};w.Tree.prototype._walk=function(a,b){if(b.isLeaf)for(var c=0;c<
b.numberActives;c++)a(b.keys[c]);else{for(c=0;c<b.numberActives;c++)this._walk(a,this._diskRead(b.children[c])),a(b.keys[c]);this._walk(a,this._diskRead(b.children[b.numberActives]))}};w.Tree.prototype.walkNodes=function(a){this._walkNodes(a,this.root)};w.Tree.prototype._walkNodes=function(a,b){if(b.isLeaf)a(b);else{a(b);for(var c=0;c<b.numberActives;c++)this._walkNodes(a,this._diskRead(b.children[c]));this._walkNodes(a,this._diskRead(b.children[b.numberActives]))}};w.Tree.prototype._splitChild=function(a,
b,c){var e=this._allocateNode();e.isLeaf=c.isLeaf;e.level=c.level;e.numberActives=this.order-1;var g=c.keys[this.order-1];c.keys[this.order-1]=null;for(var h=0;h<this.order-1;h++)e.keys[h]=c.keys[h+this.order],c.keys[h+this.order]=null,c.isLeaf||(e.children[h]=c.children[h+this.order],c.children[h+this.order]=null);c.isLeaf||(e.children[h]=c.children[h+this.order],c.children[h+this.order]=null);c.numberActives=this.order-1;for(h=a.numberActives+1;h>b+1;h--)a.children[h]=a.children[h-1];a.children[b+
1]=e;for(h=a.numberActives;h>b;h--)a.keys[h]=a.keys[h-1];a.keys[b]=g;a.numberActives++;this._diskWrite(e);this._diskWrite(a);this._diskWrite(c)};w.Tree.prototype.insert=function(a,b){if(this.root.numberActives===2*this.order-1){var c=this._allocateNode();c.isLeaf=!1;c.level=this.root.level+1;c.numberActives=0;c.children[0]=this.root;this._splitChild(c,0,this.root);this.root=c;this._updateRootNode(this.root);this._insertNonFull(c,a,b)}else this._insertNonFull(this.root,a,b)};w.Tree.prototype._insertNonFull=
function(a,b,c){for(var e=a.numberActives-1;!a.isLeaf;){for(;e>=0&&this.comparator(b,a.keys[e].key)===-1;)e--;e++;var g=this._diskRead(a.children[e]);g.numberActives===2*this.order-1&&(this._splitChild(a,e,g),this.comparator(b,a.keys[e].key)===1&&e++);a=this._diskRead(a.children[e]);e=a.numberActives-1}for(;e>=0&&this.comparator(b,a.keys[e].key)===-1;)a.keys[e+1]=a.keys[e],e--;a.keys[e+1]={key:b,data:c};a.numberActives++;this._diskWrite(a)};w.Tree.prototype["delete"]=function(a){for(var b=this.root,
c=null,e=!0,g=null,h=null,f=null,d=!0;d===!0;){for(d=!1;e===!0;){k=0;if(b.numberActives===0)return!1;for(;k<b.numberActives&&this.comparator(a,b.keys[k].key)===1;)k++;g=k;k<b.numberActives&&this.comparator(a,b.keys[k].key)===0&&(e=!1);if(e===!0){if(b.isLeaf===!0)return!1;c=b;b=this._diskRead(b.children[k]);if(b===null)return!1;g===c.numberActives?(h=this._diskRead(c.children[g-1]),f=null):g===0?(h=null,f=this._diskRead(c.children[1])):(h=this._diskRead(c.children[g-1]),f=this._diskRead(c.children[g+
1]));b.numberActives===this.order-1&&c!=null&&(f!=null&&f.numberActives>this.order-1?this._moveKey(c,k,-1):h!=null&&h.numberActives>this.order-1?this._moveKey(c,k,1):h!=null&&h.numberActives===this.order-1?b=this._mergeSiblings(c,k,-1):f!=null&&f.numberActives===this.order-1&&(b=this._mergeSiblings(c,k,1)))}}if(b.isLeaf&&b.numberActives>this.order-1)return this._deleteKeyFromNode(b,g),!0;if(b.isLeaf&&b===this.root)return this._deleteKeyFromNode(b,g),!0;if(b.isLeaf===!1)if(c=k=null,(k=this._diskRead(b.children[g])).numberActives>
this.order-1)a=this._getMaxKeyPos(k),a=a.node.keys[a.index],b.keys[g]=a,this._diskWrite(b),b=k,a=a.key,e=d=!0;else if((k=this._diskRead(b.children[g+1])).numberActives>this.order-1)a=this._getMinKeyPos(k),a=a.node.keys[a.index],b.keys[g]=a,this._diskWrite(b),b=k,a=a.key,e=d=!0;else if((k=this._diskRead(b.children[g])).numberActives===this.order-1&&(c=this._diskRead(b.children[g+1])).numberActives===this.order-1){e=this._mergeNodes(k,b.keys[g],c);b.children[g]=e;g++;for(var k=g;k<b.numberActives;k++)b.children[k]=
b.children[k+1],b.keys[k-1]=b.keys[k];b.children[k]=null;b.keys[k-1]=null;b.numberActives--;if(b.numberActives===0&&this.root===b)this.root=e;this._diskWrite(b);b=e;e=d=!0}b.isLeaf&&b.numberActives>this.order-1&&e===!1&&this._deleteKeyFromNode(b,g);if(d===!1)return!0}};w.Tree.prototype._moveKey=function(a,b,c){c===1&&b--;var e=this._diskRead(a.children[b]),g=this._diskRead(a.children[b+1]);if(c==-1){e.keys[e.numberActives]=a.keys[b];e.children[e.numberActives+1]=g.children[0];g.children[0]=null;e.numberActives++;
a.keys[b]=g.keys[0];for(c=1;c<g.numberActives;c++)g.keys[c-1]=g.keys[c],g.children[c-1]=g.children[c];g.children[g.numberActives-1]=g.children[g.numberActives];g.numberActives--}else{g.children[g.numberActives+1]=g.children[g.numberActives];for(c=g.numberActives;c>0;c--)g.children[c]=g.children[c-1],g.keys[c]=g.keys[c-1];g.keys[0]=null;g.children[0]=null;g.children[0]=e.children[e.numberActives];g.keys[0]=a.keys[b];g.numberActives++;e.children[e.numberActives]=null;a.keys[b]=e.keys[e.numberActives-
1];e.keys[e.numberActives-1]=null;e.numberActives--}this._diskWrite(e);this._diskWrite(g);this._diskWrite(a)};w.Tree.prototype._mergeSiblings=function(a,b){var c,e,g;b===a.numberActives?(b--,e=this._diskRead(a.children[a.numberActives-1]),g=this._diskRead(a.children[a.numberActives])):(e=this._diskRead(a.children[b]),g=this._diskRead(a.children[b+1]));var h=this._allocateNode();h.isLeaf=e.isLeaf;h.level=e.level;for(c=0;c<this.order-1;c++)h.keys[c]=e.keys[c],h.children[c]=e.children[c];h.keys[this.order-
1]=a.keys[b];h.children[this.order-1]=e.children[this.order-1];for(c=0;c<this.order-1;c++)h.keys[c+this.order]=g.keys[c],h.children[c+this.order]=g.children[c];h.children[2*this.order-1]=g.children[this.order-1];a.children[b]=h;for(c=b;c<a.numberActives;c++)a.keys[c]=a.keys[c+1],a.children[c+1]=a.children[c+2];h.numberActives=e.numberActives+g.numberActives+1;a.numberActives--;for(c=a.numberActives;c<2*this.order-1;c++)a.keys[c]=null;if(a.numberActives===0&&this.root===a)this.root=h,h.isLeaf=h.level?
!1:!0;this._diskWrite(h);this.root===h&&this._updateRootNode(this.root);this._diskWrite(a);this._diskDelete(e);this._diskDelete(g);return h};w.Tree.prototype._deleteKeyFromNode=function(a,b){var c=2*this.order-1;if(a.numberActives<c)c=a.numberActives;var e;if(a.isLeaf===!1)return!1;for(e=b;e<c-1;e++)a.keys[e]=a.keys[e+1];a.keys.pop();a.numberActives--;this._diskWrite(a);return!0};w.Tree.prototype._mergeNodes=function(a,b,c){var e,g;e=this._allocateNode();e.isLeaf=!0;for(g=0;g<a.numberActives;g++)e.keys[g]=
a.keys[g],e.children[g]=a.children[g];e.children[a.numberActives]=a.children[a.numberActives];e.keys[a.numberActives]=b;for(g=0;g<c.numberActives;g++)e.keys[g+a.numberActives+1]=c.keys[g],e.children[g+a.numberActives+1]=c.children[g];e.children[2*this.order-1]=c.children[c.numberActives];e.numberActives=a.numberActives+c.numberActives+1;e.isLeaf=a.isLeaf;e.level=a.level;this._diskWrite(e);return e};w.Tree.prototype.audit=function(a){var b=[],c=[],e=this,g=function(g){for(var h=0;h<c.length;h++)if(e.comparator(c[h],
g)===0){var d=" !!! duplicated key "+g;a===!0&&console.log(d);b.push(d)}},h=null,e=this;this.walkNodes(function(f){a===!0&&(console.log("--- Node at "+f.level+" level"),console.log(" - leaf? "+f.isLeaf),console.log(" - num actives? "+f.numberActives),console.log(" - keys: "));for(var d=f.numberActives;d<f.keys.length;d++)f.keys[d]!=null&&a===!0&&(console.log(" * warning : redundant key data"),b.push(" * warning : redundant key data"));for(d=f.numberActives+1;d<f.children.length;d++)f.children[d]!=
null&&a===!0&&(console.log(" * warning : redundant children data"),b.push(" * warning : redundant key data"));if(f.isLeaf===!1)for(d=0;d<f.numberActives;d++){var k=e._diskRead(f.children[d]).keys[e._diskRead(f.children[d]).numberActives-1].key,l=e._diskRead(f.children[d+1]).keys[0].key;a===!0&&console.log("   "+f.keys[d].key+"("+k+","+l+")");if(e.comparator(f.keys[d].key,k)===-1){var j=" !!! value max left "+k+" > key "+f.keys[d].key;a===!0&&console.log(j);b.push(j)}e.comparator(f.keys[d].key,l)===
1&&(j=" !!! value min right "+l+" < key "+f.keys[d].key,a===!0&&console.log(j),b.push(j));g(f.keys[d].key);c.push(f.keys[d].key)}else{h===null?h=f.level:h!=f.level&&(j=" !!! Leaf node with wrong level value",a===!0&&console.log(j),b.push(j));for(d=0;d<f.numberActives;d++)a===!0&&console.log(" "+f.keys[d].key),g(f.keys[d].key),c.push(f.keys[d].key)}f!=e.root&&(f.numberActives>2*e.order-1&&(a===!0&&(j=" !!!! MAX num keys restriction violated "),console.log(j),b.push(j)),f.numberActives<e.order-1&&(a===
!0&&(j=" !!!! MIN num keys restriction violated "),console.log(j),b.push(j)))});return b};w.Tree.prototype._getMaxKeyPos=function(a){for(var b={};;){if(a===null)break;if(a.isLeaf===!0){b.node=a;b.index=a.numberActives-1;break}else b.node=a,b.index=a.numberActives-1,a=this._diskRead(a.children[a.numberActives])}return b};w.Tree.prototype._getMinKeyPos=function(a){for(var b={};;){if(a===null)break;if(a.isLeaf===!0){b.node=a;b.index=0;break}else b.node=a,b.index=0,a=this._diskRead(a.children[0])}return b};
w.Node=function(){this.numberActives=0;this.isLeaf=null;this.keys=[];this.children=[];this.level=0};var C={NodeKey:function(a,b){this.subject=a.subject;this.predicate=a.predicate;this.object=a.object;this.graph=a.graph;this.order=b}};C.NodeKey.prototype.comparator=function(a){for(var b=0;b<this.order.length;b++){var c=this.order[b];if(a[c]==null)break;else if(this[c]<a[c])return-1;else if(this[c]>a[c])return 1}return 0};C.Pattern=function(a){this.subject=a.subject;this.predicate=a.predicate;this.object=
a.object;this.graph=a.graph;this.indexKey=[];this.keyComponents={};for(var b=[],c=[],a=["subject","predicate","object","graph"],e=0;e<a.length;e++)typeof this[a[e]]==="string"?(c.push(a[e]),this.keyComponents[a[e]]=null):(b.push(a[e]),this.keyComponents[a[e]]=this[a[e]],this.indexKey.push(a[e]));this.order=b.concat(c);this.key=new C.NodeKey(this.keyComponents,this.order)};var F={Tree:function(a,b){if(arguments!=0)this.componentOrder=a.componentOrder,w.Tree.call(this,a.order,a.name,a.persistent,a.cacheMaxSize),
this.comparator=function(a,b){for(var g=0;g<this.componentOrder.length;g++){var d=this.componentOrder[g],f=a[d],d=b[d];if(f<d)return-1;else if(f>d)return 1}return 0},this.rangeComparator=function(a,b){for(var g=0;g<this.componentOrder.length;g++){var d=this.componentOrder[g];if(b[d]==null||a[d]==null)break;else if(a[d]<b[d])return-1;else if(a[d]>b[d])return 1}return 0},b!=null&&b(this)}};m["extends"](w.Tree,F.Tree);F.Tree.prototype.insert=function(a,b){w.Tree.prototype.insert.call(this,a,null);b&&
b(!0);return!0};F.Tree.prototype.search=function(a,b){var c=w.Tree.prototype.search.call(this,a,!0);b&&b(c);return c};F.Tree.prototype.range=function(a,b){var c=null,c=typeof this.root==="string"?this._rangeTraverse(this,this._diskRead(this.root),a):this._rangeTraverse(this,this.root,a);b&&b(c);return c};F.Tree.prototype._rangeTraverse=function(a,b,c){for(var c=c.key,e=[],g=[b],d;g.length>0;){b=g.shift();for(d=0;d<b.numberActives&&a.rangeComparator(b.keys[d].key,c)===-1;)d++;if(b.isLeaf===!0)for(;d<
b.numberActives&&a.rangeComparator(b.keys[d].key,c)===0;)e.push(b.keys[d].key),d++;else{var f=a._diskRead(b.children[d]);for(g.push(f);;)if(d<b.numberActives&&a.rangeComparator(b.keys[d].key,c)===0)e.push(b.keys[d].key),d++,f=a._diskRead(b.children[d]),g.push(f);else break}}return e};var E={QuadBackend:function(a,b){if(arguments!=0){this.indexMap={};this.treeOrder=a.treeOrder;this.indices=["SPOG","GP","OGS","POG","GSP","OS"];this.componentOrders={SPOG:["subject","predicate","object","graph"],GP:["graph",
"predicate","subject","object"],OGS:["object","graph","subject","predicate"],POG:["predicate","object","graph","subject"],GSP:["graph","subject","predicate","object"],OS:["object","subject","predicate","graph"]};for(var c=0;c<this.indices.length;c++){var e=this.indices[c];this.indexMap[e]=new F.Tree({order:this.treeOrder,componentOrder:this.componentOrders[e],persistent:a.persistent,name:(a.name||"")+e,cacheMaxSize:a.cacheMaxSize})}b&&b(this)}}};E.QuadBackend.prototype.clear=function(){for(var a=
0;a<this.indices.length;a++)this.indexMap[this.indices[a]].clear()};E.QuadBackend.prototype._indexForPattern=function(a){for(var a=a.indexKey,b=this.indices,c=0;c<b.length;c++)for(var e=b[c],g=this.componentOrders[e],d=0;d<g.length;d++){if(m.include(a,g[d])===!1)break;if(d==a.length-1)return e}return"SPOG"};E.QuadBackend.prototype.index=function(a,b){for(var c=0;c<this.indices.length;c++)this.indexMap[this.indices[c]].insert(a);b&&b(!0);return!0};E.QuadBackend.prototype.range=function(a,b){var c=
this.indexMap[this._indexForPattern(a)].range(a);b&&b(c);return c};E.QuadBackend.prototype.search=function(a,b){var c=this.indexMap[this.indices[0]].search(a);b&&b(c!=null);return c!=null};E.QuadBackend.prototype["delete"]=function(a,b){for(var c,e=0;e<this.indices.length;e++)c=this.indices[e],c=this.indexMap[c],c["delete"](a);b&&b(!0);return!0};var y={Lexicon:function(a){this.uriToOID={};this.OIDToUri={};this.literalToOID={};this.OIDToLiteral={};this.blankToOID={};this.OIDToBlank={};this.defaultGraphOid=
0;this.defaultGraphUri="https://github.com/antoniogarrote/rdfstore-js#default_graph";this.defaultGraphUriTerm={token:"uri",prefix:null,suffix:null,value:this.defaultGraphUri,oid:this.defaultGraphOid};this.oidCounter=1;this.knownGraphs={};a!=null&&a(this)}};y.Lexicon.prototype.registerGraph=function(a){a!=this.defaultGraphOid&&(this.knownGraphs[a]=!0);return!0};y.Lexicon.prototype.registeredGraphs=function(a){var b=[],c;for(c in this.knownGraphs)a===!0?b.push(this.OIDToUri["u"+c]):b.push(c);return b};
y.Lexicon.prototype.registerUri=function(a){if(a===this.defaultGraphUri)return this.defaultGraphOid;else{if(this.uriToOID[a]==null){var b=this.oidCounter;this.oidCounter++;this.uriToOID[a]=[b,0];this.OIDToUri["u"+b]=a}else{var c=this.uriToOID[a],b=c[0];this.uriToOID[a]=[b,c[1]+1]}return b}};y.Lexicon.prototype.resolveUri=function(a){return a===this.defaultGraphUri?this.defaultGraphOid:(a=this.uriToOID[a],a!=null?a[0]:-1)};y.Lexicon.prototype.resolveUriCost=function(a){return a===this.defaultGraphUri?
this.defaultGraphOid:(a=this.uriToOID[a],a!=null?a[1]:-1)};y.Lexicon.prototype.registerBlank=function(){var a=this.oidCounter;this.oidCounter++;a=""+a;this.OIDToBlank[a]=!0;return a};y.Lexicon.prototype.resolveBlank=function(){var a=this.oidCounter;this.oidCounter++;return""+a};y.Lexicon.prototype.resolveBlankCost=function(){return 0};y.Lexicon.prototype.registerLiteral=function(a){if(this.literalToOID[a]==null){var b=this.oidCounter;this.oidCounter++;this.literalToOID[a]=[b,0];this.OIDToLiteral["l"+
b]=a}else{var c=this.literalToOID[a],b=c[0];this.literalToOID[a]=[b,c[1]+1]}return b};y.Lexicon.prototype.resolveLiteral=function(a){a=this.literalToOID[a];return a!=null?a[0]:-1};y.Lexicon.prototype.resolveLiteralCost=function(a){a=this.literalToOID[a];return a!=null?a[1]:0};y.Lexicon.prototype.parseLiteral=function(a){var b=a.lastIndexOf("@");if(b!=-1&&a[b-1]==='"'&&a.substring(b,a.length).match(/^@[a-zA-Z\-]+$/g)!=null){var c=a.substring(1,b-1),a=a.substring(b+1,a.length);return{token:"literal",
value:c,lang:a}}b=a.lastIndexOf("^^");if(b!=-1&&a[b-1]==='"'&&a[b+2]==="<"&&a[a.length-1]===">")return c=a.substring(1,b-1),a=a.substring(b+3,a.length-1),{token:"literal",value:c,type:a};c=a;a[0]==='"'&&a[a.length-1]==='"'&&(c=a.substring(1,a.length-1));return{token:"literal",value:c}};y.Lexicon.prototype.parseUri=function(a){return{token:"uri",value:a}};y.Lexicon.prototype.retrieve=function(a){try{if(a===this.defaultGraphOid)return{token:"uri",value:this.defaultGraphUri,prefix:null,suffix:null,defaultGraph:!0};
else{var b=this.OIDToUri["u"+a];if(b!=null)return this.parseUri(b);else{var c=this.OIDToLiteral["l"+a];if(c!=null)return this.parseLiteral(c);else if(this.OIDToBlank[""+a]!=null)return{token:"blank",value:"_:"+a};else throw"Null value for OID";}}}catch(e){throw console.log("error in lexicon retrieving OID:"),console.log(a),e.message||e.stack?(e.message&&console.log(e.message),e.stack&&console.log(e.stack)):console.log(e),Error("Unknown retrieving OID in lexicon:"+a);}};y.Lexicon.prototype.clear=function(){this.uriToOID=
{};this.OIDToUri={};this.literalToOID={};this.OIDToLiteral={};this.blankToOID={};this.OIDToBlank={}};y.Lexicon.prototype.unregister=function(a,b){try{return this.unregisterTerm(a.subject.token,b.subject),this.unregisterTerm(a.predicate.token,b.predicate),this.unregisterTerm(a.object.token,b.object),a.graph!=null&&this.unregisterTerm(a.graph.token,b.graph),!0}catch(c){return console.log("Error unregistering quad"),console.log(c.message),!1}};y.Lexicon.prototype.unregisterTerm=function(a,b){if(a===
"uri"){if(b!=this.defaultGraphOid){var c="u"+b,e=this.OIDToUri[c],g=this.uriToOID[e],d=g[1];if(""+g[0]===""+b)d===0?(delete this.OIDToUri[c],delete this.uriToOID[e],delete this.knownGraphs[b]):this.uriToOID[e]=[b,d-1];else throw"Not matching OID : "+b+" vs "+g[0];}}else if(a==="literal")if(this.oidCounter++,c="l"+b,e=this.OIDToLiteral[c],g=this.literalToOID[e],d=g[1],""+g[0]===""+b)d===0?(delete this.OIDToLiteral[c],delete this.literalToOID[e]):this.literalToOID[e]=[b,d-1];else throw"Not matching OID : "+
b+" vs "+g[0];else a==="blank"&&delete this.OIDToBlank[""+b]};var H={};H.load=function(a,b,c){jQuery.ajax({url:a,headers:{Accept:b},success:function(a,b,d){if((""+d.status)[0]=="2"){for(var b=d.getAllResponseHeaders().split("\n"),d={},f=0;f<b.length;f++){var i=b[f].split(":");d[i[0]]=i[1]}c(!0,{headers:d,data:a})}},error:function(a){(""+a.status)[0]=="3"?redirection==0?c(!1,500):(a=a.getAllResponseHeaders().Location||a.getAllResponseHeaders().location,a!=null?H.load(a,b,c,redirection-1):c(!1,500)):
c(!1,a.statusCode())}})};var v={AbstractQueryTree:function(){}};v.AbstractQueryTree.prototype.parseQueryString=function(a){return SparqlParser.parser.parse(a)};v.AbstractQueryTree.prototype.parseExecutableUnit=function(a){if(a.kind==="select")return this.parseSelect(a);else if(a.kind==="ask")return this.parseSelect(a);else if(a.kind==="modify")return this.parseSelect(a);else if(a.kind==="construct")return this.parseSelect(a);else if(a.kind==="insertdata")return this.parseInsertData(a);else if(a.kind===
"deletedata")return this.parseInsertData(a);else if(a.kind==="load")return a;else if(a.kind==="clear")return a;else if(a.kind==="drop")return a;else if(a.kind==="create")return a;else throw Error("unknown executable unit: "+a.kind);};v.AbstractQueryTree.prototype.parseSelect=function(a){return a==null?(console.log("error parsing query"),null):(a.pattern=this.build(a.pattern,{freshCounter:0}),a)};v.AbstractQueryTree.prototype.parseInsertData=function(a){return a==null?(console.log("error parsing query"),
null):a};v.AbstractQueryTree.prototype.build=function(a,b){if(a.token==="groupgraphpattern")return this._buildGroupGraphPattern(a,b);else if(a.token==="basicgraphpattern"){var c={kind:"BGP",value:a.triplesContext};return c=v.translatePathExpressionsInBGP(c,b)}else if(a.token==="graphunionpattern"){var c=this.build(a.value[0],b),e=this.build(a.value[1],b);return{kind:"UNION",value:[c,e]}}else if(a.token==="graphgraphpattern")return{kind:"GRAPH",value:this.build(a.value,b),graph:a.graph};else throw Error("not supported token in query:"+
a.token);};v.translatePathExpressionsInBGP=function(a,b){var c,e=[],g,d;for(d=0;d<a.value.length;d++)if(a.value[d].predicate&&a.value[d].predicate.token==="path"){c=a.value[d];g=a.value.slice(d+1);var f=v.translatePathExpression(c,b);c=null;if(f.kind==="BGP")e=e.concat(f.value);else if(f.kind==="ZERO_OR_MORE_PATH"||f.kind==="ONE_OR_MORE_PATH"){d=e.length>0?{kind:"JOIN",lvalue:{kind:"BGP",value:e},rvalue:f}:f;if(f.kind==="ZERO_OR_MORE_PATH")if(f.y.token==="var"&&f.y.value.indexOf("fresh:")===0&&f.x.token===
"var"&&f.x.value.indexOf("fresh:")===0)for(var i=0;i<a.value.length;i++){if(a.value[i].object&&a.value[i].object.token==="var"&&a.value[i].object.value===f.x.value)c=m.clone(a.value[i]),c.object=f.y}else if(f.y.token==="var"&&f.y.value.indexOf("fresh:")===0)for(i=0;i<a.value.length;i++)if(a.value[i].subject&&a.value[i].subject.token==="var"&&a.value[i].subject.value===f.y.value)c=m.clone(a.value[i]),c.subject=f.x;return g.length>0?(f=v.translatePathExpressionsInBGP({kind:"BGP",value:g},b),c!=null?
(e=e.concat([c]).concat(g),{kind:"UNION",value:[{kind:"JOIN",lvalue:d,rvalue:f},{kind:"BGP",value:e}]}):{kind:"JOIN",lvalue:d,rvalue:f}):d}else return f}else e.push(a.value[d]);a.value=e;return a};v.translatePathExpression=function(a,b){if(a.predicate.kind==="element")if(a.predicate.modifier==="+"){a.predicate.modifier=null;var c=v.translatePathExpression(a,b);return{kind:"ONE_OR_MORE_PATH",path:c,x:a.subject,y:a.object}}else return a.predicate.modifier==="*"?(a.predicate.modifier=null,c=v.translatePathExpression(a,
b),{kind:"ZERO_OR_MORE_PATH",path:c,x:a.subject,y:a.object}):(a.predicate=a.predicate.value,{kind:"BGP",value:[a]});else if(a.predicate.kind==="sequence"){for(var c=a.subject,e=a.object,g=a.graph,d,f,i=[],k=0;k<a.predicate.value.length;k++){k!=a.predicate.value.length-1?(d={token:"var",value:"fresh:"+b.freshCounter},b.freshCounter++):d=e;f={subject:c,predicate:a.predicate.value[k],object:d};if(g!=null)f.graph=m.clone(g);i.push(f);k!=a.predicate.value.length-1&&(c=m.clone(d))}return v.translatePathExpressionsInBGP({kind:"BGP",
value:i},b)}};v.AbstractQueryTree.prototype._buildGroupGraphPattern=function(a,b){for(var c=a.filters||[],e={kind:"EMPTY_PATTERN"},g=0;g<a.patterns.length;g++){var d=a.patterns[g];d.token==="optionalgraphpattern"?(d=this.build(d.value,b),e=d.kind==="FILTER"?{kind:"LEFT_JOIN",lvalue:e,rvalue:d.value,filter:d.filter}:{kind:"LEFT_JOIN",lvalue:e,rvalue:d,filter:!0}):(d=this.build(d,b),e=e.kind=="EMPTY_PATTERN"?d:{kind:"JOIN",lvalue:e,rvalue:d})}if(c.length!=0)if(e.kind==="EMPTY_PATTERN")return{kind:"FILTER",
filter:c,value:e};else if(e.kind==="LEFT_JOIN"&&e.filter===!0)return{kind:"FILTER",filter:c,value:e};else if(e.kind==="LEFT_JOIN")return{kind:"FILTER",filter:c,value:e};else if(e.kind==="JOIN")return{kind:"FILTER",filter:c,value:e};else if(e.kind==="UNION")return{kind:"FILTER",filter:c,value:e};else if(e.kind==="GRAPH")return{kind:"FILTER",filter:c,value:e};else if(e.kind==="BGP")return{kind:"FILTER",filter:c,value:e};else throw Error("Unknow kind of algebra expression: "+e.kind);else return e};v.AbstractQueryTree.prototype.collectBasicTriples=
function(a,b){b==null&&(b=[]);if(a.kind==="select")b=this.collectBasicTriples(a.pattern,b);else if(a.kind==="BGP")b=b.concat(a.value);else if(a.kind==="ZERO_OR_MORE_PATH")b=this.collectBasicTriples(a.path);else if(a.kind==="UNION")b=this.collectBasicTriples(a.value[0],b),b=this.collectBasicTriples(a.value[1],b);else if(a.kind==="GRAPH")b=this.collectBasicTriples(a.value,b);else if(a.kind==="LEFT_JOIN"||a.kind==="JOIN")b=this.collectBasicTriples(a.lvalue,b),b=this.collectBasicTriples(a.rvalue,b);else if(a.kind===
"FILTER")b=this.collectBasicTriples(a.value,b);else if(a.kind==="construct")b=this.collectBasicTriples(a.pattern,b);else if(a.kind!=="EMPTY_PATTERN")throw"Unknown pattern: "+a.kind;return b};v.AbstractQueryTree.prototype.bind=function(a,b){if(a.graph!=null&&a.graph.token&&a.graph.token==="var"&&b[a.graph.value]!=null)a.graph=b[a.graph.value];if(a.filter!=null){for(var c=[],e=0;e<a.filter.length;e++)a.filter[e].value=this._bindFilter(a.filter[e].value,b),c.push(a.filter[e]);a.filter=c}if(a.kind===
"select")a.pattern=this.bind(a.pattern,b);else if(a.kind==="BGP")a.value=this._bindTripleContext(a.value,b);else if(a.kind==="ZERO_OR_MORE_PATH"){a.path=this._bindTripleContext(a.path,b);if(a.x&&a.x.token==="var"&&b[a.x.value]!=null)a.x=b[a.x.value];if(a.y&&a.y.token==="var"&&b[a.y.value]!=null)a.y=b[a.y.value]}else if(a.kind==="UNION")a.value[0]=this.bind(a.value[0],b),a.value[1]=this.bind(a.value[1],b);else if(a.kind==="GRAPH")a.value=this.bind(a.value,b);else if(a.kind==="LEFT_JOIN"||a.kind===
"JOIN")a.lvalue=this.bind(a.lvalue,b),a.rvalue=this.bind(a.rvalue,b);else if(a.kind==="FILTER")a.filter=this._bindFilter(a.filter[e].value,b);else if(a.kind!=="EMPTY_PATTERN")throw"Unknown pattern: "+a.kind;return a};v.AbstractQueryTree.prototype._bindTripleContext=function(a,b){for(var c=0;c<a.length;c++){delete a[c].graph;delete a[c].variables;for(var e in a[c]){var g=a[c][e];g.token==="var"&&b[g.value]!=null&&(a[c][e]=b[g.value])}}return a};v.AbstractQueryTree.prototype._bindFilter=function(a,
b){if(a.expressionType!=null){var c=a.expressionType;if(c=="relationalexpression")a.op1=this._bindFilter(a.op1,b),a.op2=this._bindFilter(a.op2,b);else if(c=="conditionalor"||c=="conditionaland")for(c=0;c<a.operands.length;c++)a.operands[c]=this._bindFilter(a.operands[c],b);else if(c=="additiveexpression"){a.summand=this._bindFilter(a.summand,b);for(c=0;c<a.summands.length;c++)a.summands[c].expression=this._bindFilter(a.summands[c].expression,b)}else if(c=="builtincall")for(c=0;c<a.args.length;c++)a.args[c]=
this._bindFilter(a.args[c],b);else if(c=="multiplicativeexpression"){a.factor=this._bindFilter(a.factor,b);for(c=0;c<a.factors.length;c++)a.factors[c].expression=this._bindFilter(a.factors[c].expression,b)}else if(c=="unaryexpression")a.expression=this._bindFilter(a.expression,b);else if(c=="irireforfunction")for(c=0;c<a.factors.args;c++)a.args[c]=this._bindFilter(a.args[c],b);else if(c=="atomic"&&a.primaryexpression=="var"&&b[a.value.value]!=null)c=b[a.value.value],a.primaryexpression=c.token===
"uri"?"iri":"literal",a.value=c}return a};v.AbstractQueryTree.prototype.replace=function(a,b,c,e){if(a.graph!=null&&a.graph.token&&a.graph.token===b.token&&a.graph.value==b.value)a.graph=m.clone(c);if(a.filter!=null){for(var g=[],d=0;d<a.filter.length;d++)a.filter[d].value=this._replaceFilter(a.filter[d].value,b,c,e),g.push(a.filter[d]);a.filter=g}if(a.kind==="select")a.pattern=this.replace(a.pattern,b,c,e);else if(a.kind==="BGP")a.value=this._replaceTripleContext(a.value,b,c,e);else if(a.kind===
"ZERO_OR_MORE_PATH"){a.path=this._replaceTripleContext(a.path,b,c,e);if(a.x&&a.x.token===b.token&&a.value===b.value)a.x=m.clone(c);if(a.y&&a.y.token===b.token&&a.value===b.value)a.y=m.clone(c)}else if(a.kind==="UNION")a.value[0]=this.replace(a.value[0],b,c,e),a.value[1]=this.replace(a.value[1],b,c,e);else if(a.kind==="GRAPH")a.value=this.replace(a.value,b,c);else if(a.kind==="LEFT_JOIN"||a.kind==="JOIN")a.lvalue=this.replace(a.lvalue,b,c,e),a.rvalue=this.replace(a.rvalue,b,c,e);else if(a.kind==="FILTER")a.value=
this._replaceFilter(a.value,b,c,e);else if(a.kind!=="EMPTY_PATTERN")throw"Unknown pattern: "+a.kind;return a};v.AbstractQueryTree.prototype._replaceTripleContext=function(a,b,c,e){for(var g=0;g<a.length;g++)for(var d in a[g]){var f=a[g][d];if(f.token==="var"&&b.token==="var"&&f.value===b.value)a[g][d]=c;else if(f.token==="blank"&&b.token==="blank"&&f.value===b.value)a[g][d]=c;else if((f.token==="literal"||f.token==="uri")&&(b.token==="literal"||b.token==="uri")&&f.token===b.token&&m.lexicalFormTerm(f,
e)[f.token]===m.lexicalFormTerm(b,e)[f.token])a[g][d]=c}return a};v.AbstractQueryTree.prototype._replaceFilter=function(a,b,c,e){if(a.expressionType!=null){var g=a.expressionType;if(g=="relationalexpression")a.op1=this._replaceFilter(a.op1,b,c,e),a.op2=this._replaceFilter(a.op2,b,c,e);else if(g=="conditionalor"||g=="conditionaland")for(g=0;g<a.operands.length;g++)a.operands[g]=this._replaceFilter(a.operands[g],b,c,e);else if(g=="additiveexpression"){a.summand=this._replaceFilter(a.summand,b,c,e);
for(g=0;g<a.summands.length;g++)a.summands[g].expression=this._replaceFilter(a.summands[g].expression,b,c,e)}else if(g=="builtincall")for(g=0;g<a.args.length;g++)a.args[g]=this._replaceFilter(a.args[g],b,c,e);else if(g=="multiplicativeexpression"){a.factor=this._replaceFilter(a.factor,b,c,e);for(g=0;g<a.factors.length;g++)a.factors[g].expression=this._replaceFilter(a.factors[g].expression,b,c,e)}else if(g=="unaryexpression")a.expression=this._replaceFilter(a.expression,b,c,e);else if(g=="irireforfunction")for(g=
0;g<a.factors.args;g++)a.args[g]=this._replaceFilter(a.args[g],b,c,e);else if(g=="atomic"){e=null;if(a.primaryexpression==b.token&&a.value==b.value)e=c.value;else if(a.primaryexpression=="iri"&&b.token=="uri"&&a.value==b.value)e=c.value;if(e!=null)a.primaryexpression=c.token==="uri"?"iri":c.token,a.value=e}}return a};v.AbstractQueryTree.prototype.treeWithUnion=function(a){if(a==null)return!1;if(a.kind==null)return!1;if(a.kind==="select")return this.treeWithUnion(a.pattern);else if(a.kind==="BGP")return this.treeWithUnion(a.value);
else if(a.kind==="ZERO_OR_MORE_PATH")return!1;else if(a.kind==="UNION")if(console.log("UNION!!"),a.value[0].value!=null&&a.value[0].value.variables!=null&&a.value[1].value!=null&&a.value[1].value.variables!=null){if(console.log("COMPARING:"+a.value[0].variables.join("/")),console.log("VS "+a.values[1].variables.join("/")),a.value[0].variables.join("/")===a.values[1].variables.join("/"))return this.treeWithUnion(a.value[0])?!0:this.treeWithUnion(a.value[1])}else return!0;else if(a.kind==="GRAPH")return!1;
else if(a.kind==="LEFT_JOIN"||a.kind==="JOIN")if(this.treeWithUnion(a.lvalue))return!0;else this.treeWithUnion(a.rvalue);else return!1};var d={checkFilters:function(a,b,c,e,g,h){var f=a.filter,i=[];if(f==null||a.length!=null)return b;for(a=0;a<f.length;a++){for(var b=d.run(f[a].value,b,c,e,g,h),k=[],l=0;l<b.length;l++)b[l].__nullify__!=null?i.push(b[l]):k.push(b[l]);b=k}return b.concat(i)}};d.boundVars=function(a){if(a.expressionType!=null){var b=a.expressionType;if(b=="relationalexpression")return b=
a.op2,d.boundVars(a.op1)+d.boundVars(b);else if(b=="conditionalor"||b=="conditionaland"){for(var c=[],b=0;b<a.operands;b++)c=c.concat(d.boundVars(a.operands[b]));return c}else if(b=="builtincall")if(a.args==null)return[];else{c=[];for(b=0;b<a.args.length;b++)c=c.concat(d.boundVars(a.args[b]));return c}else if(b=="multiplicativeexpression"){c=d.boundVars(a.factor);for(b=0;b<a.factors.length;b++)c=c.concat(d.boundVars(a.factors[b].expression));return c}else if(b=="additiveexpression"){c=d.boundVars(a.summand);
for(b=0;b<a.summands.length;b++)c=c.concat(d.boundVars(a.summands[b].expression));return c}else if(b=="regex")return c=d.boundVars(a.expression1),c.concat(d.boundVars(a.expression2));else if(b=="unaryexpression")return d.boundVars(a.expression);else if(b=="atomic")return a.primaryexpression=="var"?[a.value]:[]}else throw console.log("ERROR"),console.log(a),"Cannot find bound expressions in a no expression token";};d.run=function(a,b,c,e,g,h){for(var f=h.copyDenormalizedBindings(b,g.outCache),i=[],
k=0;k<b.length;k++){var l=d.runFilter(a,f[k],h,e,g),l=d.ebv(l);d.isEbvError(l)?c&&(l={__nullify__:!0,bindings:b[k]},i.push(l)):l===!0?i.push(b[k]):c&&(l={__nullify__:!0,bindings:b[k]},i.push(l))}return i};d.collect=function(a,b,c,e,g){for(var h=g.copyDenormalizedBindings(b,e.outCache),f=[],i=0;i<h.length;i++){var k=d.runFilter(a,h[i],g,c,e);f.push({binding:b[i],value:k})}return f};d.runDistinct=function(){};d.runAggregator=function(a,b,c,e,g){if(b==null||b.length===0)return d.ebvError();else if(a.token===
"variable"&&a.kind=="var")return b[0][a.value.value];else if(a.token==="variable"&&a.kind==="aliased")if(a.expression.expressionType==="atomic"&&a.expression.primaryexpression==="var")return b[0][a.expression.value.value];else if(a.expression.expressionType==="aggregate")if(a.expression.aggregateType==="max"){for(var h=null,f=0;f<b.length;f++){var i=b[f],i=d.runFilter(a.expression.expression,i,c,e,g);d.isEbvError(i)||(h===null?h=i:d.runLtFunction(h,i).value===!0&&(h=i))}return h===null?d.ebvError():
h}else if(a.expression.aggregateType==="min"){h=null;for(f=0;f<b.length;f++)i=b[f],i=d.runFilter(a.expression.expression,i,c,e,g),d.isEbvError(i)||(h===null?h=i:d.runGtFunction(h,i).value===!0&&(h=i));return h===null?d.ebvError():h}else if(a.expression.aggregateType==="count"){var h={},k=0;if(a.expression.expression==="*")if(a.expression.distinct!=null&&a.expression.distinct!="")for(f=0;f<b.length;f++){var i=b[f],l=m.hashTerm(i);h[l]==null&&(h[l]=!0,k++)}else k=b.length;else for(f=0;f<b.length;f++)i=
b[f],i=d.runFilter(a.expression.expression,i,c,e,g),d.isEbvError(i)||(a.expression.distinct!=null&&a.expression.distinct!=""?(l=m.hashTerm(i),h[l]==null&&(h[l]=!0,k++)):k++);return{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:""+k}}else if(a.expression.aggregateType==="avg"){for(var h={},j={token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:"0"},f=k=0;f<b.length;f++)i=b[f],i=d.runFilter(a.expression.expression,i,c,e,g),d.isEbvError(i)||(a.expression.distinct!=
null&&a.expression.distinct!=""?(l=m.hashTerm(i),h[l]==null&&(h[l]=!0,d.isNumeric(i)&&(j=d.runSumFunction(j,i),k++))):d.isNumeric(i)&&(j=d.runSumFunction(j,i),k++));a=d.runDivFunction(j,{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:""+k});a.value=""+a.value;return a}else if(a.expression.aggregateType==="sum"){h={};j={token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:"0"};for(f=0;f<b.length;f++)i=b[f],i=d.runFilter(a.expression.expression,i,c,e,g),d.isEbvError(i)||
(a.expression.distinct!=null&&a.expression.distinct!=""?(l=m.hashTerm(i),h[l]==null&&(h[l]=!0,d.isNumeric(i)&&(j=d.runSumFunction(j,i)))):d.isNumeric(i)&&(j=d.runSumFunction(j,i)));j.value=""+j.value;return j}else return i=d.runFilter(aggregate.expression,b[0],e,{blanks:{},outCache:{}})};d.runFilter=function(a,b,c,e,g){if(a.expressionType!=null){var h=a.expressionType;if(h=="relationalexpression"){var h=d.runFilter(a.op1,b,c,e,g),f=d.runFilter(a.op2,b,c,e,g);return d.runRelationalFilter(a,h,f,b,c,
e,g)}else if(h=="conditionalor")return d.runOrFunction(a,b,c,e,g);else if(h=="conditionaland")return d.runAndFunction(a,b,c,e,g);else if(h=="additiveexpression")return d.runAddition(a.summand,a.summands,b,c,e,g);else if(h=="builtincall")return d.runBuiltInCall(a.builtincall,a.args,b,c,e,g);else if(h=="multiplicativeexpression")return d.runMultiplication(a.factor,a.factors,b,c,e,g);else if(h=="unaryexpression")return d.runUnaryExpression(a.unaryexpression,a.expression,b,c,e,g);else if(h=="irireforfunction")return d.runIriRefOrFunction(a.iriref,
a.args,b,c,e,g);else if(h=="regex")return d.runRegex(a.text,a.pattern,a.flags,b,c,e,g);else if(h=="atomic")if(a.primaryexpression=="var")return b[a.value.value];else{if(typeof a.value=="object"&&!(a.value.type==null||typeof a.value.type!="object"))a.value.type=m.lexicalFormBaseUri(a.value.type,g);return a.value}else throw"Unknown filter expression type";}else throw"Cannot find bound expressions in a no expression token";};d.isRDFTerm=function(a){return a==null?!1:a.token&&a.token=="literal"||a.token&&
a.token=="uri"||a.token&&a.token=="blank"?!0:!1};d.RDFTermEquality=function(a,b,c,e){return a.token==="literal"&&b.token==="literal"?a.lang==b.lang&&a.type==b.type&&a.value==b.value?!0:a.type!=null&&b.type!=null?d.ebvError():d.isSimpleLiteral(a)&&b.type!=null?d.ebvError():d.isSimpleLiteral(b)&&a.type!=null?d.ebvError():!1:a.token==="uri"&&b.token==="uri"?m.lexicalFormBaseUri(a,e)==m.lexicalFormBaseUri(b,e):a.token==="blank"&&b.token==="blank"?a.value==b.value:!1};d.isInteger=function(a){return a==
null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#integer"||a.type=="http://www.w3.org/2001/XMLSchema#decimal"||a.type=="http://www.w3.org/2001/XMLSchema#double"||a.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||a.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#long"||a.type=="http://www.w3.org/2001/XMLSchema#int"||a.type=="http://www.w3.org/2001/XMLSchema#short"||a.type=="http://www.w3.org/2001/XMLSchema#byte"||
a.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedShort"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||a.type=="http://www.w3.org/2001/XMLSchema#positiveInteger"?!0:!1:!1};d.isFloat=function(a){return a==null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#float"?!0:!1:!1};d.isDecimal=function(a){return a==
null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#decimal"?!0:!1:!1};d.isDouble=function(a){return a==null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#double"?!0:!1:!1};d.isNumeric=function(a){return a==null?!1:a.token==="literal"?a.type=="http://www.w3.org/2001/XMLSchema#integer"||a.type=="http://www.w3.org/2001/XMLSchema#decimal"||a.type=="http://www.w3.org/2001/XMLSchema#float"||a.type=="http://www.w3.org/2001/XMLSchema#double"||a.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||
a.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#long"||a.type=="http://www.w3.org/2001/XMLSchema#int"||a.type=="http://www.w3.org/2001/XMLSchema#short"||a.type=="http://www.w3.org/2001/XMLSchema#byte"||a.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedShort"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||
a.type=="http://www.w3.org/2001/XMLSchema#positiveInteger"?!0:!1:!1};d.isSimpleLiteral=function(a){return a&&a.token=="literal"?a.type==null&&a.lang==null?!0:!1:!1};d.isXsdType=function(a,b){return b&&b.token=="literal"?b.type=="http://www.w3.org/2001/XMLSchema#"+a:!1};d.ebv=function(a){if(a==null||d.isEbvError(a))return d.ebvError();else if(a.token&&a.token==="literal")if(a.type=="http://www.w3.org/2001/XMLSchema#integer"||a.type=="http://www.w3.org/2001/XMLSchema#decimal"||a.type=="http://www.w3.org/2001/XMLSchema#double"||
a.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||a.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#long"||a.type=="http://www.w3.org/2001/XMLSchema#int"||a.type=="http://www.w3.org/2001/XMLSchema#short"||a.type=="http://www.w3.org/2001/XMLSchema#byte"||a.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||a.type==
"http://www.w3.org/2001/XMLSchema#unsignedShort"||a.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||a.type=="http://www.w3.org/2001/XMLSchema#positiveInteger"){var b=parseFloat(a.value);return isNaN(b)?!1:parseFloat(a.value)!=0}else return a.type==="http://www.w3.org/2001/XMLSchema#boolean"?a.value==="true"||a.value===!0||a.value==="True":a.type==="http://www.w3.org/2001/XMLSchema#string"?a.value!="":a.type==="http://www.w3.org/2001/XMLSchema#dateTime"?new Date(a.value)!=null:d.isEbvError(a)?
a:a.type==null?a.value!=""?!0:!1:d.ebvError();else return a.value===!0};d.ebvTrue=function(){return{token:"literal",type:"http://www.w3.org/2001/XMLSchema#boolean",value:!0}};d.ebvFalse=function(){return{token:"literal",type:"http://www.w3.org/2001/XMLSchema#boolean",value:!1}};d.ebvError=function(){return{token:"literal",type:"https://github.com/antoniogarrote/js-tools/types#error",value:null}};d.isEbvError=function(a){return typeof a=="object"&&a!=null?a.type==="https://github.com/antoniogarrote/js-tools/types#error":
!1};d.ebvBoolean=function(a){return d.isEbvError(a)?a:a===!0?d.ebvTrue():d.ebvFalse()};d.runRelationalFilter=function(a,b,c,e,g,h,f){a=a.operator;if(a==="=")return d.runEqualityFunction(b,c,e,g,h,f);else if(a==="!="){b=d.runEqualityFunction(b,c,e,g,h,f);if(!d.isEbvError(b))b.value=!b.value;return b}else if(a==="<")return d.runLtFunction(b,c,e);else if(a===">")return d.runGtFunction(b,c,e);else if(a==="<=")return d.runLtEqFunction(b,c,e);else if(a===">=")return d.runGtEqFunction(b,c,e);else throw"Error applying relational filter, unknown operator";
};d.effectiveTypeValue=function(a){if(a.token=="literal")if(a.type=="http://www.w3.org/2001/XMLSchema#integer")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#decimal")return a=parseFloat(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#float")return a=parseFloat(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#double")return a=parseFloat(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger")return a=parseFloat(a.value);else if(a.type==
"http://www.w3.org/2001/XMLSchema#negativeInteger")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#long")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#int")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#short")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#byte")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger")return a=parseInt(a.value);
else if(a.type=="http://www.w3.org/2001/XMLSchema#unsignedLong")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#unsignedInt")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#unsignedShort")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#unsignedByte")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#positiveInteger")return a=parseInt(a.value);else if(a.type=="http://www.w3.org/2001/XMLSchema#date"||
a.type=="http://www.w3.org/2001/XMLSchema#dateTime")try{return m.parseISO8601(a.value)}catch(b){return null}else return a.type=="http://www.w3.org/2001/XMLSchema#boolean"?a.value===!0||a.value==="true"||a.value==="1"||a.value===1||a.value===!0?!0:a.value===!1||a.value==="false"||a.value==="0"||a.value===0||a.value===!1?!1:void 0:a.type=="http://www.w3.org/2001/XMLSchema#string"?a.value===null||a.value===void 0?void 0:""+a.value:a.value;else throw console.log("not implemented yet"),"value not supported in operations yet";
};d.runOrFunction=function(a,b,c,e,g){for(var h=null,f=0;f<a.operands.length;f++){var i=d.runFilter(a.operands[f],b,c,e,g);d.isEbvError(i)==!1&&(i=d.ebv(i));h==null?h=i:d.isEbvError(i)?h=d.isEbvError(h)?d.ebvError():h===!0?!0:d.ebvError():i===!0?h=!0:d.isEbvError(h)&&(h=d.ebvError())}return d.ebvBoolean(h)};d.runAndFunction=function(a,b,c,e,g){for(var h=null,f=0;f<a.operands.length;f++){var i=d.runFilter(a.operands[f],b,c,e,g);d.isEbvError(i)==!1&&(i=d.ebv(i));h==null?h=i:d.isEbvError(i)?h=d.isEbvError(h)?
d.ebvError():h===!0?d.ebvError():!1:i===!0?d.isEbvError(h)&&(h=d.ebvError()):h=!1}return d.ebvBoolean(h)};d.runEqualityFunction=function(a,b,c,e,g,h){if(d.isEbvError(a)||d.isEbvError(b))return d.ebvError();if(d.isNumeric(a)&&d.isNumeric(b))return c=d.effectiveTypeValue(a),g=d.effectiveTypeValue(b),isNaN(c)||isNaN(g)?d.ebvBoolean(d.RDFTermEquality(a,b,e,h)):d.ebvBoolean(c==g);else if((d.isSimpleLiteral(a)||d.isXsdType("string",a))&&(d.isSimpleLiteral(b)||d.isXsdType("string",b)))return d.ebvBoolean(d.effectiveTypeValue(a)==
d.effectiveTypeValue(b));else if(d.isXsdType("boolean",a)&&d.isXsdType("boolean",b))return d.ebvBoolean(d.effectiveTypeValue(a)==d.effectiveTypeValue(b));else if((d.isXsdType("dateTime",a)||d.isXsdType("date",a))&&(d.isXsdType("dateTime",b)||d.isXsdType("date",b))){if(d.isXsdType("dateTime",a)&&d.isXsdType("date",b))return d.ebvFalse();if(d.isXsdType("date",a)&&d.isXsdType("dateTime",b))return d.ebvFalse();a=m.compareDateComponents(a.value,b.value);return a!=null?a==0?d.ebvTrue():d.ebvFalse():d.ebvError()}else return d.isRDFTerm(a)&&
d.isRDFTerm(b)?d.ebvBoolean(d.RDFTermEquality(a,b,e,h)):d.ebvFalse()};d.runGtFunction=function(a,b){if(d.isEbvError(a)||d.isEbvError(b))return d.ebvError();if(d.isNumeric(a)&&d.isNumeric(b))return d.ebvBoolean(d.effectiveTypeValue(a)>d.effectiveTypeValue(b));else if(d.isSimpleLiteral(a)&&d.isSimpleLiteral(b))return d.ebvBoolean(d.effectiveTypeValue(a)>d.effectiveTypeValue(b));else if(d.isXsdType("string",a)&&d.isXsdType("string",b))return d.ebvBoolean(d.effectiveTypeValue(a)>d.effectiveTypeValue(b));
else if(d.isXsdType("boolean",a)&&d.isXsdType("boolean",b))return d.ebvBoolean(d.effectiveTypeValue(a)>d.effectiveTypeValue(b));else if((d.isXsdType("dateTime",a)||d.isXsdType("date",a))&&(d.isXsdType("dateTime",b)||d.isXsdType("date",b))){if(d.isXsdType("dateTime",a)&&d.isXsdType("date",b))return d.ebvFalse();if(d.isXsdType("date",a)&&d.isXsdType("dateTime",b))return d.ebvFalse();var c=m.compareDateComponents(a.value,b.value);return c!=null?c==1?d.ebvTrue():d.ebvFalse():d.ebvError()}else return d.ebvFalse()};
d.runTotalGtFunction=function(a,b){return d.isEbvError(a)||d.isEbvError(b)?d.ebvError():d.isNumeric(a)&&d.isNumeric(b)||d.isSimpleLiteral(a)&&d.isSimpleLiteral(b)||d.isXsdType("string",a)&&d.isSimpleLiteral("string",b)||d.isXsdType("boolean",a)&&d.isSimpleLiteral("boolean",b)||d.isXsdType("dateTime",a)&&d.isSimpleLiteral("dateTime",b)?d.runGtFunction(a,b,[]):a.token&&a.token==="uri"&&b.token&&b.token==="uri"?d.ebvBoolean(a.value>b.value):a.token&&a.token==="literal"&&b.token&&b.token==="literal"?
d.ebvBoolean(""+a.value+a.type+a.lang>""+b.value+b.type+b.lang):a.token&&a.token==="blank"&&b.token&&b.token==="blank"?d.ebvBoolean(a.value>b.value):a.value&&b.value?d.ebvBoolean(a.value>b.value):d.ebvTrue()};d.runLtFunction=function(a,b){if(d.isEbvError(a)||d.isEbvError(b))return d.ebvError();if(d.isNumeric(a)&&d.isNumeric(b))return d.ebvBoolean(d.effectiveTypeValue(a)<d.effectiveTypeValue(b));else if(d.isSimpleLiteral(a)&&d.isSimpleLiteral(b))return d.ebvBoolean(d.effectiveTypeValue(a)<d.effectiveTypeValue(b));
else if(d.isXsdType("string",a)&&d.isXsdType("string",b))return d.ebvBoolean(d.effectiveTypeValue(a)<d.effectiveTypeValue(b));else if(d.isXsdType("boolean",a)&&d.isXsdType("boolean",b))return d.ebvBoolean(d.effectiveTypeValue(a)<d.effectiveTypeValue(b));else if((d.isXsdType("dateTime",a)||d.isXsdType("date",a))&&(d.isXsdType("dateTime",b)||d.isXsdType("date",b))){if(d.isXsdType("dateTime",a)&&d.isXsdType("date",b))return d.ebvFalse();if(d.isXsdType("date",a)&&d.isXsdType("dateTime",b))return d.ebvFalse();
var c=m.compareDateComponents(a.value,b.value);return c!=null?c==-1?d.ebvTrue():d.ebvFalse():d.ebvError()}else return d.ebvFalse()};d.runGtEqFunction=function(a,b){if(d.isEbvError(a)||d.isEbvError(b))return d.ebvError();if(d.isNumeric(a)&&d.isNumeric(b))return d.ebvBoolean(d.effectiveTypeValue(a)>=d.effectiveTypeValue(b));else if(d.isSimpleLiteral(a)&&d.isSimpleLiteral(b))return d.ebvBoolean(d.effectiveTypeValue(a)>=d.effectiveTypeValue(b));else if(d.isXsdType("string",a)&&d.isXsdType("string",b))return d.ebvBoolean(d.effectiveTypeValue(a)>=
d.effectiveTypeValue(b));else if(d.isXsdType("boolean",a)&&d.isXsdType("boolean",b))return d.ebvBoolean(d.effectiveTypeValue(a)>=d.effectiveTypeValue(b));else if((d.isXsdType("dateTime",a)||d.isXsdType("date",a))&&(d.isXsdType("dateTime",b)||d.isXsdType("date",b))){if(d.isXsdType("dateTime",a)&&d.isXsdType("date",b))return d.ebvFalse();if(d.isXsdType("date",a)&&d.isXsdType("dateTime",b))return d.ebvFalse();var c=m.compareDateComponents(a.value,b.value);return c!=null?c!=-1?d.ebvTrue():d.ebvFalse():
d.ebvError()}else return d.ebvFalse()};d.runLtEqFunction=function(a,b){if(d.isEbvError(a)||d.isEbvError(b))return d.ebvError();if(d.isNumeric(a)&&d.isNumeric(b))return d.ebvBoolean(d.effectiveTypeValue(a)<=d.effectiveTypeValue(b));else if(d.isSimpleLiteral(a)&&d.isSimpleLiteral(b))return d.ebvBoolean(d.effectiveTypeValue(a)<=d.effectiveTypeValue(b));else if(d.isXsdType("string",a)&&d.isXsdType("string",b))return d.ebvBoolean(d.effectiveTypeValue(a)<=d.effectiveTypeValue(b));else if(d.isXsdType("boolean",
a)&&d.isXsdType("boolean",b))return d.ebvBoolean(d.effectiveTypeValue(a)<=d.effectiveTypeValue(b));else if((d.isXsdType("dateTime",a)||d.isXsdType("date",a))&&(d.isXsdType("dateTime",b)||d.isXsdType("date",b))){if(d.isXsdType("dateTime",a)&&d.isXsdType("date",b))return d.ebvFalse();if(d.isXsdType("date",a)&&d.isXsdType("dateTime",b))return d.ebvFalse();var c=m.compareDateComponents(a.value,b.value);return c!=null?c!=1?d.ebvTrue():d.ebvFalse():d.ebvError()}else return d.ebvFalse()};d.runAddition=function(a,
b,c,e,g,h){var f=d.runFilter(a,c,e,g,h);if(d.isEbvError(f))return d.ebvError();a=f;if(d.isNumeric(f)){for(f=0;f<b.length;f++){var i=d.runFilter(b[f].expression,c,e,g,h);if(d.isNumeric(i))b[f].operator==="+"?a=d.runSumFunction(a,i):b[f].operator==="-"&&(a=d.runSubFunction(a,i));else return d.ebvFalse()}return a}else return d.ebvFalse()};d.runSumFunction=function(a,b){if(d.isEbvError(a)||d.isEbvError(b))return d.ebvError();var c=d.effectiveTypeValue(a)+d.effectiveTypeValue(b);return d.isDouble(a)||
d.isDouble(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#double",value:c}:d.isFloat(a)||d.isFloat(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#float",value:c}:d.isDecimal(a)||d.isDecimal(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#decimal",value:c}:{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:c}};d.runSubFunction=function(a,b){if(d.isEbvError(a)||d.isEbvError(b))return d.ebvError();var c=d.effectiveTypeValue(a)-d.effectiveTypeValue(b);
return d.isDouble(a)||d.isDouble(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#double",value:c}:d.isFloat(a)||d.isFloat(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#float",value:c}:d.isDecimal(a)||d.isDecimal(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#decimal",value:c}:{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:c}};d.runMultiplication=function(a,b,c,e,g,h){a=d.runFilter(a,c,e,g,h);if(d.isEbvError(a))return a;var f=a;if(d.isNumeric(a)){for(var i=
0;i<b.length;i++){var k=d.runFilter(b[i].expression,c,e,g,h);if(d.isEbvError(k))return a;if(d.isNumeric(k))b[i].operator==="*"?f=d.runMulFunction(f,k):b[i].operator==="/"&&(f=d.runDivFunction(f,k));else return d.ebvFalse()}return f}else return d.ebvFalse()};d.runMulFunction=function(a,b){if(d.isEbvError(a)||d.isEbvError(b))return d.ebvError();var c=d.effectiveTypeValue(a)*d.effectiveTypeValue(b);return d.isDouble(a)||d.isDouble(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#double",value:c}:
d.isFloat(a)||d.isFloat(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#float",value:c}:d.isDecimal(a)||d.isDecimal(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#decimal",value:c}:{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:c}};d.runDivFunction=function(a,b){if(d.isEbvError(a)||d.isEbvError(b))return d.ebvError();var c=d.effectiveTypeValue(a)/d.effectiveTypeValue(b);return d.isDouble(a)||d.isDouble(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#double",
value:c}:d.isFloat(a)||d.isFloat(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#float",value:c}:d.isDecimal(a)||d.isDecimal(b)?{token:"literal",type:"http://www.w3.org/2001/XMLSchema#decimal",value:c}:{token:"literal",type:"http://www.w3.org/2001/XMLSchema#integer",value:c}};d.runBuiltInCall=function(a,b,c,e,g,h){if(a==="notexists"||a==="exists"){var f=JSON.parse(JSON.stringify(b[0])),f=e.abstractQueryTree.parseSelect({pattern:f},c),f=e.abstractQueryTree.bind(f.pattern,c),c=e.executeSelectUnit([{kind:"*"}],
g,f,h);return a==="exists"?d.ebvBoolean(c.length!==0):d.ebvBoolean(c.length===0)}else{for(var f=[],i=0;i<b.length;i++)if(b[i].token==="var")f.push(b[i]);else{var k=d.runFilter(b[i],c,e,g,h);if(d.isEbvError(k))return k;f.push(k)}if(a==="str")return f[0].token==="literal"?{token:"literal",type:null,value:""+f[0].value}:f[0].token==="uri"?{token:"literal",type:null,value:f[0].value}:d.ebvFalse();else if(a==="lang")return f[0].token==="literal"?f[0].lang!=null?{token:"literal",value:""+f[0].lang}:{token:"literal",
value:""}:d.ebvError();else if(a==="datatype")return f[0].token==="literal"?(a=f[0],a.type!=null?typeof a.type==="string"?{token:"uri",value:a.type,prefix:null,suffix:null}:a.type:a.lang==null?{token:"uri",value:"http://www.w3.org/2001/XMLSchema#string",prefix:null,suffix:null}:d.ebvError()):d.ebvError();else if(a==="isliteral")return f[0].token==="literal"?d.ebvTrue():d.ebvFalse();else if(a==="isblank")return f[0].token==="blank"?d.ebvTrue():d.ebvFalse();else if(a==="isuri"||a==="isiri")return f[0].token===
"uri"?d.ebvTrue():d.ebvFalse();else if(a==="sameterm")return a=d.RDFTermEquality(f[0],f[1],e,h),d.isEbvError(a)&&(a=!1),d.ebvBoolean(a);else if(a==="langmatches")return a=f[0],c=f[1],a.token==="literal"&&c.token==="literal"?c.value==="*"&&a.value!=""?d.ebvTrue():d.ebvBoolean(a.value.toLowerCase().indexOf(c.value.toLowerCase())===0):d.ebvError();else if(a==="bound")return a=f[0].value,a==null?d.ebvError():c[a]!=null?d.ebvTrue():d.ebvFalse();else throw"Builtin call "+a+" not implemented yet";}};d.runUnaryExpression=
function(a,b,c,e,g,h){b=d.runFilter(b,c,e,g,h);if(d.isEbvError(b))return b;if(a==="!"){var f=d.ebv(b);return d.isEbvError(f)?d.ebvFalse():d.ebvBoolean(!f)}else if(a==="+")return d.isNumeric(b)?b:d.ebvError();else if(a==="-")if(d.isNumeric(b)){a={};for(f in b)a[f]=b[f];a.value=-a.value;return a}else return d.ebvError()};d.runRegex=function(a,b,c,e,g,h,f){if(a!=null)a=d.runFilter(a,e,g,h,f);else return d.ebvError();if(b!=null)b=d.runFilter(b,e,g,h,f);else return d.ebvError();c!=null&&(c=d.runFilter(c,
e,g,h,f));if(b!=null&&b.token==="literal"&&(c==null||c.token==="literal"))b=b.value,c=c==null?null:c.value;else return d.ebvError();if(a!=null&&a.token=="var")if(e[a.value]!=null)a=e[a.value];else return d.ebvError();else if(a!=null&&a.token==="literal")if(a.type==null||d.isXsdType("string",a))a=a.value;else return d.ebvError();else return d.ebvError();return(c==null?RegExp(b):RegExp(b,c.toLowerCase())).exec(a)?d.ebvTrue():d.ebvFalse()};d.normalizeLiteralDatatype=function(a,b,c){if(!(a.value.type==
null||typeof a.value.type!="object"))a.value.type=m.lexicalFormBaseUri(a.value.type,c);return a};d.runIriRefOrFunction=function(a,b,c,e,g,h){if(b==null)return a;else{for(var f=[],i=0;i<b.length;i++)f.push(d.runFilter(b[i],c,e,g,h));a=m.lexicalFormBaseUri(a,h);if(a=="http://www.w3.org/2001/XMLSchema#integer"||a=="http://www.w3.org/2001/XMLSchema#decimal"||a=="http://www.w3.org/2001/XMLSchema#double"||a=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||a=="http://www.w3.org/2001/XMLSchema#negativeInteger"||
a=="http://www.w3.org/2001/XMLSchema#long"||a=="http://www.w3.org/2001/XMLSchema#int"||a=="http://www.w3.org/2001/XMLSchema#short"||a=="http://www.w3.org/2001/XMLSchema#byte"||a=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||a=="http://www.w3.org/2001/XMLSchema#unsignedLong"||a=="http://www.w3.org/2001/XMLSchema#unsignedInt"||a=="http://www.w3.org/2001/XMLSchema#unsignedShort"||a=="http://www.w3.org/2001/XMLSchema#unsignedByte"||a=="http://www.w3.org/2001/XMLSchema#positiveInteger")if(f=
f[0],f.token==="literal")if(f=d.normalizeLiteralDatatype(f,e,h),f.type=="http://www.w3.org/2001/XMLSchema#integer"||f.type=="http://www.w3.org/2001/XMLSchema#decimal"||f.type=="http://www.w3.org/2001/XMLSchema#double"||f.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||f.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||f.type=="http://www.w3.org/2001/XMLSchema#long"||f.type=="http://www.w3.org/2001/XMLSchema#int"||f.type=="http://www.w3.org/2001/XMLSchema#short"||f.type=="http://www.w3.org/2001/XMLSchema#byte"||
f.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||f.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||f.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||f.type=="http://www.w3.org/2001/XMLSchema#unsignedShort"||f.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||f.type=="http://www.w3.org/2001/XMLSchema#positiveInteger")return f.type=a,f;else if(f.type=="http://www.w3.org/2001/XMLSchema#boolean")return d.ebv(f)==!0?(f.type=a,f.value=1):(f.type=a,f.value=0),f;else if(f.type==
"http://www.w3.org/2001/XMLSchema#float"||f.type=="http://www.w3.org/2001/XMLSchema#double")return f.type=a,f.value=parseInt(f.value),f;else if(f.type=="http://www.w3.org/2001/XMLSchema#string"||f.type==null){if(f.value.split(".").length>2)return d.ebvError();else if(f.value.split("-").length>2)return d.ebvError();else if(f.value.split("/").length>2)return d.ebvError();else if(f.value.split("+").length>2)return d.ebvError();if(a=="http://www.w3.org/2001/XMLSchema#decimal"&&(f.value.indexOf("e")!=
-1||f.value.indexOf("E")!=-1))return d.ebvError();if(a=="http://www.w3.org/2001/XMLSchema#int"||a=="http://www.w3.org/2001/XMLSchema#integer")if(f.value.indexOf("e")!=-1||f.value.indexOf("E")!=-1||f.value.indexOf(".")!=-1)return d.ebvError();try{return f.value=parseInt(parseFloat(f.value)),isNaN(f.value)?d.ebvError():(f.type=a,f)}catch(k){return d.ebvError()}}else return d.ebvError();else return d.ebvError();else if(a=="http://www.w3.org/2001/XMLSchema#boolean")return f=f[0],f.token==="literal"&&
f.type==null?f.value==="true"||f.value==="1"?d.ebvTrue():f.value==="false"||f.value==="0"?d.ebvFalse():d.ebvError():f.token==="literal"?d.isEbvError(f)?f:d.ebvBoolean(f):d.ebvError();else if(a=="http://www.w3.org/2001/XMLSchema#string")if(f=f[0],f.token==="literal")if(f=d.normalizeLiteralDatatype(f,e,h),f.type=="http://www.w3.org/2001/XMLSchema#integer"||f.type=="http://www.w3.org/2001/XMLSchema#decimal"||f.type=="http://www.w3.org/2001/XMLSchema#double"||f.type=="http://www.w3.org/2001/XMLSchema#nonPositiveInteger"||
f.type=="http://www.w3.org/2001/XMLSchema#negativeInteger"||f.type=="http://www.w3.org/2001/XMLSchema#long"||f.type=="http://www.w3.org/2001/XMLSchema#int"||f.type=="http://www.w3.org/2001/XMLSchema#short"||f.type=="http://www.w3.org/2001/XMLSchema#byte"||f.type=="http://www.w3.org/2001/XMLSchema#nonNegativeInteger"||f.type=="http://www.w3.org/2001/XMLSchema#unsignedLong"||f.type=="http://www.w3.org/2001/XMLSchema#unsignedInt"||f.type=="http://www.w3.org/2001/XMLSchema#unsignedShort"||f.type=="http://www.w3.org/2001/XMLSchema#unsignedByte"||
f.type=="http://www.w3.org/2001/XMLSchema#positiveInteger"||f.type=="http://www.w3.org/2001/XMLSchema#float")return f.type=a,f.value=""+f.value,f;else if(f.type=="http://www.w3.org/2001/XMLSchema#string")return f;else if(f.type=="http://www.w3.org/2001/XMLSchema#boolean")return d.ebv(f)?(f.type=a,f.value="true"):(f.type=a,f.value="false"),f;else if(f.type=="http://www.w3.org/2001/XMLSchema#dateTime"||f.type=="http://www.w3.org/2001/XMLSchema#date"){f.type=a;if(typeof f.value!="string")f.value=m.iso8601(f.value);
return f}else return f.type==null?(f.value=""+f.value,f.type=a,f):d.ebvError();else return f.token==="uri"?{token:"literal",value:m.lexicalFormBaseUri(f,h),type:a,lang:null}:d.ebvError();else if(a=="http://www.w3.org/2001/XMLSchema#dateTime"||a=="http://www.w3.org/2001/XMLSchema#date")if(f=f[0],f.type=="http://www.w3.org/2001/XMLSchema#dateTime"||f.type=="http://www.w3.org/2001/XMLSchema#date")return f;else if(f.type=="http://www.w3.org/2001/XMLSchema#string"||f.type==null)try{return f.value=m.iso8601(m.parseStrictISO8601(f.value)),
f.type=a,f}catch(l){return d.ebvError()}else return d.ebvError();else if(a=="http://www.w3.org/2001/XMLSchema#float")if(f=f[0],f.token==="literal")if(f=d.normalizeLiteralDatatype(f,e,h),f.type=="http://www.w3.org/2001/XMLSchema#decimal"||f.type=="http://www.w3.org/2001/XMLSchema#int")return f.type=a,f.value=parseFloat(f.value),f;else if(f.type=="http://www.w3.org/2001/XMLSchema#boolean")return d.ebv(f)==!0?(f.type=a,f.value=1):(f.type=a,f.value=0),f;else if(f.type=="http://www.w3.org/2001/XMLSchema#float"||
f.type=="http://www.w3.org/2001/XMLSchema#double")return f.type=a,f.value=parseFloat(f.value),f;else if(f.type=="http://www.w3.org/2001/XMLSchema#string")try{return f.value=parseFloat(f.value),isNaN(f.value)?d.ebvError():(f.type=a,f)}catch(j){return d.ebvError()}else if(f.type==null){if(f.value.split(".").length>2)return d.ebvError();else if(f.value.split("-").length>2)return d.ebvError();else if(f.value.split("/").length>2)return d.ebvError();else if(f.value.split("+").length>2)return d.ebvError();
try{return f.value=parseFloat(f.value),isNaN(f.value)?d.ebvError():(f.type=a,f)}catch(I){return d.ebvError()}}else return d.ebvError();else return d.ebvError();else return d.ebvError()}};var r={variablesInBGP:function(a){var b=a.variables;if(b)return b;var c=a.value||a,b=[],e;for(e in c)c[e]&&c[e].token==="var"?b.push(c[e].value):c[e]&&c[e].token==="blank"&&b.push("blank:"+c[e].value);return a.variables=b},connected:function(a,b){for(var c="/"+a.vars.join("/")+"/",e=0;e<b.vars.length;e++)if(c.indexOf("/"+
b.vars[e]+"/")!=-1)return!0;return!1},variablesIntersectionBGP:function(a,b){for(var c=r.variablesInBGP(a).sort(),e=r.variablesInBGP(b).sort(),g=0,d=0,f=[];g<c.length&&d<e.length;)c[g]===e[d]?(f.push(c[g]),g++,d++):c[g]<e[d]?g++:d++;return f},executeAndBGPsGroups:function(a){for(var b={},c={},e=0,g=0;g<a.length;g++){var d=a[g],f={},i={},k=[],l;for(l in d)l!="_cost"&&(d[l].token==="var"?k.push(d[l].value):d[l].token==="blank"&&k.push(d[l].value));var j=!1,m={},o;for(o in c){for(var n=c[o],j=!1,t=0;t<
k.length;t++)if(n.indexOf("/"+k[t]+"/")!=-1){j=!0;break}j?m[o]=!0:(f[o]=b[o],i[o]=c[o])}if(j){var j=[],t=n="",D;for(D in m)n+=D,j=j.concat(b[D]),t=c[D];t=t+k.join("/")+"/";j.push(d);f[n]=j;i[n]=t}else f[e]=[d],i[e]="/"+k.join("/")+"/",e++;b=f;c=i}a=[];for(e in b)a.push(b[e]);return a},intersectionSize:function(a,b){for(var c=b.i.split("_"),e=0;e<c.length;e++)if(c[e]!=""&&a.i.indexOf("_"+c[e]+"_")!=-1)return 1;return 0},createJoinTree:function(a,b){for(var c="/"+a.vars.join("/")+"/",e=a.vars.concat([]),
g=[],d=0;d<b.vars.length;d++)c.indexOf("/"+b.vars[d]+"/")!=-1?b.vars[d].indexOf("_:")==0?g.push("blank:"+b.vars[d]):g.push(b.vars[d]):e.push(b.vars[d]);for(var f=b.i.split("_"),i=a.i.split("_"),c={},d=0;d<f.length;d++)f[d]!=""&&(c[f[d]]=!0);for(d=0;d<i.length;d++)i[d]!=""&&(c[i[d]]=!0);var d=[],k;for(k in c)d.push(k);return{left:a,right:b,cost:a.cost+b.cost,i:"_"+d.sort().join("_")+"_",vars:e,join:g}}};r.executeBushyTree=function(a,b,c,e){if(a.left==null)return r.executeEmptyJoinBGP(a.right,b,c,e);
else if(a.right==null)return r.executeEmptyJoinBGP(a.left,b,c,e);else{var g=r.executeBushyTree(a.left,b,c,e);if(g!=null)return b=r.executeBushyTree(a.right,b,c,e),b!=null?r.joinBindings2(a.join,g,b):null}};r.executeAndBGPsDPSize=function(a,b,c,e){for(var g=r.executeAndBGPsGroups(a),a=[],d=0;d<g.length;d++){var f=g[d];c.computeCosts(f,e);var i={},k={},l={},j=1,m=null,o={};l["1"]=[];for(var n=0;n<f.length;n++){var j=[],t;for(t in f[n])t!="_cost"&&(f[n][t].token==="var"?j.push(f[n][t].value):f[n][t].token===
"blank"&&j.push(f[n][t].value));k["_"+n+"_"]={left:f[n],right:null,cost:f[n]._cost,i:"_"+n+"_",vars:j};j={left:f[n],right:null,cost:f[n]._cost,i:"_"+n+"_",vars:j};i["_"+n+"_"]=j;delete f[n]._cost;o["_"+n+"_"]=!0;l["1"].push("_"+n+"_");if(m==null||m.cost>j.cost)m=j}for(var D=2;D<=f.length;D++)for(var q=1;q<D;q++)for(var s=l[""+q]||[],w=l[""+(D-q)]||[],n=0;n<s.length;n++)for(var u=0;u<w.length;u++)if(s[n]!==w[u]){var v=k[s[n]],A=k[w[u]];if(r.intersectionSize(v,A)==0&&r.connected(v,A)&&(j=D,A=r.createJoinTree(i[v.i],
i[A.i]),!o[A.i])){o[A.i]=!0;var x=A.cost+1;if(i[A.i]!=null)x=i[A.i].cost;v=l[D]||[];v.push(A.i);k[A.i]=A;l[D]=v;x>A.cost&&(j===D&&(m=A),i[A.i]=A)}}a.push(m)}v=null;for(d=0;d<a.length;d++)t=r.executeBushyTree(a[d],b,c,e),v=v==null?t:r.crossProductBindings(v,t);return v};r.executeEmptyJoinBGP=function(a,b,c,e){return r.executeBGPDatasets(a,b,c,e)};r.executeBGPDatasets=function(a,b,c,e){var g={};if(a.graph==null){for(var d=[],f=0;f<b.implicit.length;f++)if(g[b.implicit[f].oid]==null){g[b.implicit[f].oid]=
!0;a.graph=b.implicit[f];var i=c.rangeQuery(a,e),i=r.buildBindingsFromRange(i,a);d.push(i)}return a=r.unionManyBindings(d)}else if(a.graph.token==="var"){for(var k=a.graph.value,d=[],f=0;f<b.named.length;f++)if(g[b.named[f].oid]==null)if(g[b.named[f].oid]=!0,a.graph=b.named[f],i=c.rangeQuery(a,e),i!=null){for(var i=r.buildBindingsFromRange(i,a),l=0;l<i.length;l++)i[l][k]=b.named[f].oid;d.push(i)}else return null;return a=r.unionManyBindings(d||[])}else return i=c.rangeQuery(a,e),i!=null?i=r.buildBindingsFromRange(i,
a):null};r.buildBindingsFromRange=function(a,b){r.variablesInBGP(b);var c={},e=b.value||b,c={};for(i in e)e[i]&&e[i].token==="var"?c[i]=e[i].value:e[i]&&e[i].token==="blank"&&(c[i]="blank:"+e[i].value);e=[];if(a!=null)for(var g=0;g<a.length;g++){var d={},f=a[g],i;for(i in c)d[c[i]]=f[i];e.push(d)}return e};r.areCompatibleBindings=function(a,b){for(var c in a)if(b[c]!=null&&b[c]!=a[c])return!1;return!0};r.mergeBindings=function(a,b){var c={},e;for(e in a)c[e]=a[e];for(e in b)c[e]=b[e];return c};r.joinBindings2=
function(a,b,c){for(var e={},g,d,f,i,k=[],l=0;l<b.length;l++){g=b[l];i=e;for(var j=0;j<a.length;j++)d=a[j],d=g[d],j==a.length-1?(f=i[d]||[],f.push(g),i[d]=f):(f=i[d]||{},i=i[d]=f)}for(l=0;l<c.length;l++){g=c[l];i=e;for(j=0;j<a.length;j++)if(d=a[j],d=g[d],i[d]!=null)if(j==a.length-1)for(b=0;b<i[d].length;b++)k.push(r.mergeBindings(i[d][b],g));else i=i[d]}return k};r.joinBindings=function(a,b){for(var c=[],e=0;e<a.length;e++)for(var d=a[e],h=0;h<b.length;h++){var f=b[h];r.areCompatibleBindings(d,f)&&
c.push(r.mergeBindings(d,f))}return c};r.augmentMissingBindings=function(a,b){for(var c in b)a[c]==null&&(a[c]=null);return a};r.leftOuterJoinBindings=function(a,b){for(var c=[],e=0;e<a.length;e++){for(var d=a[e],h=!1,f=0;f<b.length;f++){var i=b[f];r.areCompatibleBindings(d,i)&&(h=!0,c.push(r.mergeBindings(d,i)))}h===!1&&(r.augmentMissingBindings(d,i),c.push(d))}return c};r.crossProductBindings=function(a,b){for(var c=[],e=0;e<a.length;e++)for(var d=a[e],h=0;h<b.length;h++)c.push(r.mergeBindings(d,
b[h]));return c};r.unionBindings=function(a,b){return a.concat(b)};r.unionManyBindings=function(a){for(var b=[],c=0;c<a.length;c++)b=r.unionBindings(b,a[c]);return b};var q={},G=r;q.QueryEngine=function(a){if(arguments.length!=0)this.backend=a.backend,this.lexicon=a.lexicon,this.eventsOnBatchLoad=a.eventsOnBatchLoad||!1,this.defaultPrefixes={},this.abstractQueryTree=new v.AbstractQueryTree,this.callbacksBackend=new s.CallbacksBackend(this)};q.QueryEngine.prototype.registerNsInEnvironment=function(a,
b){var c=[];if(a!=null&&a.prefixes!=null)c=a.prefixes;var e={},d;for(d in this.defaultPrefixes)e[d]=this.defaultPrefixes[d];for(d=0;d<c.length;d++){var h=c[d];if(h.token==="prefix")e[h.prefix]=h.local}b.namespaces=e;b.base=a!=null&&a.base&&typeof a.base==="object"?a.base.value:null};q.QueryEngine.prototype.applyModifier=function(a,b){if(a=="DISTINCT"){for(var c={},e=[],d=0;d<b.length;d++){var h=b[d],f="",i;for(i in h){var k=h[i];k==null?f=f+i+"null":k.token=="literal"?(k.value!=null&&(f+=k.value),
k.lang!=null&&(f+=k.lang),k.type!=null&&(f+=k.type)):f=k.value?f+i+k.value:f+i+k}c[f]==null&&(e.push(h),c[f]=!0)}return e}else return b};q.QueryEngine.prototype.applyLimitOffset=function(a,b,c){if(b==null&&a==null)return c;a==null&&(a=0);b=b==null?c.length:a+b;return c.slice(a,b)};q.QueryEngine.prototype.applySingleOrderBy=function(a,b,c,e){for(var g=[],h=0;h<a.length;h++){var f=d.collect(a[h].expression,[b],c,e,this);g.push(f[0].value)}return{binding:b,value:g}};q.QueryEngine.prototype.applyOrderBy=
function(a,b,c,e){var d=this,h=[];if(a!=null&&a.length>0){for(var f=0;f<b.length;f++){var i=d.applySingleOrderBy(a,b[f],c,e);h.push(i)}h.sort(function(b,c){return d.compareFilteredBindings(b,c,a,e)});b=[];for(f=0;f<h.length;f++)b.push(h[f].binding)}return b};q.QueryEngine.prototype.compareFilteredBindings=function(a,b,c,e){for(var g=0;;){if(g==a.value.length)return 0;var h=c[g].direction;if(a.value[g]==null&&b.value[g]==null)g++;else{if(a.value[g]==null)a={value:!1};else if(b.value[g]==null)a={value:!0};
else if(a.value[g].token==="blank"&&b.value[g].token==="blank"){g++;continue}else if(a.value[g].token==="blank")a={value:!1};else if(b.value[g].token==="blank")a={value:!0};else if(a.value[g].token==="uri"&&b.value[g].token==="uri")if(d.runEqualityFunction(a.value[g],b.value[g],[],this,e).value==!0){g++;continue}else a=d.runTotalGtFunction(a.value[g],b.value[g],[]);else if(a.value[g].token==="uri")a={value:!1};else if(b.value[g].token==="uri")a={value:!0};else if(a.value[g].token==="literal"&&b.value[g].token===
"literal"&&a.value[g].type==null&&b.value[g].type==null)if(d.runEqualityFunction(a.value[g],b.value[g],[],this,e).value==!0){g++;continue}else a=d.runTotalGtFunction(a.value[g],b.value[g],[]);else if(a.value[g].token==="literal"&&a.value[g].type==null)a={value:!1};else if(b.value[g].token==="literal"&&b.value[g].type==null)a={value:!0};else if(d.runEqualityFunction(a.value[g],b.value[g],[],this,e).value==!0){g++;continue}else a=d.runTotalGtFunction(a.value[g],b.value[g],[]);return a.value==!0?h===
"ASC"?1:-1:h==="ASC"?-1:1}}};q.QueryEngine.prototype.removeDefaultGraphBindings=function(a,b){for(var c=[],e={},d=0;d<b.named.length;d++)e[b.named[d].oid]=!0;for(d=0;d<b.implicit.length;d++)e[b.implicit[d].oid]==null&&c.push(b.implicit[d].oid);c=[];for(d=0;d<a.length;d++){var h=a[d],f=!1,i;for(i in h){for(var k=0;k<e.length;k++)if(h[i]===e[k]){f=!0;break}if(f)break}f||c.push(h)}return c};q.QueryEngine.prototype.aggregateBindings=function(a,b,c,e){for(var b=this.copyDenormalizedBindings(b,e.outCache),
g={},h=0;h<a.length;h++){var f=d.runAggregator(a[h],b,this,c,e);a[h].alias?g[a[h].alias.value]=f:g[a[h].value.value]=f}return g};q.QueryEngine.prototype.projectBindings=function(a,b,c){if(a[0].kind==="*")return b;else{for(var e=[],g=0;g<b.length;g++){for(var h=b[g],f={},i=!0,k=0;k<a.length;k++)if(a[k].token=="variable"&&a[k].kind!="aliased")f[a[k].value.value]=h[a[k].value.value];else if(a[k].token=="variable"&&a[k].kind=="aliased"){var l=d.runFilter(a[k].expression,h,this,c,{blanks:{},outCache:{}});
if(d.isEbvError(l)){i=!1;break}else f[a[k].alias.value]=l}i===!0&&e.push(f)}return e}};q.QueryEngine.prototype.resolveNsInEnvironment=function(a,b){return b.namespaces[a]};q.QueryEngine.prototype.termCost=function(a,b){if(a.token==="uri"){var c=m.lexicalFormBaseUri(a,b);return c==null?0:this.lexicon.resolveUriCost(c)}else return a.token==="literal"?this.lexicon.resolveLiteralCost(m.lexicalFormLiteral(a,b)):a.token==="blank"?this.lexicon.resolveBlankCost(a.value):a.token==="var"?this.lexicon.oidCounter/
3:null};q.QueryEngine.prototype.normalizeTerm=function(a,b,c){if(a.token==="uri")return b=m.lexicalFormBaseUri(a,b),b==null?null:c?this.lexicon.registerUri(b):this.lexicon.resolveUri(b);else if(a.token==="literal")return b=m.lexicalFormLiteral(a,b),a=c?this.lexicon.registerLiteral(b):this.lexicon.resolveLiteral(b);else if(a.token==="blank"){var e=a.value,a=b.blanks[e];a==null&&(a=c?this.lexicon.registerBlank(e):this.lexicon.resolveBlank(e),b.blanks[e]=a);return a}else return a.token==="var"?a.value:
null};q.QueryEngine.prototype.normalizeDatasets=function(a,b){for(var c=0;c<a.length;c++){var e=a[c];if(e.value===this.lexicon.defaultGraphUri)e.oid=this.lexicon.defaultGraphOid;else{var d=this.normalizeTerm(e,b,!1);if(d!=null)e.oid=d;else return null}}return!0};q.QueryEngine.prototype.normalizeQuad=function(a,b,c){var e=null,d=null,h=e=null,f;if(a.graph==null)h=0;else if(f=this.normalizeTerm(a.graph,b,c),f!=null)h=f,c===!0&&a.graph.token!="var"&&this.lexicon.registerGraph(f);else return null;f=this.normalizeTerm(a.subject,
b,c);if(f!=null)e=f;else return null;f=this.normalizeTerm(a.predicate,b,c);if(f!=null)d=f;else return null;f=this.normalizeTerm(a.object,b,c);return f==null?null:{subject:e,predicate:d,object:f,graph:h}};q.QueryEngine.prototype.quadCost=function(a,b){var c=null,e=null,d=null,h=null,h=a.graph==null?this.lexicon.oidCounter/4:this.termCost(a.graph,b),c=this.termCost(a.subject,b),e=this.termCost(a.predicate,b),d=this.termCost(a.object,b);return h+c+e+d};q.QueryEngine.prototype.denormalizeBindingsList=
function(a,b){for(var c=[],e=0;e<a.length;e++){var d=this.denormalizeBindings(a[e],b);c.push(d)}return c};q.QueryEngine.prototype.copyDenormalizedBindings=function(a,b){for(var c=[],e=0;e<a.length;e++){for(var d={},h=a[e],f=m.keys(h),i=0;i<f.length;i++){var k=h[f[i]];if(k==null)d[f[i]]=null;else if(typeof k==="object")d[f[i]]=k;else{var l=b[k];l==null&&(l=this.lexicon.retrieve(k),b[k]=l);d[f[i]]=l}}c.push(d)}return c};q.QueryEngine.prototype.denormalizeBindings=function(a,b){for(var c=m.keys(a),e=
b.outCache,d=0;d<c.length;d++){var h=a[c[d]];if(h==null)a[c[d]]=null;else if(e[h]!=null)a[c[d]]=e[h];else{var f=this.lexicon.retrieve(h);a[c[d]]=f;f.token==="blank"&&(b.blanks[f.value]=h)}}return a};q.QueryEngine.prototype.startGraphModification=function(){this.callbacksBackend.startGraphModification()};q.QueryEngine.prototype.endGraphModification=function(){this.callbacksBackend.endGraphModification(function(){})};q.QueryEngine.prototype.execute=function(a,b,c,e){var d=a;typeof a==="string"&&(a=
m.normalizeUnicodeLiterals(a),d=this.abstractQueryTree.parseQueryString(a));if(d==null)b(!1,"Error parsing query string");else if(d.token==="query"&&d.kind=="update"){var h=this;this.executeUpdate(d,function(a,c){h.lexicon.updateAfterWrite&&h.lexicon.updateAfterWrite();a||h.callbacksBackend.cancelGraphModification();b(a,c)})}else d.token==="query"&&d.kind=="query"&&this.executeQuery(d,b,c,e)};q.QueryEngine.prototype.executeQuery=function(a,b,c,e){var d=a.units,h=this,f={blanks:{},outCache:{}};this.registerNsInEnvironment(a.prologue,
f);a=d[0];d[0].pattern.kind!=="BGP"&&(a=h.abstractQueryTree.parseExecutableUnit(d[0]));if(a.kind==="select")this.executeSelect(a,f,c,e,function(a,c){a?typeof c==="object"&&c.denorm===!0?b(!0,c.bindings):(c=h.denormalizeBindingsList(c,f),c!=null?b(!0,c):b(!1,c)):b(!1,c)});else if(a.kind==="ask")a.projection=[{token:"variable",kind:"*"}],this.executeSelect(a,f,c,e,function(a,c){a?a?c.length>0?b(!0,!0):b(!0,!1):b(!1,c):b(!1,c)})};q.QueryEngine.prototype.executeSelect=function(a,b,c,e,d){if(a.kind===
"select"||a.kind==="ask"||a.kind==="construct"||a.kind==="modify"){var h=a.projection,f=a.dataset,i=a.modifier,k=a.limit,l=a.offset,j=a.order;if(c!=null||e!=null)f.implicit=c||[],f.named=e||[];f.implicit!=null&&f.implicit.length===0&&f.named!=null&&f.named.length===0&&f.implicit.push(this.lexicon.defaultGraphUriTerm);if(this.normalizeDatasets(f.implicit.concat(f.named),b)!=null)if(e=this.executeSelectUnit(h,f,a.pattern,b),e!=null){if(a.group!=null&&a.group===""){for(var m=!1,c=0;c<a.projection.length;c++)if(a.projection[c].expression!=
null&&a.projection[c].expression.expressionType==="aggregate"){m=!0;break}if(m===!0)a.group="singleGroup"}if(a.group&&a.group!="")if(this.checkGroupSemantics(a.group,h)){k=this.groupSolution(e,a.group,f,b);l=[];for(c=0;c<k.length;c++)i=this.aggregateBindings(h,k[c],f,b),l.push(i);d(!0,{bindings:l,denorm:!0})}else d(!1,"Incompatible Group and Projection variables");else b=this.applyOrderBy(j,e,f,b),h=this.projectBindings(h,b,f),h=this.applyModifier(i,h),f=this.removeDefaultGraphBindings(this.applyLimitOffset(l,
k,h),f),d(!0,f)}else d(!1,e);else d(!1,"Error normalizing datasets")}else d(!1,"Cannot execute "+a.kind+" query as a select query")};q.QueryEngine.prototype.groupSolution=function(a,b,c,e){var g=[],h=[],f=!1;if(b==="singleGroup")return[a];else{for(var i=0;i<a.length;i++){for(var k=a[i],l=!0,j=0;j<b.length;j++){var m=b[j],o=null;if(m.token==="var")o=m.value,f==!1&&g.push(o);else if(m.token==="aliased_expression")if(o=m.alias.value,f==!1&&g.push(o),m.expression.primaryexpression==="var")k[m.alias.value]=
k[m.expression.value.value];else if(o=this.copyDenormalizedBindings([k],e.outCache),o=d.runFilter(m.expression,o[0],this,c,e),d.isEbvError(o))l=!1;else{if(o.value!=null)o.value=""+o.value;k[m.alias.value]=o}else o=this.copyDenormalizedBindings([k],e.outCache),o=d.runFilter(m,o[0],this,e),d.isEbvError(o)?l=!1:(k["groupCondition"+env._i]=o,o="groupCondition"+env._i,f==!1&&g.push(o))}f==!1&&(f=!0);l===!0&&h.push(k)}a={};for(i=0;i<h.length;i++){b=h[i];c="";for(j=0;j<g.length;j++)e=b[g[j]],c+=typeof e===
"object"?e.value:e;a[c]==null?a[c]=[b]:a[c].push(b)}var g=[],n;for(n in a)g.push(a[n]);return g}};q.QueryEngine.prototype.executeSelectUnit=function(a,b,c,e){return c.kind==="BGP"?this.executeAndBGP(a,b,c,e):c.kind==="UNION"?this.executeUNION(a,b,c.value,e):c.kind==="JOIN"?this.executeJOIN(a,b,c,e):c.kind==="LEFT_JOIN"?this.executeLEFT_JOIN(a,b,c,e):c.kind==="FILTER"?(a=this.executeSelectUnit(a,b,c.value,e),a!=null?a=d.checkFilters(c,a,!1,b,e,this):[]):c.kind==="EMPTY_PATTERN"?[]:c.kind==="ZERO_OR_MORE_PATH"||
c.kind==="ONE_OR_MORE_PATH"?this.executeZeroOrMorePath(c,b,e):(console.log("Cannot execute query pattern "+c.kind+". Not implemented yet."),null)};q.QueryEngine.prototype.executeZeroOrMorePath=function(a,b,c){var e=[];a.x.token==="var"&&e.push({token:"variable",kind:"var",value:a.x.value});a.y.token==="var"&&e.push({token:"variable",kind:"var",value:a.y.value});e.length===0&&e.push({token:"variable",kind:"*"});if(a.x.token==="var"&&a.y.token==="var"){var d=this.executeAndBGP(e,b,a.path,c),h={},e=
[],f,i,k,l,j=a.x.value;i=a.x;for(var n=a.path,o=0;o<d.length;o++)if(f=d[o][j],h[f]==null){l=this.lexicon.retrieve(f);a.x=l;a.path=this.abstractQueryTree.replace(n,i,l,c);n=m.clone(a.path);i=this.executeZeroOrMorePath(a,b,c);for(var q=0;q<i.length;q++)k=i[q],k[j]=f,e.push(k);i=l}return e}else if(a.x.token!=="var"&&a.y.token==="var"){h={};f=!0;l=[];for(j=[];f==!0||l.length!==0;){f===!0?(d=this.executeAndBGP(e,b,a.path,c),i=a.x,f=!1):(n=this.lexicon.retrieve(l.pop()),d=a.path,d=this.abstractQueryTree.replace(d,
i,n,c),d=this.executeAndBGP(e,b,d,c),i=n);for(o=0;o<d.length;o++)n=d[o][a.y.value],h[n]!==!0&&(k={},k[a.y.value]=n,j.push(k),h[n]=!0,l.push(n))}return j}else throw"Kind of path not supported!";};q.QueryEngine.prototype.executeUNION=function(a,b,c,e){var g=c[0],h=c[1],f=null,i=null;if(c.length!=2)throw"SPARQL algebra UNION with more than two components";f=this.executeSelectUnit(a,b,g,e);if(f==null)return null;i=this.executeSelectUnit(a,b,h,e);if(i==null)return null;a=G.unionBindings(f,i);return a=
d.checkFilters(c,a,!1,b,e,this)};q.QueryEngine.prototype.executeAndBGP=function(a,b,c,e){a=G.executeAndBGPsDPSize(c.value,b,this,e);return a!=null?d.checkFilters(c,a,!1,b,e,this):null};q.QueryEngine.prototype.executeLEFT_JOIN=function(a,b,c,e){var g=c.rvalue,h=null,f=null,h=this.executeSelectUnit(a,b,c.lvalue,e);if(h==null)return null;f=this.executeSelectUnit(a,b,g,e);if(f==null)return null;a=G.leftOuterJoinBindings(h,f);b=d.checkFilters(c,a,!0,b,e,this);if(h.length>1&&f.length>1){var c=[],e={},i;
for(i in h[0])e[i]=!0;for(i in f[0])e[i]!=!0&&c.push(i);h=[];f={};for(e=0;e<b.length;e++)if(b[e].__nullify__===!0){for(g=0;g<c.length;g++)b[e].bindings[c[g]]=null;g=[];a=[];for(i in b[e].bindings)b[e].bindings[i]!=null&&(g.push(i+b[e].bindings[i]),g.sort(),a.push(g.join("")));if(f[g.join("")]==null){for(g=0;g<a.length;g++)f[a[g]]=!0;h.push(b[e].bindings)}}else for(i in h.push(b[e]),g=[],b[e])g.push(i+b[e][i]),g.sort(),f[g.join("")]=!0;return h}else return b};q.QueryEngine.prototype.executeJOIN=function(a,
b,c,e){var g=c.lvalue,h=c.rvalue,f=null,i=null,f=this.executeSelectUnit(a,b,g,e);if(f==null)return null;i=this.executeSelectUnit(a,b,h,e);if(i==null)return null;a=null;if(f.length===0||i.length===0)a=[];else{var a={},k=[],l;for(l in f[0])a[l]=!1;for(l in i[0])a[l]===!1&&k.push(l);a=k.length==0?G.joinBindings(f,i):this.abstractQueryTree.treeWithUnion(g)||this.abstractQueryTree.treeWithUnion(h)?G.joinBindings(f,i):G.joinBindings2(k,f,i)}return a=d.checkFilters(c,a,!1,b,e,this)};q.QueryEngine.prototype.rangeQuery=
function(a,b){var c=this.normalizeQuad(a,b,!1);return c!=null?(c=this.backend.range(new C.Pattern(c)),c==null||c.length==0?[]:c):(console.log("ERROR normalizing quad"),null)};q.QueryEngine.prototype.executeUpdate=function(a,b){var c=a.units,d={blanks:{},outCache:{}};this.registerNsInEnvironment(a.prologue,d);for(var g=0;g<c.length;g++){var h=this.abstractQueryTree.parseExecutableUnit(c[g]);if(h.kind==="insertdata"){for(var f=0;f<h.quads.length;f++){var i=h.quads[f];if(this._executeQuadInsert(i,d)!==
!0)return b(!1,error)}b(!0)}else if(h.kind==="deletedata"){for(f=0;f<h.quads.length;f++)i=h.quads[f],this._executeQuadDelete(i,d);b(!0)}else if(h.kind==="modify")this._executeModifyQuery(h,d,b);else if(h.kind==="create")b(!0);else throw Error("not supported execution unit");}};q.QueryEngine.prototype.batchLoad=function(a,b){for(var c=null,d=null,g=null,h=null,f=0,i=!0,k={},l,j,m=0;m<a.length;m++){j=a[m];if(j.subject.uri||j.subject.token==="uri"){if(l=this.lexicon.registerUri(j.subject.uri||j.subject.value),
j.subject.uri!=null)j.subject={token:"uri",value:j.subject.uri},delete j.subject.uri}else if(j.subject.literal||j.subject.token==="literal"){if(l=this.lexicon.registerLiteral(j.subject.literal||j.subject.value),j.subject.literal!=null)j.subject=this.lexicon.parseLiteral(j.subject.literal),delete j.subject.literal}else if(l=k[j.subject.blank||j.subject.value],l==null&&(l=this.lexicon.registerBlank(j.subject.blank||j.subject.value),k[j.subject.blank||j.subject.value]=l),j.subject.token==null)j.subject.token=
"blank",j.subject.value=j.subject.blank,delete j.subject.blank;c=l;if(j.predicate.uri||j.predicate.token==="uri"){if(l=this.lexicon.registerUri(j.predicate.uri||j.predicate.value),j.predicate.uri!=null)j.predicate={token:"uri",value:j.predicate.uri},delete j.subject.uri}else if(j.predicate.literal||j.predicate.token==="literal"){if(l=this.lexicon.registerLiteral(j.predicate.literal||j.predicate.value),j.predicate.literal!=null)j.predicate=this.lexicon.parseLiteral(j.predicate.literal),delete j.predicate.literal}else if(l=
k[j.predicate.blank||j.predicate.value],l==null&&(l=this.lexicon.registerBlank(j.predicate.blank||j.predicate.value),k[j.predicate.blank||j.predicate.value]=l),j.predicate.token==null)j.predicate.token="blank",j.predicate.value=j.predicate.blank,delete j.predicate.blank;d=l;if(j.object.uri||j.object.token==="uri"){if(l=this.lexicon.registerUri(j.object.uri||j.object.value),j.object.uri!=null)j.object={token:"uri",value:j.object.uri},delete j.subject.uri}else if(j.object.literal||j.object.token===
"literal"){if(j.object.token==="literal")j.object.value=j.object.type!=null?'"'+j.object.value+'"^^<'+j.object.type+">":j.object.lang!=null?'"'+j.object.value+'"@'+j.object.lang:'"'+j.object.value+'"';l=this.lexicon.registerLiteral(j.object.literal||j.object.value);if(j.object.literal!=null)j.object=this.lexicon.parseLiteral(j.object.literal),delete j.object.literal}else if(l=k[j.object.blank||j.object.value],l==null&&(l=this.lexicon.registerBlank(j.object.blank||j.object.value),k[j.object.blank||
j.object.value]=l),j.object.token==null)j.object.token="blank",j.object.value=j.object.blank,delete j.object.blank;g=l;if(j.graph.uri||j.graph.token==="uri"){l=this.lexicon.registerUri(j.graph.uri||j.graph.value);if(j.graph.uri!=null)j.graph={token:"uri",value:j.graph.uri},delete j.subject.uri;this.lexicon.registerGraph(l)}else if(j.graph.literal||j.graph.token==="literal"){if(l=this.lexicon.registerLiteral(j.graph.literal||j.graph.value),j.predicate.literal!=null)j.predicate=this.lexicon.parseLiteral(j.predicate.literal),
delete j.predicate.literal}else if(l=k[j.graph.blank||j.graph.value],l==null&&(l=this.lexicon.registerBlank(j.graph.blank||j.graph.value),k[j.graph.blank||j.graph.value]=l),j.graph.token==null)j.graph.token="blank",j.graph.value=j.graph.blank,delete j.graph.blank;h=l;l=j;j={subject:c,predicate:d,object:g,graph:h};c=new C.NodeKey(j);d=this.backend.search(c);if(!d)if(d=this.backend.index(c),d==!0)this.eventsOnBatchLoad&&this.callbacksBackend.nextGraphModification(s.added,[l,j]),f+=1;else{i=!1;break}}this.lexicon.updateAfterWrite!=
null&&this.lexicon.updateAfterWrite();i?b&&b(!0,f):b&&b(!1,null);return i?f:null};q.QueryEngine.prototype.computeCosts=function(a,b){for(var c=0;c<a.length;c++)a[c]._cost=this.quadCost(a[c],b);return a};q.QueryEngine.prototype._executeModifyQuery=function(a,b,c){var d=this,g=!0,h=null,f=["subject","predicate","object","graph"];a.insert=a.insert==null?[]:a.insert;a["delete"]=a["delete"]==null?[]:a["delete"];m.seq(function(c){var f=[],l=[];a["with"]!=null&&f.push(a["with"]);if(a.using!=null)for(var l=
[],j=0;j<a.using.length;j++){var m=a.using[j];m.kind==="named"?l.push(m.uri):f.push(m.uri)}a.dataset={};a.projection=[{token:"variable",kind:"*"}];d.executeSelect(a,b,f,l,function(a,f){a?(f=d.denormalizeBindingsList(f,b),f!=null?h=f:g=!1):g=!1;return c()})},function(c){var k=a["with"];if(g){for(var l=[],j=0;j<a["delete"].length;j++)for(var m=a["delete"][j],n=0;n<h.length;n++){for(var q={},t=h[n],s=0;s<f.length;s++){var r=f[s];r=="graph"&&m[r]==null?q.graph=k:q[r]=m[r].token==="var"?t[m[r].value]:
m[r]}l.push(q)}for(n=0;n<l.length;n++)q=l[n],d._executeQuadDelete(q,b)}c()},function(c){var k=a["with"];if(g){for(var l=[],j=0;j<a.insert.length;j++)for(var m=a.insert[j],n=0;n<h.length;n++){for(var q={},t=h[n],r=0;r<f.length;r++){var s=f[r];s=="graph"&&m[s]==null?q.graph=k:q[s]=m[s].token==="var"?t[m[s].value]:m[s]}l.push(q)}for(j=0;j<l.length;j++)q=l[j],d._executeQuadInsert(q,b)}c()})(function(){c(g)})};q.QueryEngine.prototype._executeQuadInsert=function(a,b){var c=this.normalizeQuad(a,b,!0);if(c!=
null){var d=new C.NodeKey(c),g=this.backend.search(d);return g?g:(g=this.backend.index(d),g==!0?(this.callbacksBackend.nextGraphModification(s.added,[a,c]),!0):(console.log("ERROR inserting quad"),!1))}else return console.log("ERROR normalizing quad"),!1};q.QueryEngine.prototype._executeQuadDelete=function(a,b){var c=this.normalizeQuad(a,b,!1);if(c!=null){var d=new C.NodeKey(c);this.backend["delete"](d);return this.lexicon.unregister(a,d)==!0?(this.callbacksBackend.nextGraphModification(s.deleted,
[a,c]),!0):(console.log("ERROR unregistering quad"),!1)}else return console.log("ERROR normalizing quad"),!1};q.QueryEngine.prototype.checkGroupSemantics=function(a,b){if(a==="singleGroup")return!0;for(var c={},d=0;d<a.length;d++){var g=a[d];g.token==="var"?c[g.value]=!0:g.token==="aliased_expression"&&(c[g.alias.value]=!0)}for(d=0;d<b.length;d++)if(g=b[d],g.kind==="var"){if(c[g.value.value]==null)return!1}else if(g.kind==="aliased"&&g.expression&&g.expression.primaryexpression==="var"&&c[g.expression.value.value]==
null)return!1;return!0};q.QueryEngine.prototype.registerDefaultNamespace=function(a,b){this.defaultPrefixes[a]=b};var s={ANYTHING:{token:"var",value:"_"},added:"added",deleted:"deleted",eventsFlushed:"eventsFlushed",CallbacksBackend:function(a){this.aqt=new v.AbstractQueryTree;this.engine=a;this.indexMap={};this.observersMap={};this.queriesIndexMap={};this.emptyNotificationsMap={};this.queriesList=[];this.pendingQueries=[];this.matchedQueries=[];this.updateInProgress=null;this.indices=["SPOG","GP",
"OGS","POG","GSP","OS"];this.componentOrders={SPOG:["subject","predicate","object","graph"],GP:["graph","predicate","subject","object"],OGS:["object","graph","subject","predicate"],POG:["predicate","object","graph","subject"],GSP:["graph","subject","predicate","object"],OS:["object","subject","predicate","graph"]};this.callbackCounter=0;this.callbacksMap={};this.callbacksInverseMap={};this.queryCounter=0;this.queriesMap={};this.queriesCallbacksMap={};this.queriesInverseMap={};for(a=0;a<this.indices.length;a++){var b=
this.indices[a];this.indexMap[b]={};this.queriesIndexMap[b]={}}}};s.CallbacksBackend.prototype.startGraphModification=function(){this.pendingQueries=[].concat(this.queriesList);this.matchedQueries=[];if(this.updateInProgress==null)this.updateInProgress={added:[],deleted:[]}};s.CallbacksBackend.prototype.nextGraphModification=function(a,b){this.updateInProgress[a].push(b)};s.CallbacksBackend.prototype.endGraphModification=function(a){var b=this;if(this.updateInProgress!=null){var c=b.updateInProgress;
b.updateInProgress=null;this.sendNotification(s.deleted,c[s.deleted],function(){b.sendNotification(s.added,c[s.added],function(){b.sendEmptyNotification(s.eventsFlushed,null,function(){b.dispatchQueries(function(){a(!0)})})})})}else a(!0)};s.CallbacksBackend.prototype.cancelGraphModification=function(){this.updateInProgress=null};s.CallbacksBackend.prototype.sendNotification=function(a,b,c){for(var d={},g=0;g<b.length;g++){var h=b[g],f;for(f in this.indexMap){var i=this.indexMap[f],k=this.componentOrders[f];
this._searchCallbacksInIndex(i,k,a,h,d);this.pendingQueries.length!=0&&(i=this.queriesIndexMap[f],this._searchQueriesInIndex(i,k,h))}}this.dispatchNotifications(d);c!=null&&c(!0)};s.CallbacksBackend.prototype.sendEmptyNotification=function(a,b,c){for(var d=this.emptyNotificationsMap[a]||[],g=0;g<d.length;g++)d[g](a,b);c()};s.CallbacksBackend.prototype.dispatchNotifications=function(a){for(var b in a){var c=this.callbacksMap[b],d=a[b][s.deleted];if(d!=null)try{c(s.deleted,d)}catch(g){}for(var h in a[b])if(h!=
s.deleted)try{c(h,a[b][h])}catch(f){}}};s.CallbacksBackend.prototype._searchCallbacksInIndex=function(a,b,c,d,g){for(var h=d[1],d=d[0],f=0;f<b.length+1;f++){for(var i=a._||[],k=[],l=0;l<i.length;l++){var j=i[l];this.callbacksMap[j]!=null&&(g[j]=g[j]||{},g[j][c]=g[j][c]||[],g[j][c].push(d),k.push(j))}a._=k;i=b[f];if(a[""+h[i]]!=null)a=a[""+h[i]];else break}};s.CallbacksBackend.prototype.subscribeEmpty=function(a,b){var c=this.emptyNotificationsMap[a]||[];c.push(b);this.emptyNotificationsMap[a]=c};
s.CallbacksBackend.prototype.unsubscribeEmpty=function(a,b){var c=this.emptyNotificationsMap[a];c!=null&&(c=m.remove(c,b));this.emptyNotificationsMap[a]=c};s.CallbacksBackend.prototype.subscribe=function(a,b,c,d,g,h){a=this._tokenizeComponents(a,b,c,d);b={blanks:{},outCache:{}};this.engine.registerNsInEnvironment(null,b);a=this.engine.normalizeQuad(a,b,!0);c=this._indexForPattern(new C.Pattern(a));b=this.componentOrders[c];c=this.indexMap[c];for(d=0;d<b.length;d++){var f=a[b[d]];if(f==="_"){c._==
null&&(c._=[]);this.callbackCounter++;c._.push(this.callbackCounter);this.callbacksMap[this.callbackCounter]=g;this.callbacksInverseMap[g]=this.callbackCounter;break}else d===b.length-1?(c[f]=c[f]||{_:[]},this.callbackCounter++,c[f]._.push(this.callbackCounter),this.callbacksMap[this.callbackCounter]=g,this.callbacksInverseMap[g]=this.callbackCounter):(c[f]=c[f]||{},c=c[f])}h!=null&&h(!0)};s.CallbacksBackend.prototype.unsubscribe=function(a){var b=this.callbacksInverseMap[a];b!=null&&(delete this.callbacksInverseMap[a],
delete this.callbacksMap[b])};s.CallbacksBackend.prototype._tokenizeComponents=function(a,b,c,d){var g={};g.subject=a==null?s.ANYTHING:a.indexOf("_:")==0?{token:"blank",value:a}:{token:"uri",value:a};g.predicate=b==null?s.ANYTHING:{token:"uri",value:b};g.object=c==null?s.ANYTHING:{token:"uri",value:c};g.graph=d==null?s.ANYTHING:{token:"uri",value:d};return g};s.CallbacksBackend.prototype._indexForPattern=function(a){for(var a=a.indexKey,b=this.indices,c=0;c<b.length;c++)for(var d=b[c],g=this.componentOrders[d],
h=0;h<g.length;h++){if(m.include(a,g[h])===!1)break;if(h==a.length-1)return d}return"SPOG"};s.CallbacksBackend.prototype.observeNode=function(){var a,b,c,d;arguments.length===4?(a=arguments[0],b=arguments[1],c=arguments[2],d=arguments[3]):(a=arguments[0],b=this.engine.lexicon.defaultGraphUri,c=arguments[1],d=arguments[2]);b="CONSTRUCT { <"+a+"> ?p ?o } WHERE { GRAPH <"+b+"> { <"+a+"> ?p ?o } }";var g=this,h={blanks:{},outCache:{}};this.engine.registerNsInEnvironment(null,h);var f=[];this.engine.execute(b,
function(b,k){if(b){var l=!1,j=function(a,b){if(a==="eventsFlushed"&&l){l=!1;try{c(k)}catch(d){}}else if(a!=="eventsFlushed"){l=!0;for(var e=0;e<b.length;e++){var i=b[e],j=RDFJSInterface.buildRDFResource(i.subject,f,g.engine,h),m=RDFJSInterface.buildRDFResource(i.predicate,f,g.engine,h),i=RDFJSInterface.buildRDFResource(i.object,f,g.engine,h);j!=null&&m!=null&&i!=null&&(i=new RDFJSInterface.Triple(j,m,i),a===s.added?k.add(i):a===s.deleted&&k.remove(i))}}};g.observersMap[c]=j;g.subscribeEmpty(s.eventsFlushed,
j);g.subscribe(a,null,null,null,j,function(){try{c(k)}catch(a){}d&&d(!0)})}else d&&d(!1)})};s.CallbacksBackend.prototype.stopObservingNode=function(a){return(a=this.observersMap[a])?(this.unsubscribe(a),this.unsubscribeEmpty(s.eventsFlushed,a),!0):!1};s.CallbacksBackend.prototype.observeQuery=function(a,b,c,d){var g=this.aqt.collectBasicTriples(this.aqt.parseSelect(JSON.parse(JSON.stringify(b.units[0])))),h={blanks:{},outCache:{}};this.engine.registerNsInEnvironment(null,h);var f,i,k,l=this.queryCounter;
this.queryCounter++;this.queriesMap[l]=b;this.queriesInverseMap[a]=l;this.queriesList.push(l);this.queriesCallbacksMap[l]=c;for(a=0;a<g.length;a++){i=g[a];if(i.graph==null)i.graph=this.engine.lexicon.defaultGraphUriTerm;i=this.engine.normalizeQuad(i,h,!0);f=new C.Pattern(i);k=this._indexForPattern(f);f=this.componentOrders[k];k=this.queriesIndexMap[k];for(var j=0;j<f.length;j++){var m=i[f[j]];if(typeof m==="string"){k._==null&&(k._=[]);k._.push(l);break}else j===f.length-1?(k[m]=k[m]||{_:[]},k[m]._.push(l)):
(k[m]=k[m]||{},k=k[m])}}this.engine.execute(b,function(a,b){a?c(b):console.log("ERROR in query callback "+b)});d!=null&&d()};s.CallbacksBackend.prototype.addQueryToObserver=function(a,b){var c=this.aqt.collectBasicTriples(this.aqt.parseSelect(JSON.parse(JSON.stringify(b.units[0])))),d={blanks:{},outCache:{}};this.engine.registerNsInEnvironment(null,d);for(var g,h,f,i=this.queriesInverseMap[a],k=0;k<c.length;k++){h=c[k];if(h.graph==null)h.graph=this.engine.lexicon.defaultGraphUriTerm;h=this.engine.normalizeQuad(h,
d,!0);g=new C.Pattern(h);f=this._indexForPattern(g);g=this.componentOrders[f];f=this.queriesIndexMap[f];for(var l=0;l<g.length;l++){var j=h[g[l]];if(typeof j==="string"){f._==null&&(f._=[]);f._.push(i);break}else l===g.length-1?(f[j]=f[j]||{_:[]},f[j]._.push(i)):(f[j]=f[j]||{},f=f[j])}}};s.CallbacksBackend.prototype.stopObservingQuery=function(a){var b=this.queriesInverseMap[a];if(b!=null)delete this.queriesInverseMap[a],delete this.queriesMap[b],this.queriesList=m.remove(this.queriesList,b)};s.CallbacksBackend.prototype._searchQueriesInIndex=
function(a,b,c){for(var c=c[1],d=0;d<b.length+1;d++){for(var g=a._||[],h=[],f=0;f<g.length;f++){var i=g[f];m.include(this.pendingQueries,i)&&(m.remove(this.pendingQueries,i),this.matchedQueries.push(i));this.queriesMap[i]!=null&&h.push(i)}a._=h;g=b[d];if(a[""+c[g]]!=null)a=a[""+c[g]];else break}};s.CallbacksBackend.prototype.dispatchQueries=function(a){var b=this,c,d,g,h,f={};m.repeat(0,this.matchedQueries.length,function(a,k){c=arguments.callee;g=b.matchedQueries[k._i];f[g]==null?(f[g]=!0,d=b.queriesMap[g],
h=b.queriesCallbacksMap[g],m.recur(function(){b.engine.execute(d,function(b,d){if(b)try{h(d)}catch(e){}a(c,k)})})):a(c,k)},function(){a()})};var x={};try{typeof Worker=="undefined"&&(Worker=null)}catch(J){Worker=null}if(Worker)x.RDFStoreClient=function(a,b,c){console.log("trying to load "+a);this.connection=Worker.Worker?new Worker.Worker(a):new Worker(a);this.callbacksCounter=1;var d=this;this.rdf=RDFJSInterface.rdf;console.log("The worker");console.log(this.connection);d=this;this.connection.onmessage=
function(a){d.receive(a)};this.observingCallbacks={};this.callbacks={0:{cb:function(a,b){a===!0?c(!0,d):c(!1,b)},fn:"create"}};this.connection.postMessage({fn:"create",args:b,callback:"0"})},x.RDFStoreClient.prototype.receive=function(a){a=a.data||a;if(a.fn==="workerRequest:NetworkTransport:load"){var b=this,c=a.callback,a=a.arguments.concat(function(a,d){b.connection.postMessage({fn:"workerRequestResponse",results:[a,d],callback:c})});H.load.apply(H,a)}else{var d=this.callbacks[a.callback];d&&(d.fn===
"create"||d.fn==="execute"||d.fn==="insert"||d.fn=="graph"||d.fn==="node"||d.fn==="insert"||d.fn==="delete"||d.fn==="clear"||d.fn==="load"||d.fn==="startObservingQueryEndCb"||d.fn==="registeredGraphs"?(delete this.callbacks[a.callback],d.cb(a.success,a.result)):d.fn==="startObservingQuery"?d.cb(a.result):d.fn==="startObservingNode"?d.cb(a.result):d.fn==="subscribe"&&d.cb(a.event,a.result))}},x.RDFStoreClient.prototype.registerCallback=function(a,b){var c=""+this.callbacksCounter;this.callbacks[c]=
{fn:a,cb:b};this.callbacksCounter++;return c},x.RDFStoreClient.prototype.execute=function(){if(arguments.length===3)this.executeWithEnvironment(arguments[0],arguments[1],arguments[2]);else if(arguments.length===4)this.executeWithEnvironment(arguments[0],arguments[1],arguments[2],arguments[3]);else{var a,b;arguments.length===1?(a=arguments[0],b=function(){}):arguments.length===2&&(a=arguments[0],b=arguments[1]);b=this.registerCallback("execute",b);this.connection.postMessage({fn:"execute",args:[a],
callback:b})}},x.RDFStoreClient.prototype.insert=function(){var a,b,c;if(arguments.length===1)b=arguments[0],this.connection.postMessage({fn:"insert",args:[b]});else if(arguments.length===2)b=arguments[0],c=arguments[1]||function(){},c=this.registerCallback("insert",c),this.connection.postMessage({fn:"insert",args:[b],callback:c});else if(arguments.length===3)b=arguments[0],a=arguments[1],c=arguments[2]||function(){},c=this.registerCallback("insert",c),this.connection.postMessage({fn:"insert",args:[b,
a],callback:c});else throw"The triples to insert, an optional graph and callback must be provided";},x.RDFStoreClient.prototype.graph=function(){var a=null,b=null;if(arguments.length===1)b=arguments[0]||function(){};else if(arguments.length===2)b=arguments[1]||function(){},a=arguments[0];else throw"An optional graph URI and a callback function must be provided";var c=this,d=this.registerCallback("insert",function(a,d){if(a){for(var e,i=0;i<d.triples.length;i++)e=d.triples[i],d.triples[i]=new RDFJSInterface.Triple(c.adaptJSInterface(e.subject),
c.adaptJSInterface(e.predicate),c.adaptJSInterface(e.object));b(a,c.rdf.createGraph(d.triples))}else b(a,d)});a==null?this.connection.postMessage({fn:"graph",args:[],callback:d}):this.connection.postMessage({fn:"graph",args:[a],callback:d})},x.RDFStoreClient.prototype.node=function(){var a=null,b=null,c=null;if(arguments.length===2)c=arguments[0],b=arguments[1]||function(){};else if(arguments.length===3)c=arguments[0],a=arguments[1],b=arguments[2]||function(){};else throw"An optional graph URI and a callback function must be provided";
var d=this,g=this.registerCallback("insert",function(a,c){if(a){for(var g,k=0;k<c.triples.length;k++)g=c.triples[k],c.triples[k]=new RDFJSInterface.Triple(d.adaptJSInterface(g.subject),d.adaptJSInterface(g.predicate),d.adaptJSInterface(g.object));b(a,d.rdf.createGraph(c.triples))}else b(a,c)});a==null?this.connection.postMessage({fn:"node",args:[c],callback:g}):this.connection.postMessage({fn:"node",args:[c,a],callback:g})},x.RDFStoreClient.prototype.setPrefix=function(a,b){this.rdf.setPrefix(a,b);
this.connection.postMessage({fn:"rdf/setPrefix",args:[a,b],callback:null})},x.RDFStoreClient.prototype.setDefaultPrefix=function(a){this.rdf.setDefaultPrefix(a);this.connection.postMessage({fn:"rdf/setDefaultPrefix",args:[a],callback:null})},x.RDFStoreClient.prototype["delete"]=function(){var a,b,c;if(arguments.length===1)b=arguments[0],this.connection.postMessage({fn:"delete",args:[b]});else if(arguments.length===2)b=arguments[0],c=arguments[1]||function(){},c=this.registerCallback("delete",c),this.connection.postMessage({fn:"delete",
args:[b],callback:c});else if(arguments.length===3)b=arguments[0],a=arguments[1],c=arguments[2]||function(){},c=this.registerCallback("delete",c),this.connection.postMessage({fn:"delete",args:[b,a],callback:c});else throw"The triples to delete, an optional graph and callback must be provided";},x.RDFStoreClient.prototype.clear=function(){var a,b;if(arguments.length===1)b=arguments[0]||function(){},b=this.registerCallback("clear",b),this.connection.postMessage({fn:"clear",args:[],callback:b});else if(arguments.length===
2)a=arguments[0],b=arguments[1]||function(){},b=this.registerCallback("clear",b),this.connection.postMessage({fn:"clear",args:[a],callback:b});else throw"The optional graph and a callback must be provided";},x.RDFStoreClient.prototype.setBatchLoadEvents=function(a){this.connection.postMessage({fn:"setBatchLoadEvents",args:[a]})},x.RDFStoreClient.prototype.registerDefaultNamespace=function(a,b){this.connection.postMessage({fn:"registerDefaultNamespace",args:[a,b]})},x.RDFStoreClient.prototype.registerDefaultProfileNamespaces=
function(){this.connection.postMessage({fn:"registerDefaultProfileNamespaces",args:[]})},x.RDFStoreClient.prototype.load=function(){var a,b,c,d;if(arguments.length===3)a=arguments[0],b=arguments[1],d=arguments[2]||function(){},d=this.registerCallback("load",d),this.connection.postMessage({fn:"load",args:[a,b],callback:d});else if(arguments.length===4)a=arguments[0],b=arguments[1],c=arguments[2],d=arguments[3]||function(){},d=this.registerCallback("load",d),this.connection.postMessage({fn:"load",args:[a,
b,c],callback:d});else if(arguments.length===2)throw"The mediaType of the parser, the data a callback and an optional graph must be provided";},x.RDFStoreClient.prototype.startObservingQuery=function(a,b,c){c!=null?(b=this.registerCallback("startObservingQuery",b),this.observingCallbacks[a]=b,c=this.registerCallback("startObservingQueryEndCb",c),this.connection.postMessage({fn:"startObservingQuery",args:[a],callback:[b,c]})):(b=this.registerCallback("startObservingQuery",b),this.observingCallbacks[a]=
b,this.connection.postMessage({fn:"startObservingQuery",args:[a],callback:[b]}))},x.RDFStoreClient.prototype.stopObservingQuery=function(a){var b=this.observingCallbacks[a];delete this.observingCallbacks[a];delete this.callbacks[b];this.connection.postMessage({fn:"stopObservingQuery",args:[a],callback:[]})},x.RDFStoreClient.prototype.startObservingNode=function(){var a,b,c;if(arguments.length===2){a=arguments[0];c=arguments[1];var d=this,g=this.registerCallback("startObservingNode",function(a){for(var b,
g=0;g<a.triples.length;g++)b=a.triples[g],a.triples[g]=new RDFJSInterface.Triple(d.adaptJSInterface(b.subject),d.adaptJSInterface(b.predicate),d.adaptJSInterface(b.object));c(d.rdf.createGraph(a.triples))});this.observingCallbacks[c]=g;this.connection.postMessage({fn:"startObservingNode",args:[a],callback:g})}else arguments.length===3&&(a=arguments[0],b=arguments[1],c=arguments[2],d=this,g=this.registerCallback("startObservingNode",function(a){for(var b,g=0;g<a.triples.length;g++)b=a.triples[g],a.triples[g]=
new RDFJSInterface.Triple(d.adaptJSInterface(b.subject),d.adaptJSInterface(b.predicate),d.adaptJSInterface(b.object));c(d.rdf.createGraph(a.triples))}),this.observingCallbacks[c]=g,this.connection.postMessage({fn:"startObservingNode",args:[a,b],callback:g}))},x.RDFStoreClient.prototype.stopObservingNode=function(a){var b=this.observingCallbacks[a];delete this.observingCallbacks[a];delete this.callbacks[b];this.connection.postMessage({fn:"stopObservingNode",args:[b],callback:[]})},x.RDFStoreClient.prototype.subscribe=
function(a,b,c,d,g){var h=this,f=this.registerCallback("subscribe",function(a,b){for(var c,d=0;d<b.length;d++)c=b[d],b[d]=new RDFJSInterface.Triple(h.adaptJSInterface(c.subject),h.adaptJSInterface(c.predicate),h.adaptJSInterface(c.object));g(a,b)});this.observingCallbacks[g]=f;this.connection.postMessage({fn:"subscribe",args:[a,b,c,d],callback:f})},x.RDFStoreClient.prototype.unsubscribe=function(a){var b=this.observingCallbacks[a];delete this.observingCallbacks[a];delete this.callbacks[b];this.connection.postMessage({fn:"unsubscribe",
args:[b],callback:[]})},x.RDFStoreClient.prototype.registeredGraphs=function(a){var b=this;this.connection.postMessage({fn:"registeredGraphs",args:[],callback:this.registerCallback("registeredGraphs",function(c,d){if(c)for(var g=0;g<d.length;g++)d[g]=b.adaptJSInterface(d[g]);a(c,d)})})},x.RDFStoreClient.prototype.adaptJSInterface=function(a){if(a.interfaceName==="BlankNode")return new RDFJSInterface.BlankNode(a.bnodeId);else if(a.interfaceName==="Literal")return new RDFJSInterface.Literal(a.nominalValue,
a.language,a.datatype);else if(a.interfaceName==="NamedNode")return new RDFJSInterface.NamedNode(a.nominalValue)},x.RDFStoreClient.prototype.isWebWorkerConnection=!0;var n={};m.oldNormalizeUnicodeLiterals=m.normalizeUnicodeLiterals;m.normalizeUnicodeLiterals=function(a){return typeof a==="string"?m.oldNormalizeUnicodeLiterals(a):a};n.base_uri="http://rdfstore-js.org/micrographql/graph#";n.prefix="mql";n.counter=0;n.filterNames={$eq:!0,$lt:!0,$gt:!0,$neq:!0,$lteq:!0,$gteq:!0,$not:!0,$like:!0,$and:!0,
$or:!0};n.newContext=function(a){return{variables:[],isQuery:a,quads:[],varsMap:{},filtersMap:{},inverseMap:{}}};n.isFilter=function(a){if(typeof a!=="object"||a.constructor===Array)return!1;else for(var b in a)return n.filterNames[b]||!1};n.parseFilter=function(a,b,c){var d,g,h={token:"expression",expressionType:"atomic",primaryexpression:"var",value:b};if(typeof c==="object"&&c.constructor!==Date)for(var f in c){d=f;g=c[f];break}if(d==="$eq")return{token:"expression",expressionType:"relationalexpression",
operator:"=",op1:h,op2:n.parseFilter(a,b,g)};else if(d==="$lt")return{token:"expression",expressionType:"relationalexpression",operator:"<",op1:h,op2:n.parseFilter(a,b,g)};else if(d==="$gt")return{token:"expression",expressionType:"relationalexpression",operator:">",op1:h,op2:n.parseFilter(a,b,g)};else if(d==="$neq")return{token:"expression",expressionType:"relationalexpression",operator:"!=",op1:h,op2:n.parseFilter(a,b,g)};else if(d==="$lteq")return{token:"expression",expressionType:"relationalexpression",
operator:"<=",op1:h,op2:n.parseFilter(a,b,g)};else if(d==="$gteq")return{token:"expression",expressionType:"relationalexpression",operator:">=",op1:h,op2:n.parseFilter(a,b,g)};else if(d==="$not")return{token:"expression",expressionType:"unaryexpression",unaryexpression:"!",expression:n.parseFilter(a,b,g)};else if(d==="$like")return{token:"expression",expressionType:"regex",text:h,pattern:typeof g==="object"&&g.constructor===RegExp?n.parseFilter(a,b,g.source):n.parseFilter(a,b,g)};else if(d==="$and"){if(typeof g!==
"object"||g.constructor!==Array)g=[g];c=[];for(d=0;d<g.length;d++)c.push(n.parseFilter(a,b,g[d]));return{token:"expression",expressionType:"conditionaland",operands:c}}else if(d==="$or"){if(typeof g!=="object"||g.constructor!==Array)g=[g];c=[];for(d=0;d<g.length;d++)c.push(n.parseFilter(a,b,g[d]));return{token:"expression",expressionType:"conditionalor",operands:c}}else return typeof c==="object"&&c.$id!=null?{token:"expression",expressionType:"irireforfunction",iriref:n.parseURI(n.base_uri+c.$id)}:
(a=n.parseLiteral(c),a.type&&a.type==="http://www.w3.org/2001/XMLSchema#float"?{token:"expression",expressionType:"atomic",primaryexpression:"numericliteral",value:a}:a.type&&a.type==="http://www.w3.org/2001/XMLSchema#boolean"?{token:"expression",expressionType:"atomic",primaryexpression:"booleanliteral",value:a}:{token:"expression",expressionType:"atomic",primaryexpression:"rdfliteral",value:a})};n.nextVariable=function(){var a="id"+n.counter;n.counter++;return a};n.isUri=function(a){return a&&a.match(/[a-z]+:\//)};
n.parseURI=function(a){!n.isUri(a)&&a==null&&(a=n.base_uri+"object"+n.counter,n.counter++);return{token:"uri",value:a,suffix:null,prefix:null}};n.parseLiteral=function(a){if(typeof a==="string")return{token:"literal",value:a,lang:null,type:null};else if(typeof a==="boolean")return{token:"literal",value:""+a,type:"http://www.w3.org/2001/XMLSchema#boolean",lang:null};else if(typeof a==="number")return{token:"literal",value:""+a,type:"http://www.w3.org/2001/XMLSchema#float",lang:null};else if(typeof a===
"object"&&a.constructor===Date)return{token:"literal",value:m.iso8601(a),type:"http://www.w3.org/2001/XMLSchema#dateTime",lang:null};else throw"Error parsing object value: "+a;};n.parseJSON=function(a,b){var c=n.newContext(!1),d=n.parseBGP(a,c,!0,b);return c.quads.concat(d[1])};n.parseBGP=function(a,b,c,d){var g=null,h=[],f=n.nextVariable(),i=0;a.$id!=null||!b.isQuery?(a.$id==null?(g=n.parseURI(null),a.$id==null&&(a.$id="object"+(n.counter-1))):g=a.$id.token==="var"?a.$id:n.parseURI(n.base_uri+a.$id),
b.varsMap[f]=g.value):(g={token:"var",value:f},b.variables.push(g),b.varsMap[f]=f);if(c)b.topLevel=f;var k,l,j,m,o,q=!0,t;for(t in a)if(a[t]!=null&&t!=="$id")if(q=!1,t.indexOf("$in")==t.length-3&&t.indexOf("$in")!==-1)k=a[t],o=t.split("$in")[0],typeof a[t]==="string"&&(k={$id:a[t]}),a[t]=k,g.token==="uri"?l=j=a.$id:(j=g,l=j.value),k[o]={$id:j},j=n.parseBGP(k,b,!1,d),m=b.inverseMap[l]||{},b.inverseMap[l]=m,k=m[o]||[],m[o]=k,j[0].token==="uri"?k.push(j[0].value.split(n.base_uri)[1]):k.push(j[0].value),
b.quads=b.quads.concat(j[1]);else if(k=t,t==="$type"&&(k="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),k=n.parseURI(k),n.isFilter(a[t]))j=f+"f"+i,i++,o={token:"var",value:j},l=n.parseFilter(k,o,a[t]),b.varsMap[j]=f,b.filtersMap[j]=l,j={subject:g,predicate:k,object:o},d!=null&&(j.graph=d),h.push(j);else if(typeof a[t]==="object"&&a[t].token==="var")l=a[t],b.varsMap[a]==null&&(b.varsMap[a]=!0,b.variables.push(l)),j={subject:g,predicate:k,object:l},d!=null&&(j.graph=d),h.push(j);else if(typeof a[t]===
"string"||typeof a[t]==="object"&&a[t].constructor===Date||typeof a[t]==="number"||typeof a[t]==="boolean")l=n.parseLiteral(a[t]),j={subject:g,predicate:k,object:l},d!=null&&(j.graph=d),h.push(j);else if(a[t].constructor==Array)for(o=0;o<a[t].length;o++)j=n.parseBGP(a[t][o],b,!1,d),l=j[0],b.quads=b.quads.concat(j[1]),j={subject:g,predicate:k,object:l},d!=null&&(j.graph=d),h.push(j);else a[t].token==="var"?j={subject:g,predicate:k,object:a[t]}:(j=n.parseBGP(a[t],b,!1,d),l=j[0],b.quads=b.quads.concat(j[1]),
j={subject:g,predicate:k,object:l}),d!=null&&(j.graph=d),h.push(j);q&&c&&(j={subject:g,predicate:{token:"var",value:f+"p"},object:{token:"var",value:f+"o"}},h.push(j));return[g,h]};n.singleNodeQuery=function(a,b,c){return{units:[{modifier:"",group:"",pattern:{filters:[],token:"groupgraphpattern",patterns:[{triplesContext:[{subject:{token:"uri",value:a},predicate:{token:"var",value:b},object:{token:"var",value:c}}],token:"basicgraphpattern"}]},kind:"select",projection:[{value:{value:b,token:"var"},
kind:"var",token:"variable"},{value:{value:c,token:"var"},kind:"var",token:"variable"}],dataset:{implicit:[{value:"https://github.com/antoniogarrote/rdfstore-js#default_graph",prefix:null,token:"uri",suffix:null}],named:[]},token:"executableunit"}],prologue:{token:"prologue",prefixes:[],base:""},kind:"query",token:"query"}};n.literalToJS=function(a){return a=a.type==="http://www.w3.org/2001/XMLSchema#float"?parseFloat(a.value):a.type==="http://www.w3.org/2001/XMLSchema#boolean"?a.value==="true"?!0:
!1:a.type==="http://www.w3.org/2001/XMLSchema#dateTime"?m.parseISO8601(a.value):a.value};var z=function(a){this.template=a;this.filter=null};z.prototype.setKind=function(a){this.kind=a;return this};z.prototype.setStore=function(a){this.store=a;return this};z.prototype.setCallback=function(a){this.callback=a;return this};z.prototype.each=function(a){this.filter=a;return this};z.prototype.onError=function(a){this.onErrorCallback=a;return this};z.prototype.limit=function(a){this.limitValue=a;return this};
z.prototype.offset=function(a){this.offsetValue=a;return this};z.prototype.order=function(a){this.sortValue=a;return this};z.prototype.all=function(a){this.kind="all";this._executeQuery(a);return this.store};z.prototype.first=function(a){this.all(function(b){b.length>0?a(b[0]):a(null)});return this.store};z.prototype.remove=function(a){this.kind="remove";this.store.startGraphModification();this._executeUpdate(a);this.store.endGraphModification();return this.store};z.prototype.removeNodes=function(a){this.kind=
"removeNodes";this.store.startGraphModification();this._parseModifyNodes(this.template,a);this.store.endGraphModification();return this.store};z.prototype.bind=function(a){this.store.bind(this._parseQuery(this.template),a);return this.store};z.prototype._executeUpdate=function(a){var b;b=this._parseModify(this.template);this.query=b.query;this.varsMap=b.varsMap;this.topLevel=b.topLevel;this.subject=b.subject;this.inverseMap=b.inverseMap;this.store.execute(this.query,function(b){a&&a(b)})};z.prototype._executeQuery=
function(a){var b=this._parseQuery(this.template);this.query=b.query;this.varsMap=b.varsMap;this.topLevel=b.topLevel;this.subject=b.subject;this.inverseMap=b.inverseMap;var b=this.query.units[0].pattern.patterns[0].triplesContext,c=this.query.units[0],d=[];if(this.sortValue)for(var g=0,h=n.nextVariable(),f=0;f<this.sortValue.length;f++){var i;if(typeof this.sortValue[f]==="object")for(var k in sortValue[f]){i=k;break}else i=this.sortValue[f];var l;i==="$type"&&(l="http://www.w3.org/1999/02/22-rdf-syntax-ns#type");
l=n.parseURI(i);var j=h+"s"+g;g++;j={token:"var",value:j};b.push({subject:this.subject,predicate:l,object:j});d.push({direction:"ASC",expression:{token:"expression",expressionType:"atomic",primaryexpression:"var",value:j}})}if(this.limitValue!=null)c.limit=this.limitValue;if(this.offsetValue!=null)c.offset=this.offsetValue;if(d.length>0)c.order=d;if(a!=null)this.callback=a;var q=this,o=[];this.kind==="all"&&this.store.execute(this.query,function(b,c){n.isUri(q.varsMap[q.topLevel])&&c.length>0&&(c[0][q.topLevel]=
q.varsMap[q.topLevel]);if(b)if(o=z._processQueryResults(c,q.topLevel,q.varsMap,q.inverseMap,q.store),q.filter!=null){var d=[],f;m.repeat(0,o.length,function(a,b){var c=arguments.callee,e=o[b._i];f=q.filter(e)||e;d!==!1&&d.push(f);a(c,b)},function(){a(d)})}else a(o);else if(q.onErrorCallback)q.onError(c);else q.callback(null)})};z.prototype._parseQuery=function(a){var b=n.newContext(!0),c=n.parseBGP(a,b,!0),a=c[0],d=[{token:"filter",value:{token:"expression",expressionType:"conditionaland",operands:[]}}],
g;for(g in b.filtersMap)d[0].value.operands.push(b.filtersMap[g]);g={kind:"select",modifier:"",group:"",token:"executableunit",pattern:{filters:[],token:"groupgraphpattern",patterns:[{token:"basicgraphpattern",triplesContext:b.quads.concat(c[1])}]}};if(d[0].value.operands.length>0)g.pattern.filters=d;d=[];for(c=0;c<b.variables.length;c++)d.push({kind:"var",token:"variable",value:b.variables[c]});g.projection=d;g.dataset={named:[],implicit:[{suffix:null,prefix:null,token:"uri",value:"https://github.com/antoniogarrote/rdfstore-js#default_graph"}]};
return{query:{prologue:{base:"",prefixes:[],token:"prologue"},kind:"query",token:"query",units:[g]},varsMap:b.varsMap,topLevel:b.topLevel,subject:a,inverseMap:b.inverseMap}};z.prototype._parseModify=function(a){var b=n.newContext(!0),c=n.parseBGP(a,b,!0),a=c[0],d=[{token:"filter",value:{token:"expression",expressionType:"conditionaland",operands:[]}}],g;for(g in b.filtersMap)d[0].value.operands.push(b.filtersMap[g]);g=b.quads.concat(c[1]);g={kind:"modify","with":null,using:null,pattern:{filters:[],
token:"groupgraphpattern",patterns:[{token:"basicgraphpattern",triplesContext:g}]},"delete":g};if(d[0].value.operands.length>0)g.pattern.filters=d;d=[];for(c=0;c<b.variables.length;c++)d.push({kind:"var",token:"variable",value:b.variables[c]});return{query:{prologue:{base:"",prefixes:[],token:"prologue"},kind:"update",token:"query",units:[g]},varsMap:b.varsMap,topLevel:b.topLevel,subject:a,inverseMap:b.inverseMap}};z.prototype._parseModifyNodes=function(a,b){this.kind="all";var c=this,d=0;this._executeQuery(function(a){n.nextVariable();
for(var b=0;b<a.length;b++)c.template={$id:a[b].$id},c.kind="removeNode",c._executeUpdate(function(a){a===!0&&d++;c._unlinkNode(c.template.$id)})});b&&b(d)};z.prototype._unlinkNode=function(a,b){b==null&&(b=function(){});var c={token:"uri",value:n.base_uri+a},d=n.nextVariable(),g=this,h=g._modifyQuery([{subject:c,predicate:{token:"var",value:d+"pout"},object:{token:"var",value:d+"oout"}}]);g.store.execute(h.query,function(){h=g._modifyQuery([{subject:{token:"var",value:d+"sin"},predicate:{token:"var",
value:d+"pin"},object:c}]);g.store.execute(h.query,b)})};z.prototype._modifyQuery=function(a){return{query:{prologue:{base:"",prefixes:[],token:"prologue"},kind:"update",token:"query",units:[{kind:"modify","with":null,using:null,pattern:{filters:[],token:"groupgraphpattern",patterns:[{token:"basicgraphpattern",triplesContext:a}]},"delete":a}]}}};z._processQueryResults=function(a,b,c,d,g){for(var h={},f={},i={},k={},l={},j,m,o,q=0,s=[],r=0;r<a.length;r++){j=a[r];for(var v in j){m=!1;var w=c[v];if(w==
v)w=a[r][v].value;v===b&&(m=!0);var x=w.split(n.base_uri)[1];if(f[x]==null){var u=k[x],u=u||{$id:x};k[x]=u;C=i[x]||{};i[x]=C;var z=d[x]||d[v];if(z)for(var A in z)if(z[A].length===1){var y=a[r][c[z[A][0]]],y=y!=null?y.value.split(n.base_uri)[1]:z[A][0],B=k[y]||{$id:y},C=i[y]||{};i[y]=C;C[A]=!0;delete B[A];k[y]=B;u[A+"$in"]=B}else{u[A+"$in"]=[];for(r=0;r<z[A].length;r++)B=k[y]||{$id:y},C=i[y]||{},i[y]=C,C[A]=!0,delete B[A],y=c[z[A][0]]||z[A][0],B=k[y]||{$id:y},k[y].push(B)}n.isUri(w)&&g.execute(n.singleNodeQuery(w,
"p","o"),function(a,b){f[x]=!0;q++;o=l[x]||{};l[x]=o;for(var c=null,d=0;d<b.length;d++){c=b[d].o;if(c.token==="uri"){var c=c.value.split(n.base_uri)[1],e=k[c]||{};e.$id=c;c=k[c]=e}else c=n.literalToJS(c);e=b[d].p.value;e==="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"&&(e="$type");C[e]||(u[e]&&u[e].constructor===Array?typeof c==="object"&&c.$id&&o[e][c.$id]==null?(o[e][c.$id]=!0,u[e].push(c)):typeof c!=="object"&&c.constructor===Date&&o[e]["date:"+c.getTime()]==null?(o[e]["date:"+c.getTime()]=
!0,u[e].push(c)):o[e][c]==null&&(o[e][c]=!0,u[e].push(c)):u[e]?typeof u[e]==="object"&&u[e].$id!=null?typeof c==="object"&&c.$id!=null?u[e].$id!=c.$id&&(u[e]=[u[e],c],o[e]={},o[e][u[e][0].$id]=!0,o[e][u[e][1].$id]=!0):(o[e]={},o[e][u[e].$id]=!0,typeof c==="object"?o[e]["date:"+c.getTime()]=!0:o[e][c]=!0,u[e]=[u[e],c]):typeof u[e]==="object"?typeof c==="object"&&c.$id==null?u[e].getTime()!==c.getTime()&&(u[e]=[u[e],c],o[e]={},o[e]["date:"+u[e][0].getTime()]=!0,o[e]["date:"+u[e][1].getTime()]=!0):(o[e]=
{},o[e]["date:"+u[e].getTime()]=!0,typeof c==="object"?o[e][c.$id]=!0:o[e][c]=!0,u[e]=[u[e],c]):typeof c!=="object"?c!=u[e]&&(o[e]={},o[e][c]=!0,o[e][u[e]]=!0,u[e]=[u[e],c]):(o[e]={},o[e][u[e]]=!0,c.$id==null?o[e][c.$id]=!0:o[e]["date:"+c.getTime()]=!0,u[e]=[u[e],c]):u[e]=c)}m&&h[u.$id]==null&&(s.push(u),h[u.$id]=!0)})}}}return s};var B=function(a,b){a.treeOrder==null&&(a.treeOrder=15);var c=this;this.callbackToInner={};this.callbackMap={};this.callbackCounter=0;this.callbackToNodes={};this.nodesToCallbacks=
{};for(var d=0;d<B.vars.length;d++)this["_"+B.vars[d]]=this._(B.vars[d]);this.callbacksMap={};new y.Lexicon(function(d){a.overwrite===!0&&d.clear();new E.QuadBackend(a,function(e){a.overwrite===!0&&e.clear();a.backend=e;a.lexicon=d;c.engine=new q.QueryEngine(a);c.engine.eventsOnBatchLoad=!0;c.engine.abstractQueryTree.oldParseQueryString=c.engine.abstractQueryTree.parseQueryString;c.engine.abstractQueryTree.parseQueryString=function(a){return typeof a==="string"?this.oldParseQueryString(a):a};b&&b(c)})},
a.name)};B.VERSION="0.2.0";B.vars=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];B.create=function(){var a,b;if(arguments.length==0)throw"A callback function and an optional options map must be provided";else arguments.length==1?(b={treeOrder:15,name:"micrograph_instance",overwrite:!1},a=arguments[0]):(b=arguments[0],a=arguments[1]);new B(b,a)};B.prototype.execute=function(a,b){this.engine.execute(a,b)};B.prototype.startGraphModification=
function(){this.engine.startGraphModification()};B.prototype.endGraphModification=function(){this.engine.endGraphModification()};B.prototype.where=function(a){a=new z(a);a.setStore(this);return a};B.prototype._=function(a){return{token:"var",value:a}};B.prototype.load=function(){var a,b,c,d,g=this;arguments.length==1&&(d=function(){});if(arguments.length<3)a=n.isUri(typeof arguments[0]==="string"&&arguments[0])?"remote":"application/json",c={token:"uri",value:this.engine.lexicon.defaultGraphUri},
b=arguments[0],d=arguments[1];else throw"Data to be loaded and an optional callback function must be specified";if(typeof b==="object"){b.constructor!==Array&&(b=[b]);for(var g=this,h=0;h<b.length;h++)a=n.parseJSON(b[h],c),g.engine.startGraphModification(),g.engine.batchLoad(a,function(){g.engine.endGraphModification()});d&&d(b)}else a=this.engine.rdfLoader.parsers[a],g=this,this.engine.rdfLoader.tryToParse(a,{token:"uri",value:c.valueOf()},b,function(a,b){a?g.engine.batchLoad(b,d):d(a,b)});return this};
B.prototype.save=function(a,b){this.load(a,function(a){b&&b(a[0])});return this};B.prototype.update=function(a,b){var c=a.$id;if(c==null)b(!1,"ID must be provided");else{var d=this;d.engine.startGraphModification();this.where({$id:c})._unlinkNode(c,function(c){c?d.save(a,b):b(!1)});d.engine.endGraphModification()}};B.prototype.bind=function(a,b){var c="cb"+this.callbackCounter;this.callbackCounter++;var d=this,g={},h=function(f){for(var f=z._processQueryResults(f,a.topLevel,a.varsMap,a.inverseMap,
d),h=0;h<f.length;h++){var k=f[h].$id;g[k]==null&&(d.engine.callbacksBackend.addQueryToObserver(c,n.singleNodeQuery(n.base_uri+k,"p","o")),g[k]=!0)}b(f)};this.callbackToInner[b]=h;this.callbackMap[c]=h;this.engine.callbacksBackend.observeQuery(c,a.query,h,function(){})};try{typeof window==="undefined"?exports.create=B.create:window.mg=B}catch(K){}})();
